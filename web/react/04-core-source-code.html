<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React-- Core source code | ğŸ‚</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="ä¸–äº‹å¦‚è½èŠ± å¿ƒå¢ƒè‡ªç©ºæ˜">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="keywords" content="ä¸ªäººä¸»é¡µï¼Œåšå®¢ï¼Œarisemarcher">
    
    <link rel="preload" href="/blog/assets/css/0.styles.5dc243e2.css" as="style"><link rel="preload" href="/blog/assets/js/app.ee0bd224.js" as="script"><link rel="preload" href="/blog/assets/js/3.84323a08.js" as="script"><link rel="preload" href="/blog/assets/js/1.86f9a9c9.js" as="script"><link rel="preload" href="/blog/assets/js/50.35661192.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.788c7145.js"><link rel="prefetch" href="/blog/assets/js/11.16821e32.js"><link rel="prefetch" href="/blog/assets/js/12.379fae01.js"><link rel="prefetch" href="/blog/assets/js/13.5e5ec9e6.js"><link rel="prefetch" href="/blog/assets/js/14.cdeb4db2.js"><link rel="prefetch" href="/blog/assets/js/15.b23b3f8f.js"><link rel="prefetch" href="/blog/assets/js/16.e21e5dfa.js"><link rel="prefetch" href="/blog/assets/js/17.a376ac91.js"><link rel="prefetch" href="/blog/assets/js/18.46d35381.js"><link rel="prefetch" href="/blog/assets/js/19.df3a622e.js"><link rel="prefetch" href="/blog/assets/js/20.94fa6dff.js"><link rel="prefetch" href="/blog/assets/js/21.933b75ba.js"><link rel="prefetch" href="/blog/assets/js/22.364f0b82.js"><link rel="prefetch" href="/blog/assets/js/23.97b829d9.js"><link rel="prefetch" href="/blog/assets/js/24.1d17ac99.js"><link rel="prefetch" href="/blog/assets/js/25.b6fc28bd.js"><link rel="prefetch" href="/blog/assets/js/26.cb0811ab.js"><link rel="prefetch" href="/blog/assets/js/27.37e81b2d.js"><link rel="prefetch" href="/blog/assets/js/28.b71ea33e.js"><link rel="prefetch" href="/blog/assets/js/29.3196463e.js"><link rel="prefetch" href="/blog/assets/js/30.55adecd4.js"><link rel="prefetch" href="/blog/assets/js/31.103d7012.js"><link rel="prefetch" href="/blog/assets/js/32.67e9bb3c.js"><link rel="prefetch" href="/blog/assets/js/33.cad8b97f.js"><link rel="prefetch" href="/blog/assets/js/34.4e4581bb.js"><link rel="prefetch" href="/blog/assets/js/35.36533851.js"><link rel="prefetch" href="/blog/assets/js/36.5a98a0ad.js"><link rel="prefetch" href="/blog/assets/js/37.548035a5.js"><link rel="prefetch" href="/blog/assets/js/38.a37d2616.js"><link rel="prefetch" href="/blog/assets/js/39.bf32a509.js"><link rel="prefetch" href="/blog/assets/js/4.34e3d354.js"><link rel="prefetch" href="/blog/assets/js/40.56d10cea.js"><link rel="prefetch" href="/blog/assets/js/41.f5305105.js"><link rel="prefetch" href="/blog/assets/js/42.b4c516e3.js"><link rel="prefetch" href="/blog/assets/js/43.1f1cf7a0.js"><link rel="prefetch" href="/blog/assets/js/44.f77af4a4.js"><link rel="prefetch" href="/blog/assets/js/45.089be5b9.js"><link rel="prefetch" href="/blog/assets/js/46.db6c9a19.js"><link rel="prefetch" href="/blog/assets/js/47.fdf75a5a.js"><link rel="prefetch" href="/blog/assets/js/48.884a21e6.js"><link rel="prefetch" href="/blog/assets/js/49.dc1c2bf0.js"><link rel="prefetch" href="/blog/assets/js/5.715a6a0f.js"><link rel="prefetch" href="/blog/assets/js/51.91443097.js"><link rel="prefetch" href="/blog/assets/js/52.4503b49f.js"><link rel="prefetch" href="/blog/assets/js/53.56aef2d5.js"><link rel="prefetch" href="/blog/assets/js/54.6da69401.js"><link rel="prefetch" href="/blog/assets/js/55.41dc3150.js"><link rel="prefetch" href="/blog/assets/js/56.3405598d.js"><link rel="prefetch" href="/blog/assets/js/57.5018042d.js"><link rel="prefetch" href="/blog/assets/js/58.674e1a30.js"><link rel="prefetch" href="/blog/assets/js/59.2fb01d0d.js"><link rel="prefetch" href="/blog/assets/js/6.6c791008.js"><link rel="prefetch" href="/blog/assets/js/60.221ef0f7.js"><link rel="prefetch" href="/blog/assets/js/61.7fcd9c39.js"><link rel="prefetch" href="/blog/assets/js/62.afc99a19.js"><link rel="prefetch" href="/blog/assets/js/63.eb6aa863.js"><link rel="prefetch" href="/blog/assets/js/64.37692b2a.js"><link rel="prefetch" href="/blog/assets/js/65.f3414bea.js"><link rel="prefetch" href="/blog/assets/js/7.4ba5853a.js"><link rel="prefetch" href="/blog/assets/js/8.dc3d51f7.js"><link rel="prefetch" href="/blog/assets/js/9.d06a52bd.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.5dc243e2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-11f94078><div data-v-11f94078><div class="password-shadow password-wrapper-out" style="display:none;" data-v-08f61db9 data-v-11f94078 data-v-11f94078><h3 class="title" data-v-08f61db9>ğŸ‚</h3> <p class="description" data-v-08f61db9>ä¸–äº‹å¦‚è½èŠ± å¿ƒå¢ƒè‡ªç©ºæ˜</p> <label id="box" class="inputBox" data-v-08f61db9><input type="password" value="" data-v-08f61db9> <span data-v-08f61db9>Konck! Knock!</span> <button data-v-08f61db9>OK</button></label> <div class="footer" data-v-08f61db9><span data-v-08f61db9><i class="iconfont reco-theme" data-v-08f61db9></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-08f61db9>vuePress-theme-reco</a></span> <span data-v-08f61db9><i class="iconfont reco-copyright" data-v-08f61db9></i> <a data-v-08f61db9><span data-v-08f61db9>arisemarcher</span>
        Â Â 
        <!---->
        2022
      </a></span></div></div> <div class="hide" data-v-11f94078><header class="navbar" data-v-11f94078><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">ğŸ‚</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link"><i class="iconfont reco-home"></i>
  é¦–é¡µ
</a></div><div class="nav-item"><a href="/blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  æ—¶é—´çº¿
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      åˆ†ç±»
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/dart/" class="nav-link"><i class="undefined"></i>
  dart
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/flutter/" class="nav-link"><i class="undefined"></i>
  flutter
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/uniapp/" class="nav-link"><i class="undefined"></i>
  uniapp
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/InstallationTutorial/" class="nav-link"><i class="undefined"></i>
  InstallationTutorial
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/vuepress/" class="nav-link"><i class="undefined"></i>
  vuepress
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/vue/" class="nav-link"><i class="undefined"></i>
  vue
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/gulp/" class="nav-link"><i class="undefined"></i>
  gulp
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/nuxtJs/" class="nav-link"><i class="undefined"></i>
  nuxtJs
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/react/" class="nav-link"><i class="undefined"></i>
  react
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/vite/" class="nav-link"><i class="undefined"></i>
  vite
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/vue3.0/" class="nav-link"><i class="undefined"></i>
  vue3.0
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/weixin/" class="nav-link"><i class="undefined"></i>
  weixin
</a></li></ul></div></div><div class="nav-item"><a href="/blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  æ ‡ç­¾
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-11f94078></div> <aside class="sidebar" data-v-11f94078><div class="personal-info-wrapper" data-v-3d87d2e4 data-v-11f94078><img src="/blog/avatar.png" alt="author-avatar" class="personal-img" data-v-3d87d2e4> <h3 class="name" data-v-3d87d2e4>
    arisemarcher
  </h3> <div class="num" data-v-3d87d2e4><div data-v-3d87d2e4><h3 data-v-3d87d2e4>53</h3> <h6 data-v-3d87d2e4>Articles</h6></div> <div data-v-3d87d2e4><h3 data-v-3d87d2e4>12</h3> <h6 data-v-3d87d2e4>Tags</h6></div></div> <ul class="social-links" data-v-3d87d2e4></ul> <hr data-v-3d87d2e4></div> <nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link"><i class="iconfont reco-home"></i>
  é¦–é¡µ
</a></div><div class="nav-item"><a href="/blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  æ—¶é—´çº¿
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      åˆ†ç±»
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/dart/" class="nav-link"><i class="undefined"></i>
  dart
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/flutter/" class="nav-link"><i class="undefined"></i>
  flutter
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/uniapp/" class="nav-link"><i class="undefined"></i>
  uniapp
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/InstallationTutorial/" class="nav-link"><i class="undefined"></i>
  InstallationTutorial
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/vuepress/" class="nav-link"><i class="undefined"></i>
  vuepress
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/vue/" class="nav-link"><i class="undefined"></i>
  vue
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/gulp/" class="nav-link"><i class="undefined"></i>
  gulp
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/nuxtJs/" class="nav-link"><i class="undefined"></i>
  nuxtJs
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/react/" class="nav-link"><i class="undefined"></i>
  react
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/vite/" class="nav-link"><i class="undefined"></i>
  vite
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/vue3.0/" class="nav-link"><i class="undefined"></i>
  vue3.0
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/weixin/" class="nav-link"><i class="undefined"></i>
  weixin
</a></li></ul></div></div><div class="nav-item"><a href="/blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  æ ‡ç­¾
</a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>gulp</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>nuxtJs</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>react</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web/react/01-base.html" class="sidebar-link">React--åŸºç¡€</a></li><li><a href="/blog/web/react/02-virtual-dom.html" class="sidebar-link">React-- Virtual DOM</a></li><li><a href="/blog/web/react/03-fiber.html" class="sidebar-link">React-- Fiber</a></li><li><a href="/blog/web/react/04-core-source-code.html" aria-current="page" class="active sidebar-link">React-- Core source code</a></li><li><a href="/blog/web/react/05-redux.html" class="sidebar-link">React-- Redux</a></li><li><a href="/blog/web/react/06-redux-simulation.html" class="sidebar-link">React-- Redux simulation</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vite</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue2.0</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>weixin</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-08f61db9 data-v-11f94078><h3 class="title" data-v-08f61db9>React-- Core source code</h3> <!----> <label id="box" class="inputBox" data-v-08f61db9><input type="password" value="" data-v-08f61db9> <span data-v-08f61db9>Konck! Knock!</span> <button data-v-08f61db9>OK</button></label> <div class="footer" data-v-08f61db9><span data-v-08f61db9><i class="iconfont reco-theme" data-v-08f61db9></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-08f61db9>vuePress-theme-reco</a></span> <span data-v-08f61db9><i class="iconfont reco-copyright" data-v-08f61db9></i> <a data-v-08f61db9><span data-v-08f61db9>arisemarcher</span>
        Â Â 
        <!---->
        2022
      </a></span></div></div> <div data-v-11f94078><div data-v-11f94078><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">React-- Core source code</h1> <div data-v-162cc157><i class="iconfont reco-account" data-v-162cc157><span data-v-162cc157>arisemarcher</span></i> <i class="iconfont reco-date" data-v-162cc157><span data-v-162cc157>10/11/2022</span></i> <!----> <i class="tags iconfont reco-tag" data-v-162cc157><span class="tag-item" data-v-162cc157>react</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="_1-é…ç½®-react-æºç æœ¬åœ°è°ƒè¯•ç¯å¢ƒ"><a href="#_1-é…ç½®-react-æºç æœ¬åœ°è°ƒè¯•ç¯å¢ƒ" class="header-anchor">#</a> 1. é…ç½® React æºç æœ¬åœ°è°ƒè¯•ç¯å¢ƒ</h2> <p><a href="https://github.com/AriseMarcher/advanced-to-react/tree/master/code/react-test" target="_blank" rel="noopener noreferrer">å¿«æ·é€šé“<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ol><li>ä½¿ç”¨ create-react-app è„šæ‰‹æ¶åˆ›å»ºé¡¹ç›®</li></ol> <div class="language-sh extra-class"><pre class="language-sh"><code>npx create-react-app react-test
<span class="token comment"># å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„react æ–¹ä¾¿è°ƒè¯•</span>
<span class="token function">npm</span> <span class="token function">install</span> react@16.13.1 react-dom@16.13.1
</code></pre></div><ol start="2"><li>å¼¹å°„ create-react-app è„šæ‰‹æ¶å†…éƒ¨é…ç½®</li></ol> <p>å¦‚æœæœ‰gitä»“åº“çš„è¯éœ€è¦å…ˆæäº¤ä»£ç </p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> react-test
<span class="token function">npm</span> run <span class="token function">eject</span>
</code></pre></div><ol start="3"><li><p>å…‹éš† react å®˜æ–¹æºç  (åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹è¿›è¡Œå…‹éš† react-testä¸‹)</p> <p><code>git clone --branch v16.13.1 --depth=1 https://github.com/facebook/react.git src/react</code></p></li> <li><p>é“¾æ¥æœ¬åœ°æºç </p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// æ–‡ä»¶ä½ç½®: react-test/config/webpack.config.js</span>
<span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">alias</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;react-native&quot;</span><span class="token operator">:</span> <span class="token string">&quot;react-native-web&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;react&quot;</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../src/react/packages/react&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;react-dom&quot;</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../src/react/packages/react-dom&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;shared&quot;</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../src/react/packages/shared&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;react-reconciler&quot;</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../src/react/packages/react-reconciler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;legacy-events&quot;</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../src/react/packages/legacy-events&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>ä¿®æ”¹ç¯å¢ƒå˜é‡</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// æ–‡ä»¶ä½ç½®: react-test/config/env.js</span>
<span class="token keyword">const</span> stringified <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token string-property property">&quot;process.env&quot;</span><span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">env<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   	env<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>raw<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> env
   <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token literal-property property">__DEV__</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
   <span class="token literal-property property">SharedArrayBuffer</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
   <span class="token literal-property property">spyOnDev</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
   <span class="token literal-property property">spyOnDevAndProd</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
   <span class="token literal-property property">spyOnProd</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
   <span class="token literal-property property">__PROFILE__</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
   <span class="token literal-property property">__UMD__</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
   <span class="token literal-property property">__EXPERIMENTAL__</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
   <span class="token literal-property property">__VARIANT__</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
   <span class="token literal-property property">gate</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
   <span class="token literal-property property">trustedTypes</span><span class="token operator">:</span> <span class="token boolean">true</span>
 <span class="token punctuation">}</span>
</code></pre></div></li> <li><p>å‘Šè¯‰ babel åœ¨è½¬æ¢ä»£ç æ—¶å¿½ç•¥ç±»å‹æ£€æŸ¥</p> <p><code>npm install @babel/plugin-transform-flow-strip-types -D</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// æ–‡ä»¶ä½ç½®: react-test/config/webpack.config.js [babel-loader]</span>
<span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
  require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/plugin-transform-flow-strip-types&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre></div></li> <li><p>å¯¼å‡º HostConfig</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// æ–‡ä»¶ä½ç½®: /react/packages/react-reconciler/src/ReactFiberHostConfig.js</span>
<span class="token operator">+</span> <span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./forks/ReactFiberHostConfig.dom'</span><span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token function">invariant</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">'This module must be shimmed by a specific renderer.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>ä¿®æ”¹ ReactSharedInternals.js æ–‡ä»¶</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// æ–‡ä»¶ä½ç½®: /react/packages/shared/ReactSharedInternals.js</span>
<span class="token operator">-</span> <span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token keyword">const</span> ReactSharedInternals <span class="token operator">=</span> React<span class="token punctuation">.</span>__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED<span class="token punctuation">;</span>
<span class="token operator">+</span> <span class="token keyword">import</span> ReactSharedInternals <span class="token keyword">from</span> <span class="token string">'../react/src/ReactSharedInternals'</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>å…³é—­ eslint æ‰©å±•</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// æ–‡ä»¶ä½ç½®: react/.eslingrc.js [module.exports]</span>
<span class="token comment">// åˆ é™¤ extends</span>
<span class="token keyword">extends</span><span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token string">'fbjs'</span><span class="token punctuation">,</span>
  <span class="token string">'prettier'</span>
<span class="token punctuation">]</span>

</code></pre></div></li> <li><p>ç¦æ­¢ invariant æŠ¥é”™</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// æ–‡ä»¶ä½ç½®: /react/packages/shared/invariant.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">invariant</span><span class="token punctuation">(</span><span class="token parameter">condition<span class="token punctuation">,</span> format<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> e<span class="token punctuation">,</span> f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>condition<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
    <span class="token string">'Internal React error: invariant() is meant to be replaced at compile '</span> <span class="token operator">+</span>
      <span class="token string">'time. There is no runtime version.'</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>eslint é…ç½®</p> <p>åœ¨ react æºç æ–‡ä»¶å¤¹ä¸­æ–°å»º .eslintrc.json å¹¶æ·»åŠ å¦‚ä¸‹é…ç½®</p> <div class="language-react extra-class"><pre class="language-text"><code>{
  &quot;extends&quot;: &quot;react-app&quot;,
  &quot;globals&quot;: {
    &quot;SharedArrayBuffer&quot;: true,
    &quot;spyOnDev&quot;: true,
    &quot;spyOnDevAndProd&quot;: true,
    &quot;spyOnProd&quot;: true,
    &quot;__PROFILE__&quot;: true,
    &quot;__UMD__&quot;: true,
    &quot;__EXPERIMENTAL__&quot;: true,
    &quot;__VARIANT__&quot;: true,
    &quot;gate&quot;: true,
    &quot;trustedTypes&quot;: true
  }
}
</code></pre></div></li> <li><p>ä¿®æ”¹ react react-dom å¼•å…¥æ–¹å¼</p></li></ol> <p>åœ¨index.jså’Œapp.jsä¸­ä¿®æ”¹å¼•å…¥æ–¹å¼</p> <div class="language- extra-class"><pre><code>```javascript
import * as React from &quot;react&quot;
import * as ReactDOM from &quot;react-dom&quot;
```
</code></pre></div><ol start="13"><li><p>è§£å†³ vsCode ä¸­ flow æŠ¥é”™</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token string-property property">&quot;javascript.validate.enable&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
</code></pre></div></li> <li><p>å¯é€‰é¡¹é…ç½®</p> <p>å¦‚æœä½ çš„ vscode ç¼–è¾‘å™¨å®‰è£…äº† prettier æ’ä»¶å¹¶ä¸”åœ¨ä¿å­˜ react æºç æ–‡ä»¶æ—¶å³ä¸‹è§’å‡ºç°å¦‚ä¸‹é”™è¯¯ï¼ŒæŒ‰ç…§å¦‚ä¸‹æ­¥éª¤è§£å†³</p> <img src="/blog/images/react/sourceCode/1.png" alt=""> <ol><li><p>å…¨å±€å®‰è£… prettier</p> <p><code>npm i prettier -g</code></p></li> <li><p>é…ç½® prettier path</p> <p>Settings &gt; Extensions &gt; Prettier &gt; Prettier path</p></li></ol> <img src="/blog/images/react/sourceCode/2.png" alt=""></li> <li><p>__DEV__ æŠ¥é”™</p> <p>åˆ é™¤ node_modules æ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œ npm install</p></li></ol> <h2 id="_2-åˆ›å»º-react-å…ƒç´ "><a href="#_2-åˆ›å»º-react-å…ƒç´ " class="header-anchor">#</a> 2. åˆ›å»º React å…ƒç´ </h2> <p>JSX è¢« Babel ç¼–è¯‘ä¸º React.createElement æ–¹æ³•çš„è°ƒç”¨ï¼ŒcreateElement æ–¹æ³•åœ¨è°ƒç”¨åè¿”å›çš„å°±æ˜¯ ReactElementï¼Œå°±æ˜¯ virtualDOMã€‚</p> <h3 id="_2-1-createelement"><a href="#_2-1-createelement" class="header-anchor">#</a> 2.1 createElement</h3> <p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react/src/ReactElement.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>/**
 * åˆ›å»º React Element
 * type      å…ƒç´ ç±»å‹
 * config    é…ç½®å±æ€§
 * children  å­å…ƒç´ 
 * 1. åˆ†ç¦» props å±æ€§å’Œç‰¹æ®Šå±æ€§
 * 2. å°†å­å…ƒç´ æŒ‚è½½åˆ° props.children ä¸­
 * 3. ä¸º props å±æ€§èµ‹é»˜è®¤å€¼ (defaultProps)
 * 4. åˆ›å»ºå¹¶è¿”å› ReactElement
 */
export function createElement(type, config, children) {
  /**
   * propName -&gt; å±æ€§åç§°
   * ç”¨äºåé¢çš„ for å¾ªç¯
   */
  let propName;

  /**
   * å­˜å‚¨ React Element ä¸­çš„æ™®é€šå…ƒç´ å±æ€§ å³ä¸åŒ…å« key ref self source
   */
  const props = {};

  /**
   * å¾…æå–å±æ€§
   * React å†…éƒ¨ä¸ºäº†å®ç°æŸäº›åŠŸèƒ½è€Œå­˜åœ¨çš„å±æ€§
   */
  let key = null;
  let ref = null;
  let self = null;
  let source = null;

  // å¦‚æœ config ä¸ä¸º null
  if (config != null) {
    // å¦‚æœ config å¯¹è±¡ä¸­æœ‰åˆæ³•çš„ ref å±æ€§
    if (hasValidRef(config)) {
      // å°† config.ref å±æ€§æå–åˆ° ref å˜é‡ä¸­
      ref = config.ref;
      // åœ¨å¼€å‘ç¯å¢ƒä¸­
      if (__DEV__) {
        // å¦‚æœ ref å±æ€§çš„å€¼è¢«è®¾ç½®æˆäº†å­—ç¬¦ä¸²å½¢å¼å°±æŠ¥ä¸€ä¸ªæç¤º
        // è¯´æ˜æ­¤ç”¨æ³•åœ¨å°†æ¥çš„ç‰ˆæœ¬ä¸­ä¼šè¢«åˆ é™¤
        warnIfStringRefCannotBeAutoConverted(config);
      }
    }
    // å¦‚æœåœ¨ config å¯¹è±¡ä¸­æ‹¥æœ‰åˆæ³•çš„ key å±æ€§
    if (hasValidKey(config)) {
      // å°† config.key å±æ€§ä¸­çš„å€¼æå–åˆ° key å˜é‡ä¸­
      key = '' + config.key;
    }

    self = config.__self === undefined ? null : config.__self;
    source = config.__source === undefined ? null : config.__source;
    // éå† config å¯¹è±¡
    for (propName in config) {
      // å¦‚æœå½“å‰éå†åˆ°çš„å±æ€§æ˜¯å¯¹è±¡è‡ªèº«å±æ€§
      // å¹¶ä¸”åœ¨ RESERVED_PROPS å¯¹è±¡ä¸­ä¸å­˜åœ¨è¯¥å±æ€§
      if (
        hasOwnProperty.call(config, propName) &amp;&amp;
        !RESERVED_PROPS.hasOwnProperty(propName)
      ) {
        // å°†æ»¡è¶³æ¡ä»¶çš„å±æ€§æ·»åŠ åˆ° props å¯¹è±¡ä¸­ (æ™®é€šå±æ€§)
        props[propName] = config[propName];
      }
    }
  }

  /**
   * å°†ç¬¬ä¸‰ä¸ªåŠä¹‹åçš„å‚æ•°æŒ‚è½½åˆ° props.children å±æ€§ä¸­
   * å¦‚æœå­å…ƒç´ æ˜¯å¤šä¸ª props.children æ˜¯æ•°ç»„
   * å¦‚æœå­å…ƒç´ æ˜¯ä¸€ä¸ª props.children æ˜¯å¯¹è±¡
   */

  // ç”±äºä»ç¬¬ä¸‰ä¸ªå‚æ•°å¼€å§‹åŠä»¥åéƒ½è¡¨ç¤ºå­å…ƒç´ 
  // æ‰€ä»¥å‡å»å‰ä¸¤ä¸ªå‚æ•°çš„ç»“æœå°±æ˜¯å­å…ƒç´ çš„æ•°é‡
  const childrenLength = arguments.length - 2;
  // å¦‚æœå­å…ƒç´ çš„æ•°é‡æ˜¯ 1
  if (childrenLength === 1) {
    // ç›´æ¥å°†å­å…ƒç´ æŒ‚è½½åˆ°åˆ° props.children å±æ€§ä¸Š
    // æ­¤æ—¶ children æ˜¯å¯¹è±¡ç±»å‹
    props.children = children;
    // å¦‚æœå­å…ƒç´ çš„æ•°é‡å¤§äº 1
  } else if (childrenLength &gt; 1) {
    // åˆ›å»ºæ•°ç»„, æ•°ç»„ä¸­å…ƒç´ çš„æ•°é‡ç­‰äºå­å…ƒç´ çš„æ•°é‡
    const childArray = Array(childrenLength);
    // å¼€å¯å¾ªç¯ å¾ªç¯æ¬¡åŒ¹é…å­å…ƒç´ çš„æ•°é‡
    for (let i = 0; i &lt; childrenLength; i++) {
      // å°†å­å…ƒç´ æ·»åŠ åˆ° childArray æ•°ç»„ä¸­
      // i + 2 çš„åŸå› æ˜¯å®å‚é›†åˆçš„å‰ä¸¤ä¸ªå‚æ•°ä¸æ˜¯å­å…ƒç´ 
      childArray[i] = arguments[i + 2];
    }
    // å¦‚æœæ˜¯å¼€å‘ç¯å¢ƒ
    if (__DEV__) {
      // å¦‚æœ Object å¯¹è±¡ä¸­å­˜åœ¨ freeze æ–¹æ³•
      if (Object.freeze) {
        // è°ƒç”¨ freeze æ–¹æ³• å†»ç»“ childArray æ•°ç»„
        // é˜²æ­¢ React æ ¸å¿ƒå¯¹è±¡è¢«ä¿®æ”¹ å†»ç»“å¯¹è±¡æé«˜æ€§èƒ½
        Object.freeze(childArray);
      }
    }
    // å°†å­å…ƒç´ æ•°ç»„æŒ‚è½½åˆ° props.children å±æ€§ä¸­
    props.children = childArray;
  }

  /**
   * å¦‚æœå½“å‰å¤„ç†æ˜¯ç»„ä»¶
   * çœ‹ç»„ä»¶èº«ä¸Šæ˜¯å¦æœ‰ defaultProps å±æ€§
   * è¿™ä¸ªå±æ€§ä¸­å­˜å‚¨çš„æ˜¯ props å¯¹è±¡ä¸­å±æ€§çš„é»˜è®¤å€¼
   * éå† defaultProps å¯¹è±¡ æŸ¥çœ‹å¯¹åº”çš„ props å±æ€§çš„å€¼æ˜¯å¦ä¸º undefined
   * å¦‚æœä¸ºundefined å°±å°†é»˜è®¤å€¼èµ‹å€¼ç»™å¯¹åº”çš„ props å±æ€§å€¼
   */

  // å°† type å±æ€§å€¼è§†ä¸ºå‡½æ•° æŸ¥çœ‹å…¶ä¸­æ˜¯å¦å…·æœ‰ defaultProps å±æ€§
  if (type &amp;&amp; type.defaultProps) {
    // å°† type å‡½æ•°ä¸‹çš„ defaultProps å±æ€§èµ‹å€¼ç»™ defaultProps å˜é‡
    const defaultProps = type.defaultProps;
    // éå† defaultProps å¯¹è±¡ä¸­çš„å±æ€§ å°†å±æ€§åç§°èµ‹å€¼ç»™ propName å˜é‡
    for (propName in defaultProps) {
      // å¦‚æœ props å¯¹è±¡ä¸­çš„è¯¥å±æ€§çš„å€¼ä¸º undefined
      if (props[propName] === undefined) {
        // å°† defaultProps å¯¹è±¡ä¸­çš„å¯¹åº”å±æ€§çš„å€¼èµ‹å€¼ç»™ props å¯¹è±¡ä¸­çš„å¯¹åº”å±æ€§çš„å€¼
        props[propName] = defaultProps[propName];
      }
    }
  }

  /**
   * åœ¨å¼€å‘ç¯å¢ƒä¸­ å¦‚æœå…ƒç´ çš„ key å±æ€§ æˆ–è€… ref å±æ€§å­˜åœ¨
   * ç›‘æµ‹å¼€å‘è€…æ˜¯å¦åœ¨ç»„ä»¶å†…éƒ¨é€šè¿‡ props å¯¹è±¡è·å–äº† key å±æ€§æˆ–è€… ref å±æ€§
   * å¦‚æœè·å–äº† å°±æŠ¥é”™
   */

  // å¦‚æœå¤„äºå¼€å‘ç¯å¢ƒ
  if (__DEV__) {
    // å…ƒç´ å…·æœ‰ key å±æ€§æˆ–è€… ref å±æ€§
    if (key || ref) {
      // çœ‹ä¸€ä¸‹ type å±æ€§ä¸­å­˜å‚¨çš„æ˜¯å¦æ˜¯å‡½æ•° å¦‚æœæ˜¯å‡½æ•°å°±è¡¨ç¤ºå½“å‰å…ƒç´ æ˜¯ç»„ä»¶
      // å¦‚æœå…ƒç´ ä¸æ˜¯ç»„ä»¶ å°±ç›´æ¥è¿”å›å…ƒç´ ç±»å‹å­—ç¬¦ä¸²
      // displayName ç”¨äºåœ¨æŠ¥é”™è¿‡ç¨‹ä¸­æ˜¾ç¤ºæ˜¯å“ªä¸€ä¸ªç»„ä»¶æŠ¥é”™äº†
      // å¦‚æœå¼€å‘è€…æ˜¾å¼å®šä¹‰äº† displayName å±æ€§ å°±æ˜¾ç¤ºå¼€å‘è€…å®šä¹‰çš„
      // å¦è€…å°±æ˜¾ç¤ºç»„ä»¶åç§° å¦‚æœç»„ä»¶ä¹Ÿæ²¡æœ‰åç§° å°±æ˜¾ç¤º 'Unknown'
      const displayName =
        typeof type === 'function'
          ? type.displayName || type.name || 'Unknown'
          : type;
      // å¦‚æœ key å±æ€§å­˜åœ¨
      if (key) {
        // ä¸º props å¯¹è±¡æ·»åŠ key å±æ€§
        // å¹¶æŒ‡å®šå½“é€šè¿‡ props å¯¹è±¡è·å– key å±æ€§æ—¶æŠ¥é”™
        defineKeyPropWarningGetter(props, displayName);
      }
      // å¦‚æœ ref å±æ€§å­˜åœ¨
      if (ref) {
        // ä¸º props å¯¹è±¡æ·»åŠ  ref å±æ€§
        // å¹¶æŒ‡å®šå½“é€šè¿‡ props å¯¹è±¡è·å– ref å±æ€§æ—¶æŠ¥é”™
        defineRefPropWarningGetter(props, displayName);
      }
    }
  }
  // è¿”å› ReactElement
  return ReactElement(
    type,
    key,
    ref,
    self,
    source,
    // åœ¨ Virtual DOM ä¸­ç”¨äºè¯†åˆ«è‡ªå®šä¹‰ç»„ä»¶
    ReactCurrentOwner.current,
    props,
  );
}
</code></pre></div><h3 id="_2-2-reactelement"><a href="#_2-2-reactelement" class="header-anchor">#</a> 2.2 ReactElement</h3> <p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react/src/ReactElement.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>/**
 * æ¥æ”¶å‚æ•° è¿”å› ReactElement
 */
const ReactElement = function (type, key, ref, self, source, owner, props) {
  const element = {
    /**
     * ç»„ä»¶çš„ç±»å‹, åå…­è¿›åˆ¶æ•°å€¼æˆ–è€… Symbol å€¼
     * React åœ¨æœ€ç»ˆåœ¨æ¸²æŸ“ DOM çš„æ—¶å€™, éœ€è¦ç¡®ä¿å…ƒç´ çš„ç±»å‹æ˜¯ REACT_ELEMENT_TYPE
     * éœ€è¦æ­¤å±æ€§ä½œä¸ºåˆ¤æ–­çš„ä¾æ®
     */
    $$typeof: REACT_ELEMENT_TYPE,

    /**
     * å…ƒç´ å…·ä½“çš„ç±»å‹å€¼ å¦‚æœæ˜¯å…ƒç´ èŠ‚ç‚¹ type å±æ€§ä¸­å­˜å‚¨çš„å°±æ˜¯ div span ç­‰ç­‰
     * å¦‚æœå…ƒç´ æ˜¯ç»„ä»¶ type å±æ€§ä¸­å­˜å‚¨çš„å°±æ˜¯ç»„ä»¶çš„æ„é€ å‡½æ•°
     */
    type: type,
    /**
     * å…ƒç´ çš„å”¯ä¸€æ ‡è¯†
     * ç”¨ä½œå†…éƒ¨ vdom æ¯”å¯¹ æå‡ DOM æ“ä½œæ€§èƒ½
     */
    key: key,
    /**
     * å­˜å‚¨å…ƒç´  DOM å¯¹è±¡æˆ–è€…ç»„ä»¶ å®ä¾‹å¯¹è±¡
     */
    ref: ref,
    /**
     * å­˜å‚¨å‘ç»„ä»¶å†…éƒ¨ä¼ é€’çš„æ•°æ®
     */
    props: props,

    /**
     * è®°å½•å½“å‰å…ƒç´ æ‰€å±ç»„ä»¶ (è®°å½•å½“å‰å…ƒç´ æ˜¯å“ªä¸ªç»„ä»¶åˆ›å»ºçš„)
     */
    _owner: owner,
  };
  // è¿”å› ReactElement
  return element;
};
</code></pre></div><h3 id="_2-3-hasvalidref"><a href="#_2-3-hasvalidref" class="header-anchor">#</a> 2.3 hasValidRef</h3> <p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react/src/ReactElement.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>/**
 * æŸ¥çœ‹å‚æ•°å¯¹è±¡ä¸­æ˜¯å¦æœ‰åˆæ³•çš„ ref å±æ€§
 * è¿”å›å¸ƒå°”å€¼
 */
function hasValidRef(config) {
  return config.ref !== undefined;
}
</code></pre></div><h3 id="_2-4-hasvalidkey"><a href="#_2-4-hasvalidkey" class="header-anchor">#</a> 2.4 hasValidKey</h3> <p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react/src/ReactElement.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>/**
 * æŸ¥çœ‹å‚æ•°å¯¹è±¡ä¸­æ˜¯å¦æœ‰åˆæ³•çš„ key å±æ€§
 * è¿”å›å¸ƒå°”å€¼
 */
function hasValidKey(config) {
  return config.key !== undefined;
}
</code></pre></div><h3 id="_2-5-isvalidelement"><a href="#_2-5-isvalidelement" class="header-anchor">#</a> 2.5 isValidElement</h3> <p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react/src/ReactElement.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>/**
 * éªŒè¯ object å‚æ•°æ˜¯å¦æ˜¯ ReactElement. è¿”å›å¸ƒå°”å€¼
 * éªŒè¯æˆåŠŸçš„æ¡ä»¶:
 * object æ˜¯å¯¹è±¡
 * object ä¸ä¸ºnull
 * objectå¯¹è±¡ä¸­çš„ $$typeof å±æ€§å€¼ä¸º REACT_ELEMENT_TYPE
 */
export function isValidElement(object) {
  return (
    typeof object === 'object' &amp;&amp;
    object !== null &amp;&amp;
    object.$$typeof === REACT_ELEMENT_TYPE
  );
}
</code></pre></div><h3 id="_2-6-definekeypropwarninggetter"><a href="#_2-6-definekeypropwarninggetter" class="header-anchor">#</a> 2.6 defineKeyPropWarningGetter</h3> <p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react/src/ReactElement.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>/**
 *  æŒ‡å®šå½“é€šè¿‡ props å¯¹è±¡è·å– key å±æ€§æ—¶æŠ¥é”™
 *  props        ç»„ä»¶ä¸­çš„ props å¯¹è±¡
 *  displayName  ç»„ä»¶åç§°æ ‡è¯†
 */
function defineKeyPropWarningGetter(props, displayName) {
  // é€šè¿‡ props å¯¹è±¡è·å– key å±æ€§æŠ¥é”™
  const warnAboutAccessingKey = function () {
    // åœ¨å¼€å‘ç¯å¢ƒä¸­
    if (__DEV__) {
      // specialPropKeyWarningShown æ§åˆ¶é”™è¯¯åªè¾“å‡ºä¸€æ¬¡çš„å˜é‡
      if (!specialPropKeyWarningShown) {
        // é€šè¿‡ specialPropKeyWarningShown å˜é‡é”ä½åˆ¤æ–­æ¡ä»¶
        specialPropKeyWarningShown = true;
        // æŒ‡å®šæŠ¥é”™ä¿¡æ¯å’Œç»„ä»¶åç§°
        console.error(
          '%s: `key` is not a prop. Trying to access it will result ' +
            'in `undefined` being returned. If you need to access the same ' +
            'value within the child component, you should pass it as a different ' +
            'prop. (https://reactjs.org/link/special-props)',
          displayName,
        );
      }
    }
  };
  warnAboutAccessingKey.isReactWarning = true;
  // ä¸º props å¯¹è±¡æ·»åŠ  key å±æ€§
  Object.defineProperty(props, 'key', {
    // å½“è·å– key å±æ€§æ—¶è°ƒç”¨ warnAboutAccessingKey æ–¹æ³•è¿›è¡ŒæŠ¥é”™
    get: warnAboutAccessingKey,
    configurable: true,
  });
}
</code></pre></div><h3 id="_2-7-definerefpropwarninggetter"><a href="#_2-7-definerefpropwarninggetter" class="header-anchor">#</a> 2.7 defineRefPropWarningGetter</h3> <p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react/src/ReactElement.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>/**
 *  æŒ‡å®šå½“é€šè¿‡ props å¯¹è±¡è·å– ref å±æ€§æ—¶æŠ¥é”™
 *  props        ç»„ä»¶ä¸­çš„ props å¯¹è±¡
 *  displayName  ç»„ä»¶åç§°æ ‡è¯†
 */
function defineRefPropWarningGetter(props, displayName) {
  // é€šè¿‡ props å¯¹è±¡è·å– ref å±æ€§æŠ¥é”™
  const warnAboutAccessingRef = function () {
    if (__DEV__) {
      // specialPropRefWarningShown æ§åˆ¶é”™è¯¯åªè¾“å‡ºä¸€æ¬¡çš„å˜é‡
      if (!specialPropRefWarningShown) {
        // é€šè¿‡ specialPropRefWarningShown å˜é‡é”ä½åˆ¤æ–­æ¡ä»¶
        specialPropRefWarningShown = true;
        // æŒ‡å®šæŠ¥é”™ä¿¡æ¯å’Œç»„ä»¶åç§°
        console.error(
          '%s: `ref` is not a prop. Trying to access it will result ' +
            'in `undefined` being returned. If you need to access the same ' +
            'value within the child component, you should pass it as a different ' +
            'prop. (https://reactjs.org/link/special-props)',
          displayName,
        );
      }
    }
  };

  warnAboutAccessingRef.isReactWarning = true;
  // ä¸º props å¯¹è±¡æ·»åŠ  key å±æ€§
  Object.defineProperty(props, 'ref', {
    get: warnAboutAccessingRef,
    configurable: true,
  });
}
</code></pre></div><h2 id="_3-react-æ¶æ„"><a href="#_3-react-æ¶æ„" class="header-anchor">#</a> 3. React æ¶æ„</h2> <p>React 16 ç‰ˆæœ¬çš„æ¶æ„å¯ä»¥åˆ†ä¸ºä¸‰å±‚ï¼šè°ƒåº¦å±‚ã€åè°ƒå±‚ã€æ¸²æŸ“å±‚ã€‚</p> <ul><li>Scheduler (è°ƒåº¦å±‚)ï¼šè°ƒåº¦ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œé«˜ä¼˜ä»»åŠ¡ä¼˜å…ˆè¿›å…¥åè°ƒå™¨</li> <li>Reconciler (åè°ƒå±‚)ï¼šæ„å»º Fiber æ•°æ®ç»“æ„ï¼Œæ¯”å¯¹ Fiber å¯¹è±¡æ‰¾å‡ºå·®å¼‚, è®°å½• Fiber å¯¹è±¡è¦è¿›è¡Œçš„ DOM æ“ä½œ</li> <li>Renderer (æ¸²æŸ“å±‚)ï¼šè´Ÿè´£å°†å‘ç”Ÿå˜åŒ–çš„éƒ¨åˆ†æ¸²æŸ“åˆ°é¡µé¢ä¸Š</li></ul> <h3 id="_3-1-scheduler-è°ƒåº¦å±‚"><a href="#_3-1-scheduler-è°ƒåº¦å±‚" class="header-anchor">#</a> 3.1 Scheduler è°ƒåº¦å±‚</h3> <p>åœ¨ React 15 çš„ç‰ˆæœ¬ä¸­ï¼Œé‡‡ç”¨äº†å¾ªç¯åŠ é€’å½’çš„æ–¹å¼è¿›è¡Œäº† virtualDOM çš„æ¯”å¯¹ï¼Œç”±äºé€’å½’ä½¿ç”¨ JavaScript è‡ªèº«çš„æ‰§è¡Œæ ˆï¼Œä¸€æ—¦å¼€å§‹å°±æ— æ³•åœæ­¢ï¼Œç›´åˆ°ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚å¦‚æœ VirtualDOM æ ‘çš„å±‚çº§æ¯”è¾ƒæ·±ï¼ŒvirtualDOM çš„æ¯”å¯¹å°±ä¼šé•¿æœŸå ç”¨ JavaScript ä¸»çº¿ç¨‹ï¼Œç”±äº JavaScript åˆæ˜¯å•çº¿ç¨‹çš„æ— æ³•åŒæ—¶æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œæ‰€ä»¥åœ¨æ¯”å¯¹çš„è¿‡ç¨‹ä¸­æ— æ³•å“åº”ç”¨æˆ·æ“ä½œï¼Œæ— æ³•å³æ—¶æ‰§è¡Œå…ƒç´ åŠ¨ç”»ï¼Œé€ æˆäº†é¡µé¢å¡é¡¿çš„ç°è±¡ã€‚</p> <p>åœ¨ React 16 çš„ç‰ˆæœ¬ä¸­ï¼Œæ”¾å¼ƒäº† JavaScript é€’å½’çš„æ–¹å¼è¿›è¡Œ virtualDOM çš„æ¯”å¯¹ï¼Œè€Œæ˜¯é‡‡ç”¨å¾ªç¯æ¨¡æ‹Ÿé€’å½’ã€‚è€Œä¸”æ¯”å¯¹çš„è¿‡ç¨‹æ˜¯åˆ©ç”¨æµè§ˆå™¨çš„ç©ºé—²æ—¶é—´å®Œæˆçš„ï¼Œä¸ä¼šé•¿æœŸå ç”¨ä¸»çº¿ç¨‹ï¼Œè¿™å°±è§£å†³äº† virtualDOM æ¯”å¯¹é€ æˆé¡µé¢å¡é¡¿çš„é—®é¢˜ã€‚</p> <p>åœ¨ window å¯¹è±¡ä¸­æä¾›äº† requestIdleCallback APIï¼Œå®ƒå¯ä»¥åˆ©ç”¨æµè§ˆå™¨çš„ç©ºé—²æ—¶é—´æ‰§è¡Œä»»åŠ¡ï¼Œä½†æ˜¯å®ƒè‡ªèº«ä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚è¯´å¹¶ä¸æ˜¯æ‰€æœ‰çš„æµè§ˆå™¨éƒ½æ”¯æŒå®ƒï¼Œè€Œä¸”å®ƒçš„è§¦å‘é¢‘ç‡ä¹Ÿä¸æ˜¯å¾ˆç¨³å®šï¼Œæ‰€ä»¥ React æœ€ç»ˆæ”¾å¼ƒäº† requestIdleCallback çš„ä½¿ç”¨ã€‚</p> <p>åœ¨ React ä¸­ï¼Œå®˜æ–¹å®ç°äº†è‡ªå·±çš„ä»»åŠ¡è°ƒåº¦åº“ï¼Œè¿™ä¸ªåº“å°±å«åš Schedulerã€‚å®ƒä¹Ÿå¯ä»¥å®ç°åœ¨æµè§ˆå™¨ç©ºé—²æ—¶æ‰§è¡Œä»»åŠ¡ï¼Œè€Œä¸”è¿˜å¯ä»¥è®¾ç½®ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œé«˜ä¼˜å…ˆçº§ä»»åŠ¡å…ˆæ‰§è¡Œï¼Œä½ä¼˜å…ˆçº§ä»»åŠ¡åæ‰§è¡Œã€‚</p> <p>Scheduler å­˜å‚¨åœ¨ <code>packages/scheduler</code> æ–‡ä»¶å¤¹ä¸­ã€‚</p> <h3 id="_3-2-reconciler-åè°ƒå±‚"><a href="#_3-2-reconciler-åè°ƒå±‚" class="header-anchor">#</a> 3.2 Reconciler åè°ƒå±‚</h3> <p>åœ¨ React 15 çš„ç‰ˆæœ¬ä¸­ï¼Œåè°ƒå™¨å’Œæ¸²æŸ“å™¨äº¤æ›¿æ‰§è¡Œï¼Œå³æ‰¾åˆ°äº†å·®å¼‚å°±ç›´æ¥æ›´æ–°å·®å¼‚ã€‚åœ¨ React 16 çš„ç‰ˆæœ¬ä¸­ï¼Œè¿™ç§æƒ…å†µå‘ç”Ÿäº†å˜åŒ–ï¼Œåè°ƒå™¨å’Œæ¸²æŸ“å™¨ä¸å†äº¤æ›¿æ‰§è¡Œã€‚åè°ƒå™¨è´Ÿè´£æ‰¾å‡ºå·®å¼‚ï¼Œåœ¨æ‰€æœ‰å·®å¼‚æ‰¾å‡ºä¹‹åï¼Œç»Ÿä¸€äº¤ç»™æ¸²æŸ“å™¨è¿›è¡Œ DOM çš„æ›´æ–°ã€‚ä¹Ÿå°±æ˜¯è¯´åè°ƒå™¨çš„ä¸»è¦ä»»åŠ¡å°±æ˜¯æ‰¾å‡ºå·®å¼‚éƒ¨åˆ†ï¼Œå¹¶ä¸ºå·®å¼‚æ‰“ä¸Šæ ‡è®°ã€‚</p> <h3 id="_3-3-renderer-æ¸²æŸ“å±‚"><a href="#_3-3-renderer-æ¸²æŸ“å±‚" class="header-anchor">#</a> 3.3 Renderer æ¸²æŸ“å±‚</h3> <p>æ¸²æŸ“å™¨æ ¹æ®åè°ƒå™¨ä¸º Fiber èŠ‚ç‚¹æ‰“çš„æ ‡è®°ï¼ŒåŒæ­¥æ‰§è¡Œå¯¹åº”çš„DOMæ“ä½œã€‚</p> <p>æ—¢ç„¶æ¯”å¯¹çš„è¿‡ç¨‹ä»é€’å½’å˜æˆäº†å¯ä»¥ä¸­æ–­çš„å¾ªç¯ï¼Œé‚£ä¹ˆ React æ˜¯å¦‚ä½•è§£å†³ä¸­æ–­æ›´æ–°æ—¶ DOM æ¸²æŸ“ä¸å®Œå…¨çš„é—®é¢˜å‘¢ï¼Ÿ</p> <p>å…¶å®æ ¹æœ¬å°±ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºåœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œè°ƒåº¦å™¨å’Œåè°ƒå™¨çš„å·¥ä½œæ˜¯åœ¨å†…å­˜ä¸­å®Œæˆçš„æ˜¯å¯ä»¥è¢«æ‰“æ–­çš„ï¼Œæ¸²æŸ“å™¨çš„å·¥ä½œè¢«è®¾å®šæˆä¸å¯ä»¥è¢«æ‰“æ–­ï¼Œæ‰€ä»¥ä¸å­˜åœ¨DOM æ¸²æŸ“ä¸å®Œå…¨çš„é—®é¢˜ã€‚</p> <h2 id="_4-æ•°æ®ç»“æ„"><a href="#_4-æ•°æ®ç»“æ„" class="header-anchor">#</a> 4. æ•°æ®ç»“æ„</h2> <h3 id="_4-1-fiber"><a href="#_4-1-fiber" class="header-anchor">#</a> 4.1 Fiber</h3> <div class="language-react extra-class"><pre class="language-text"><code>type Fiber = {
  /************************  DOM å®ä¾‹ç›¸å…³  *****************************/
  
  // æ ‡è®°ä¸åŒçš„ç»„ä»¶ç±»å‹, å€¼è¯¦è§ WorkTag
  tag: WorkTag,

  // ç»„ä»¶ç±»å‹ divã€spanã€ç»„ä»¶æ„é€ å‡½æ•°
  type: any,

  // å®ä¾‹å¯¹è±¡, å¦‚ç±»ç»„ä»¶çš„å®ä¾‹ã€åŸç”Ÿ dom å®ä¾‹, è€Œ function ç»„ä»¶æ²¡æœ‰å®ä¾‹, å› æ­¤è¯¥å±æ€§æ˜¯ç©º
  stateNode: any,
 
	/************************  æ„å»º Fiber æ ‘ç›¸å…³  ***************************/
  
  // æŒ‡å‘è‡ªå·±çš„çˆ¶çº§ Fiber å¯¹è±¡
  return: Fiber | null,

  // æŒ‡å‘è‡ªå·±çš„ç¬¬ä¸€ä¸ªå­çº§ Fiber å¯¹è±¡
  child: Fiber | null,
  
  // æŒ‡å‘è‡ªå·±çš„ä¸‹ä¸€ä¸ªå…„å¼Ÿ iber å¯¹è±¡
  sibling: Fiber | null,
  
  // åœ¨ Fiber æ ‘æ›´æ–°çš„è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ª Fiber éƒ½ä¼šæœ‰ä¸€ä¸ªè·Ÿå…¶å¯¹åº”çš„ Fiber
  // æˆ‘ä»¬ç§°ä»–ä¸º current &lt;==&gt; workInProgress
  // åœ¨æ¸²æŸ“å®Œæˆä¹‹åä»–ä»¬ä¼šäº¤æ¢ä½ç½®
  // alternate æŒ‡å‘å½“å‰ Fiber åœ¨ workInProgress æ ‘ä¸­çš„å¯¹åº” Fiber
	alternate: Fiber | null,
		
  /************************  çŠ¶æ€æ•°æ®ç›¸å…³  ********************************/
  
  // å³å°†æ›´æ–°çš„ props
  pendingProps: any, 
  // æ—§çš„ props
  memoizedProps: any,
  // æ—§çš„ state
  memoizedState: any,
		
  /************************  å‰¯ä½œç”¨ç›¸å…³ ******************************/

  // è¯¥ Fiber å¯¹åº”çš„ç»„ä»¶äº§ç”Ÿçš„çŠ¶æ€æ›´æ–°ä¼šå­˜æ”¾åœ¨è¿™ä¸ªé˜Ÿåˆ—é‡Œé¢ 
  updateQueue: UpdateQueue&lt;any&gt; | null,
  
  // ç”¨æ¥è®°å½•å½“å‰ Fiber è¦æ‰§è¡Œçš„ DOM æ“ä½œ
  effectTag: SideEffectTag,

  // å­˜å‚¨ç¬¬ä¸€ä¸ªè¦æ‰§è¡Œå‰¯ä½œç”¨çš„å­çº§ Fiber å¯¹è±¡
  firstEffect: Fiber | null,
  
  // å­˜å‚¨ä¸‹ä¸€ä¸ªè¦æ‰§è¡Œå‰¯ä½œç”¨çš„å­çº§ Fiber å¯¹è±¡
  // æ‰§è¡Œ DOM æ¸²æŸ“æ—¶è¦å…ˆé€šè¿‡ first æ‰¾åˆ°ç¬¬ä¸€ä¸ª, ç„¶åé€šè¿‡ next ä¸€ç›´å‘åæŸ¥æ‰¾
  nextEffect: Fiber | null,
  
  // å­˜å‚¨ DOM æ“ä½œå®Œåçš„å‰¯ä½œç”¨ æ¯”å¦‚è°ƒç”¨ç”Ÿå‘½å‘¨æœŸå‡½æ•°æˆ–è€…é’©å­å‡½æ•°çš„è°ƒç”¨
  lastEffect: Fiber | null,

  // ä»»åŠ¡çš„è¿‡æœŸæ—¶é—´
  expirationTime: ExpirationTime,
  
	// å½“å‰ç»„ä»¶åŠå­ç»„ä»¶å¤„äºä½•ç§æ¸²æŸ“æ¨¡å¼ è¯¦è§ TypeOfMode
  mode: TypeOfMode,
};
</code></pre></div><img src="/blog/images/react/sourceCode/6.png" alt=""> <h3 id="_4-2-worktag"><a href="#_4-2-worktag" class="header-anchor">#</a> 4.2 WorkTag</h3> <p><code>æ–‡ä»¶ä½ç½®ï¼špackages/shared/ReactWorkTags.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>type WorkTag =
  | 0
  | 1
  | 2
  | 3
  | 4
  | 5
  | 6
  | 7
  | 8
  | 9
  | 10
  | 11
  | 12
  | 13
  | 14
  | 15
  | 16
  | 17
  | 18
  | 19
  | 20
  | 21
  | 22;

export const FunctionComponent = 0;
export const ClassComponent = 1;
export const IndeterminateComponent = 2;
export const HostRoot = 3;
export const HostPortal = 4;
export const HostComponent = 5;
export const HostText = 6;
export const Fragment = 7;
export const Mode = 8;
export const ContextConsumer = 9;
export const ContextProvider = 10;
export const ForwardRef = 11;
export const Profiler = 12;
export const SuspenseComponent = 13;
export const MemoComponent = 14;
export const SimpleMemoComponent = 15;
export const LazyComponent = 16;
export const IncompleteClassComponent = 17;
export const DehydratedFragment = 18;
export const SuspenseListComponent = 19;
export const FundamentalComponent = 20;
export const ScopeComponent = 21;
export const Block = 22;
</code></pre></div><h3 id="_4-3-typeofmode"><a href="#_4-3-typeofmode" class="header-anchor">#</a> 4.3 TypeOfMode</h3> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactTypeOfMode.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>export type TypeOfMode = number;

// 0 åŒæ­¥æ¸²æŸ“æ¨¡å¼
export const NoMode = 0b0000;
// 1 ä¸¥æ ¼æ¨¡å¼
export const StrictMode = 0b0001;
// 10 å¼‚æ­¥æ¸²æŸ“è¿‡æ¸¡æ¨¡å¼
export const BlockingMode = 0b0010;
// 100 å¼‚æ­¥æ¸²æŸ“æ¨¡å¼
export const ConcurrentMode = 0b0100;
// 1000 æ€§èƒ½æµ‹è¯•æ¨¡å¼
export const ProfileMode = 0b1000;
</code></pre></div><h3 id="_4-3-sideeffecttag"><a href="#_4-3-sideeffecttag" class="header-anchor">#</a> 4.3 SideEffectTag</h3> <p><code>æ–‡ä»¶ä½ç½®ï¼špackages/shared/ReactSideEffectTags.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>export type SideEffectTag = number;

// Don't change these two values. They're used by React Dev Tools.
export const NoEffect = /*              */ 0b0000000000000; // 0
export const PerformedWork = /*         */ 0b0000000000001; // 1

// You can change the rest (and add more).
export const Placement = /*             */ 0b0000000000010; // 2
export const Update = /*                */ 0b0000000000100; // 4
export const PlacementAndUpdate = /*    */ 0b0000000000110; // 6
export const Deletion = /*              */ 0b0000000001000; // 8
export const ContentReset = /*          */ 0b0000000010000; // 16
export const Callback = /*              */ 0b0000000100000; // 32
export const DidCapture = /*            */ 0b0000001000000; // 64
export const Ref = /*                   */ 0b0000010000000; // 128
export const Snapshot = /*              */ 0b0000100000000; // 256
export const Passive = /*               */ 0b0001000000000; // 512
export const Hydrating = /*             */ 0b0010000000000; // 1024
export const HydratingAndUpdate = /*    */ 0b0010000000100; // 1028

// Passive &amp; Update &amp; Callback &amp; Ref &amp; Snapshot
export const LifecycleEffectMask = /*   */ 0b0001110100100; // 932

// Union of all host effects
export const HostEffectMask = /*        */ 0b0011111111111; // 2047

export const Incomplete = /*            */ 0b0100000000000; // 2048
export const ShouldCapture = /*         */ 0b1000000000000; // 4096
</code></pre></div><h3 id="_4-4-update"><a href="#_4-4-update" class="header-anchor">#</a> 4.4 Update</h3> <div class="language-react extra-class"><pre class="language-text"><code>let update: Update&lt;*&gt; = {
  expirationTime,
  suspenseConfig,

  tag: UpdateState,
  payload: null,
  callback: null,

  next: (null: any),
};
</code></pre></div><h3 id="_4-5-updatequeue"><a href="#_4-5-updatequeue" class="header-anchor">#</a> 4.5 UpdateQueue</h3> <div class="language-react extra-class"><pre class="language-text"><code>const queue: &lt;State&gt; = {
  // ä¸Šä¸€æ¬¡æ›´æ–°ä¹‹åçš„ state, ä½œä¸ºä¸‹ä¸€æ¬¡æ›´æ–°çš„åŸºç¡€
  baseState: fiber.memoizedState,
  baseQueue: null,
  shared: {
    pending: null,
  },
  effects: null,
}
fiber.updateQueue = queue;
</code></pre></div><h3 id="_4-6-roottag"><a href="#_4-6-roottag" class="header-anchor">#</a> 4.6 RootTag</h3> <p><code>æ–‡ä»¶ä½ç½®ï¼špackages/shared/ReactRootTags.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>export type RootTag = 0 | 1 | 2;

// ReactDOM.render
export const LegacyRoot = 0;
// ReactDOM.createBlockingRoot
export const BlockingRoot = 1;
// ReactDOM.createRoot
export const ConcurrentRoot = 2;
</code></pre></div><h3 id="_4-7-åŒç¼“å­˜æŠ€æœ¯"><a href="#_4-7-åŒç¼“å­˜æŠ€æœ¯" class="header-anchor">#</a> 4.7 åŒç¼“å­˜æŠ€æœ¯</h3> <p>åœ¨ React ä¸­ï¼ŒDOM çš„æ›´æ–°é‡‡ç”¨äº†åŒç¼“å­˜æŠ€æœ¯ï¼ŒåŒç¼“å­˜æŠ€æœ¯è‡´åŠ›äºæ›´å¿«é€Ÿçš„ DOM æ›´æ–°ã€‚</p> <p>ä»€ä¹ˆæ˜¯åŒç¼“å­˜ï¼Ÿä¸¾ä¸ªä¾‹å­ï¼Œä½¿ç”¨ canvas ç»˜åˆ¶åŠ¨ç”»æ—¶ï¼Œåœ¨ç»˜åˆ¶æ¯ä¸€å¸§å‰éƒ½ä¼šæ¸…é™¤ä¸Šä¸€å¸§çš„ç”»é¢ï¼Œæ¸…é™¤ä¸Šä¸€å¸§éœ€è¦èŠ±è´¹æ—¶é—´ï¼Œå¦‚æœå½“å‰å¸§ç”»é¢è®¡ç®—é‡åˆæ¯”è¾ƒå¤§ï¼Œåˆéœ€è¦èŠ±è´¹æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œè¿™å°±å¯¼è‡´ä¸Šä¸€å¸§æ¸…é™¤åˆ°ä¸‹ä¸€å¸§æ˜¾ç¤ºä¸­é—´ä¼šæœ‰è¾ƒé•¿çš„é—´éš™ï¼Œå°±ä¼šå‡ºç°ç™½å±ã€‚</p> <p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å†…å­˜ä¸­ç»˜åˆ¶å½“å‰å¸§åŠ¨ç”»ï¼Œç»˜åˆ¶å®Œæ¯•åç›´æ¥ç”¨å½“å‰å¸§æ›¿æ¢ä¸Šä¸€å¸§ç”»é¢ï¼Œè¿™æ ·çš„è¯åœ¨å¸§ç”»é¢æ›¿æ¢çš„è¿‡ç¨‹ä¸­å°±ä¼šèŠ‚çº¦éå¸¸å¤šçš„æ—¶é—´ï¼Œå°±ä¸ä¼šå‡ºç°ç™½å±é—®é¢˜ã€‚è¿™ç§åœ¨å†…å­˜ä¸­æ„å»ºå¹¶ç›´æ¥æ›¿æ¢çš„æŠ€æœ¯å«åšåŒç¼“å­˜ã€‚</p> <p>React ä½¿ç”¨åŒç¼“å­˜æŠ€æœ¯å®Œæˆ Fiber æ ‘çš„æ„å»ºä¸æ›¿æ¢ï¼Œå®ç°DOMå¯¹è±¡çš„å¿«é€Ÿæ›´æ–°ã€‚</p> <p>åœ¨ React ä¸­æœ€å¤šä¼šåŒæ—¶å­˜åœ¨ä¸¤æ£µ Fiber æ ‘ï¼Œå½“å‰åœ¨å±å¹•ä¸­æ˜¾ç¤ºçš„å†…å®¹å¯¹åº”çš„ Fiber æ ‘å«åš current Fiber æ ‘ï¼Œå½“å‘ç”Ÿæ›´æ–°æ—¶ï¼ŒReact ä¼šåœ¨å†…å­˜ä¸­é‡æ–°æ„å»ºä¸€é¢—æ–°çš„ Fiber æ ‘ï¼Œè¿™é¢—æ­£åœ¨æ„å»ºçš„ Fiber æ ‘å«åš workInProgress Fiber æ ‘ã€‚åœ¨åŒç¼“å­˜æŠ€æœ¯ä¸­ï¼ŒworkInProgress Fiber æ ‘å°±æ˜¯å³å°†è¦æ˜¾ç¤ºåœ¨é¡µé¢ä¸­çš„ Fiber æ ‘ï¼Œå½“è¿™é¢— Fiber æ ‘æ„å»ºå®Œæˆåï¼ŒReact ä¼šä½¿ç”¨å®ƒç›´æ¥æ›¿æ¢ current Fiber æ ‘è¾¾åˆ°å¿«é€Ÿæ›´æ–° DOM çš„ç›®çš„ï¼Œå› ä¸º workInProgress Fiber æ ‘æ˜¯åœ¨å†…å­˜ä¸­æ„å»ºçš„æ‰€ä»¥æ„å»ºå®ƒçš„é€Ÿåº¦æ˜¯éå¸¸å¿«çš„ã€‚</p> <p>ä¸€æ—¦ workInProgress Fiber æ ‘åœ¨å±å¹•ä¸Šå‘ˆç°ï¼Œå®ƒå°±ä¼šå˜æˆ current Fiber æ ‘ã€‚</p> <p>åœ¨ current Fiber èŠ‚ç‚¹å¯¹è±¡ä¸­æœ‰ä¸€ä¸ª alternate å±æ€§æŒ‡å‘å¯¹åº”çš„ workInProgress Fiber èŠ‚ç‚¹å¯¹è±¡ï¼Œåœ¨ workInProgress Fiber èŠ‚ç‚¹ä¸­æœ‰ä¸€ä¸ª alternate å±æ€§ä¹ŸæŒ‡å‘å¯¹åº”çš„ current Fiber èŠ‚ç‚¹å¯¹è±¡ã€‚</p> <img src="/blog/images/react/sourceCode/3.png" width="40%" alt=""> <img src="/blog/images/react/sourceCode/4.png" width="40%" alt=""> <h3 id="_4-8-åŒºåˆ†-fiberroot-ä¸-rootfiber"><a href="#_4-8-åŒºåˆ†-fiberroot-ä¸-rootfiber" class="header-anchor">#</a> 4.8 åŒºåˆ† fiberRoot ä¸ rootFiber</h3> <p>fiberRoot è¡¨ç¤º Fiber æ•°æ®ç»“æ„å¯¹è±¡ï¼Œæ˜¯ Fiber æ•°æ®ç»“æ„ä¸­çš„æœ€å¤–å±‚å¯¹è±¡</p> <p>rootFiber è¡¨ç¤ºç»„ä»¶æŒ‚è½½ç‚¹å¯¹åº”çš„ Fiber å¯¹è±¡ï¼Œæ¯”å¦‚ React åº”ç”¨ä¸­é»˜è®¤çš„ç»„ä»¶æŒ‚è½½ç‚¹å°±æ˜¯ id ä¸º root çš„ div</p> <p>fiberRoot åŒ…å« rootFiberï¼Œåœ¨ fiberRoot å¯¹è±¡ä¸­æœ‰ä¸€ä¸ª current å±æ€§ï¼Œå­˜å‚¨ rootFiber</p> <p>rootFiber æŒ‡å‘ fiberRootï¼Œåœ¨ rootFiber å¯¹è±¡ä¸­æœ‰ä¸€ä¸ª stateNode å±æ€§ï¼ŒæŒ‡å‘ fiberRoot</p> <p>åœ¨ React åº”ç”¨ä¸­ FiberRoot åªæœ‰ä¸€ä¸ªï¼Œè€Œ rootFiber å¯ä»¥æœ‰å¤šä¸ªï¼Œå› ä¸º render æ–¹æ³•æ˜¯å¯ä»¥è°ƒç”¨å¤šæ¬¡çš„</p> <p>fiberRoot ä¼šè®°å½•åº”ç”¨çš„æ›´æ–°ä¿¡æ¯ï¼Œæ¯”å¦‚åè°ƒå™¨åœ¨å®Œæˆå·¥ä½œåï¼Œä¼šå°†å·¥ä½œæˆæœå­˜å‚¨åœ¨ fiberRoot ä¸­ã€‚</p> <img src="/blog/images/react/sourceCode/7.png" width="40%" alt=""> <h2 id="_5-åˆå§‹åŒ–æ¸²æŸ“"><a href="#_5-åˆå§‹åŒ–æ¸²æŸ“" class="header-anchor">#</a> 5. åˆå§‹åŒ–æ¸²æŸ“</h2> <p>è¦å°† React å…ƒç´ æ¸²æŸ“åˆ°é¡µé¢ä¸­ï¼Œåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œrender é˜¶æ®µå’Œ commit é˜¶æ®µã€‚</p> <p>render é˜¶æ®µè´Ÿè´£åˆ›å»º Fiber æ•°æ®ç»“æ„å¹¶ä¸º Fiber èŠ‚ç‚¹æ‰“æ ‡è®°ï¼Œæ ‡è®°å½“å‰ Fiber èŠ‚ç‚¹è¦è¿›è¡Œçš„ DOM æ“ä½œã€‚</p> <p>commit é˜¶æ®µè´Ÿè´£æ ¹æ® Fiber èŠ‚ç‚¹æ ‡è®° ( effectTag ) è¿›è¡Œç›¸åº”çš„ DOM æ“ä½œã€‚</p> <h3 id="_5-1-render-é˜¶æ®µ"><a href="#_5-1-render-é˜¶æ®µ" class="header-anchor">#</a> 5.1 render é˜¶æ®µ</h3> <h4 id="_5-1-1-render"><a href="#_5-1-1-render" class="header-anchor">#</a> 5.1.1 render</h4> <p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react-dom/src/client/ReactDOMLegacy.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>/**
 * æ¸²æŸ“å…¥å£
 * element è¦è¿›è¡Œæ¸²æŸ“çš„ ReactElement, createElement æ–¹æ³•çš„è¿”å›å€¼
 * container æ¸²æŸ“å®¹å™¨ &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;
 * callback æ¸²æŸ“å®Œæˆåæ‰§è¡Œçš„å›è°ƒå‡½æ•°
 */
export function render(
  element: React$Element&lt;any&gt;,
  container: Container,
  callback: ?Function,
) {
  // æ£€æµ‹ container æ˜¯å¦æ˜¯ç¬¦åˆè¦æ±‚çš„æ¸²æŸ“å®¹å™¨
  // å³æ£€æµ‹ container æ˜¯å¦æ˜¯çœŸå®çš„DOMå¯¹è±¡
  // å¦‚æœä¸ç¬¦åˆè¦æ±‚å°±æŠ¥é”™
  invariant(
    isValidContainer(container),
    'Target container is not a DOM element.',
  );
  return legacyRenderSubtreeIntoContainer(
    // çˆ¶ç»„ä»¶ åˆå§‹æ¸²æŸ“æ²¡æœ‰çˆ¶ç»„ä»¶ ä¼ é€’ null å ä½
    null,
    element,
    container,
    // æ˜¯å¦ä¸ºæœåŠ¡å™¨ç«¯æ¸²æŸ“ false ä¸æ˜¯æœåŠ¡å™¨ç«¯æ¸²æŸ“ true æ˜¯æœåŠ¡å™¨ç«¯æ¸²æŸ“
    false,
    callback,
  );
}
</code></pre></div><h4 id="_5-1-2-isvalidcontainer"><a href="#_5-1-2-isvalidcontainer" class="header-anchor">#</a> 5.1.2 isValidContainer</h4> <p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react-dom/src/client/ReactDOMRoot.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>/**
 * åˆ¤æ–­ node æ˜¯å¦æ˜¯ç¬¦åˆè¦æ±‚çš„ DOM èŠ‚ç‚¹
 * 1. node å¯ä»¥æ˜¯å…ƒç´ èŠ‚ç‚¹
 * 2. node å¯ä»¥æ˜¯ document èŠ‚ç‚¹
 * 3. node å¯ä»¥æ˜¯ æ–‡æ¡£ç¢ç‰‡èŠ‚ç‚¹
 * 4. node å¯ä»¥æ˜¯æ³¨é‡ŠèŠ‚ç‚¹ä½†æ³¨é‡Šå†…å®¹å¿…é¡»æ˜¯ react-mount-point-unstable
 * 		react å†…éƒ¨ä¼šæ‰¾åˆ°æ³¨é‡ŠèŠ‚ç‚¹çš„çˆ¶çº§ é€šè¿‡è°ƒç”¨çˆ¶çº§å…ƒç´ çš„ insertBefore æ–¹æ³•, å°† element æ’å…¥åˆ°æ³¨é‡ŠèŠ‚ç‚¹çš„å‰é¢
 */
export function isValidContainer(node: mixed): boolean {
  return !!(
    node &amp;&amp;
    (node.nodeType === ELEMENT_NODE ||
      node.nodeType === DOCUMENT_NODE ||
      node.nodeType === DOCUMENT_FRAGMENT_NODE ||
      (node.nodeType === COMMENT_NODE &amp;&amp;
        (node: any).nodeValue === ' react-mount-point-unstable '))
  );
}
</code></pre></div><h4 id="_5-1-3-åˆå§‹åŒ–-fiberroot"><a href="#_5-1-3-åˆå§‹åŒ–-fiberroot" class="header-anchor">#</a> 5.1.3 åˆå§‹åŒ– FiberRoot</h4> <h5 id="_5-1-3-1-legacyrendersubtreeintocontainer"><a href="#_5-1-3-1-legacyrendersubtreeintocontainer" class="header-anchor">#</a> 5.1.3.1 legacyRenderSubtreeIntoContainer</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-dom/src/client/ReactDOMLegacy.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>/**
 * å°†å­æ ‘æ¸²æŸ“åˆ°å®¹å™¨ä¸­ (åˆå§‹åŒ– Fiber æ•°æ®ç»“æ„: åˆ›å»º fiberRoot åŠ rootFiber)
 * parentComponent: çˆ¶ç»„ä»¶, åˆå§‹æ¸²æŸ“ä¼ å…¥äº† null
 * children: render æ–¹æ³•ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°, è¦æ¸²æŸ“çš„ ReactElement
 * container: æ¸²æŸ“å®¹å™¨
 * forceHydrate: true ä¸ºæœåŠ¡ç«¯æ¸²æŸ“, false ä¸ºå®¢æˆ·ç«¯æ¸²æŸ“
 * callback: ç»„ä»¶æ¸²æŸ“å®Œæˆåéœ€è¦æ‰§è¡Œçš„å›è°ƒå‡½æ•°
 **/
function legacyRenderSubtreeIntoContainer(
  parentComponent: ?React$Component&lt;any, any&gt;,
  children: ReactNodeList,
  container: Container,
  forceHydrate: boolean,
  callback: ?Function,
) {
  /**
   * æ£€æµ‹ container æ˜¯å¦å·²ç»æ˜¯åˆå§‹åŒ–è¿‡çš„æ¸²æŸ“å®¹å™¨
   * react åœ¨åˆå§‹æ¸²æŸ“æ—¶ä¼šä¸ºæœ€å¤–å±‚å®¹å™¨æ·»åŠ  _reactRootContainer å±æ€§
   * react ä¼šæ ¹æ®æ­¤å±æ€§è¿›è¡Œä¸åŒçš„æ¸²æŸ“æ–¹å¼
   * root ä¸å­˜åœ¨ è¡¨ç¤ºåˆå§‹æ¸²æŸ“
   * root å­˜åœ¨ è¡¨ç¤ºæ›´æ–°
   */
  // è·å– container å®¹å™¨å¯¹è±¡ä¸‹æ˜¯å¦æœ‰ _reactRootContainer å±æ€§
  let root: RootType = (container._reactRootContainer: any);
  // å³å°†å­˜å‚¨æ ¹ Fiber å¯¹è±¡
  let fiberRoot;
  if (!root) {
    // åˆå§‹æ¸²æŸ“
    // åˆå§‹åŒ–æ ¹ Fiber æ•°æ®ç»“æ„
    // ä¸º container å®¹å™¨æ·»åŠ  _reactRootContainer å±æ€§
    // åœ¨ _reactRootContainer å¯¹è±¡ä¸­æœ‰ä¸€ä¸ªå±æ€§å«åš _internalRoot
    // _internalRoot å±æ€§å€¼å³ä¸º FiberRoot è¡¨ç¤ºæ ¹èŠ‚ç‚¹ Fiber æ•°æ®ç»“æ„
    // legacyCreateRootFromDOMContainer
    // createLegacyRoot
    // new ReactDOMBlockingRoot -&gt; this._internalRoot
    // createRootImpl
    root = container._reactRootContainer = legacyCreateRootFromDOMContainer(
      container,
      forceHydrate,
    );
    // è·å– Fiber Root å¯¹è±¡
    fiberRoot = root._internalRoot;
    /**
     * æ”¹å˜ callback å‡½æ•°ä¸­çš„ this æŒ‡å‘
     * ä½¿å…¶æŒ‡å‘ render æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°çš„çœŸå® DOM å¯¹è±¡
     */
    // å¦‚æœ callback å‚æ•°æ˜¯å‡½æ•°ç±»å‹
    if (typeof callback === 'function') {
      // ä½¿ç”¨ originalCallback å­˜å‚¨ callback å‡½æ•°
      const originalCallback = callback;
      // ä¸º callback å‚æ•°é‡æ–°èµ‹å€¼
      callback = function () {
        // è·å– render æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°çš„çœŸå® DOM å¯¹è±¡
        // å®é™…ä¸Šå°±æ˜¯ id=&quot;root&quot; çš„ div çš„å­å…ƒç´ 
        // rootFiber.child.stateNode
        // rootFiber å°±æ˜¯ id=&quot;root&quot; çš„ div
        const instance = getPublicRootInstance(fiberRoot);
        // è°ƒç”¨ callback å‡½æ•°å¹¶æ”¹å˜å‡½æ•°å†…éƒ¨ this æŒ‡å‘
        originalCallback.call(instance);
      };
    }
    // åˆå§‹åŒ–æ¸²æŸ“ä¸æ‰§è¡Œæ‰¹é‡æ›´æ–°
    // å› ä¸ºæ‰¹é‡æ›´æ–°æ˜¯å¼‚æ­¥çš„æ˜¯å¯ä»¥è¢«æ‰“æ–­çš„, ä½†æ˜¯åˆå§‹åŒ–æ¸²æŸ“åº”è¯¥å°½å¿«å®Œæˆä¸èƒ½è¢«æ‰“æ–­
    // æ‰€ä»¥ä¸æ‰§è¡Œæ‰¹é‡æ›´æ–°
    unbatchedUpdates(() =&gt; {
      updateContainer(children, fiberRoot, parentComponent, callback);
    });
  } else {
    // éåˆå§‹åŒ–æ¸²æŸ“ å³æ›´æ–°
    fiberRoot = root._internalRoot;
    if (typeof callback === 'function') {
      const originalCallback = callback;
      callback = function () {
        const instance = getPublicRootInstance(fiberRoot);
        originalCallback.call(instance);
      };
    }
    // Update
    updateContainer(children, fiberRoot, parentComponent, callback);
  }
  // è¿”å› render æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°çš„çœŸå® DOM å¯¹è±¡ä½œä¸º render æ–¹æ³•çš„è¿”å›å€¼
  // å°±æ˜¯è¯´æ¸²æŸ“è° è¿”å›è°çš„çœŸå® DOM å¯¹è±¡
  return getPublicRootInstance(fiberRoot);
}
</code></pre></div><img src="/blog/images/react/sourceCode/5.png" width="40%" alt=""> <h5 id="_5-1-3-2-legacycreaterootfromdomcontainer"><a href="#_5-1-3-2-legacycreaterootfromdomcontainer" class="header-anchor">#</a> 5.1.3.2 legacyCreateRootFromDOMContainer</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-dom/src/client/ReactDOMLegacy.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>/**
 * åˆ¤æ–­æ˜¯å¦ä¸ºæœåŠ¡å™¨ç«¯æ¸²æŸ“ å¦‚æœä¸æ˜¯æœåŠ¡å™¨ç«¯æ¸²æŸ“
 * æ¸…ç©º container å®¹å™¨ä¸­çš„èŠ‚ç‚¹
 */
function legacyCreateRootFromDOMContainer(
  container: Container,
  forceHydrate: boolean,
): RootType {
  // container =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;
  // æ£€æµ‹æ˜¯å¦ä¸ºæœåŠ¡å™¨ç«¯æ¸²æŸ“
  const shouldHydrate =
    forceHydrate || shouldHydrateDueToLegacyHeuristic(container);
  // å¦‚æœä¸æ˜¯æœåŠ¡å™¨ç«¯æ¸²æŸ“
  if (!shouldHydrate) {
    let rootSibling;
    // å¼€å¯å¾ªç¯ åˆ é™¤ container å®¹å™¨ä¸­çš„èŠ‚ç‚¹
    while ((rootSibling = container.lastChild)) {
      // åˆ é™¤ container å®¹å™¨ä¸­çš„èŠ‚ç‚¹
      container.removeChild(rootSibling);
      /**
       * ä¸ºä»€ä¹ˆè¦æ¸…é™¤ container ä¸­çš„å…ƒç´  ?
       * ä¸ºæä¾›é¦–å±åŠ è½½çš„ç”¨æˆ·ä½“éªŒ, æœ‰æ—¶éœ€è¦åœ¨ container ä¸­æ”¾ç½®ä¸€äº›å ä½å›¾æˆ–è€… loading å›¾
       * å°±æ— å¯é¿å…çš„è¦å‘ container ä¸­åŠ å…¥ html æ ‡è®°.
       * åœ¨å°† ReactElement æ¸²æŸ“åˆ° container ä¹‹å‰, å¿…ç„¶è¦å…ˆæ¸…ç©º container
       * å› ä¸ºå ä½å›¾å’Œ ReactElement ä¸èƒ½åŒæ—¶æ˜¾ç¤º
       *
       * åœ¨åŠ å…¥å ä½ä»£ç æ—¶, æœ€å¥½åªæœ‰ä¸€ä¸ªçˆ¶çº§å…ƒç´ , å¯ä»¥å‡å°‘å†…éƒ¨ä»£ç çš„å¾ªç¯æ¬¡æ•°ä»¥æé«˜æ€§èƒ½
       * &lt;div&gt;
       *  &lt;p&gt;placement&lt;p&gt;
       *  &lt;p&gt;placement&lt;p&gt;
       *  &lt;p&gt;placement&lt;p&gt;
       * &lt;/div&gt;
       */
    }
  }
  return createLegacyRoot(
    container,
    shouldHydrate
      ? {
          hydrate: true,
        }
      : undefined,
  );
}
</code></pre></div><h5 id="_5-1-3-3-createlegacyroot"><a href="#_5-1-3-3-createlegacyroot" class="header-anchor">#</a> 5.1.3.3 createLegacyRoot</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-dom/src/client/ReactDOMRoot.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>/**
 * é€šè¿‡å®ä¾‹åŒ– ReactDOMBlockingRoot ç±»åˆ›å»º LegacyRoot
 */
export function createLegacyRoot(
  container: Container,
  options?: RootOptions,
): RootType {
  // container =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;
  // LegacyRoot å¸¸é‡, å€¼ä¸º 0,
  // é€šè¿‡ render æ–¹æ³•åˆ›å»ºçš„ container å°±æ˜¯ LegacyRoot
  return new ReactDOMBlockingRoot(container, LegacyRoot, options);
}
</code></pre></div><h5 id="_5-1-3-3-reactdomblockingroot"><a href="#_5-1-3-3-reactdomblockingroot" class="header-anchor">#</a> 5.1.3.3 ReactDOMBlockingRoot</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-dom/src/client/ReactDOMRoot.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>/**
 * ç±», é€šè¿‡å®ƒå¯ä»¥åˆ›å»º LegacyRoot çš„ Fiber æ•°æ®ç»“æ„
 */
function ReactDOMBlockingRoot(
  container: Container,
  tag: RootTag,
  options: void | RootOptions,
) {
  // tag =&gt; 0 =&gt; legacyRoot
  // container =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;
  // container._reactRootContainer = {_internalRoot: {}}
  this._internalRoot = createRootImpl(container, tag, options);
}
</code></pre></div><h5 id="_5-1-3-4-createrootimpl"><a href="#_5-1-3-4-createrootimpl" class="header-anchor">#</a> 5.1.3.4 createRootImpl</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-dom/src/client/ReactDOMRoot.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>
function createRootImpl(
  container: Container,
  tag: RootTag,
  options: void | RootOptions,
) {
  // container =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;
  // tag =&gt; 0
  // options =&gt; undefined
  const root = createContainer(container, tag, hydrate, hydrationCallbacks);
  markContainerAsRoot(root.current, container);
  return root;
}
</code></pre></div><h5 id="_5-1-3-5-createcontainer"><a href="#_5-1-3-5-createcontainer" class="header-anchor">#</a> 5.1.3.5 createContainer</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberReconciler.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>// åˆ›å»º container
export function createContainer(
  containerInfo: Container,
  tag: RootTag,
  hydrate: boolean,
  hydrationCallbacks: null | SuspenseHydrationCallbacks,
): OpaqueRoot {
  // containerInfo =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;
  // tag: 0
  // hydrate: false
  // hydrationCallbacks: null
  // å¿½ç•¥äº†å’ŒæœåŠ¡å™¨ç«¯æ¸²æŸ“ç›¸å…³çš„å†…å®¹
  return createFiberRoot(containerInfo, tag, hydrate, hydrationCallbacks);
}
</code></pre></div><h5 id="_5-1-3-6-createfiberroot"><a href="#_5-1-3-6-createfiberroot" class="header-anchor">#</a> 5.1.3.6 createFiberRoot</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberRoot.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>// åˆ›å»ºæ ¹èŠ‚ç‚¹å¯¹åº”çš„ fiber å¯¹è±¡
export function createFiberRoot(
  containerInfo: any,
  tag: RootTag,
  hydrate: boolean,
  hydrationCallbacks: null | SuspenseHydrationCallbacks,
): FiberRoot {
  // åˆ›å»º FiberRoot
  const root: FiberRoot = (new FiberRootNode(containerInfo, tag, hydrate): any);
  // åˆ›å»ºæ ¹èŠ‚ç‚¹å¯¹åº”çš„ rootFiber
  const uninitializedFiber = createHostRootFiber(tag);
  // ä¸º fiberRoot æ·»åŠ  current å±æ€§ å€¼ä¸º rootFiber
  root.current = uninitializedFiber;
  // ä¸º rootFiber æ·»åŠ  stateNode å±æ€§ å€¼ä¸º fiberRoot
  uninitializedFiber.stateNode = root;
  // ä¸º fiber å¯¹è±¡æ·»åŠ  updateQueue å±æ€§, åˆå§‹åŒ– updateQueue å¯¹è±¡
  // updateQueue ç”¨äºå­˜æ”¾ Update å¯¹è±¡
  // Update å¯¹è±¡ç”¨äºè®°å½•ç»„ä»¶çŠ¶æ€çš„æ”¹å˜
  initializeUpdateQueue(uninitializedFiber);
  // è¿”å› root
  return root;
}
</code></pre></div><h5 id="_5-1-3-7-fiberrootnode"><a href="#_5-1-3-7-fiberrootnode" class="header-anchor">#</a> 5.1.3.7 FiberRootNode</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberRoot.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>function FiberRootNode(containerInfo, tag, hydrate) {
  this.tag = tag;
  this.current = null;
  this.containerInfo = containerInfo;
  this.pendingChildren = null;
  this.pingCache = null;
  this.finishedExpirationTime = NoWork;
  this.finishedWork = null;
  this.timeoutHandle = noTimeout;
  this.context = null;
  this.pendingContext = null;
  this.hydrate = hydrate;
  this.callbackNode = null;
  this.callbackPriority = NoPriority;
  this.firstPendingTime = NoWork;
  this.firstSuspendedTime = NoWork;
  this.lastSuspendedTime = NoWork;
  this.nextKnownPendingLevel = NoWork;
  this.lastPingedTime = NoWork;
  this.lastExpiredTime = NoWork;
  if (enableSchedulerTracing) {
    this.interactionThreadID = unstable_getThreadID();
    this.memoizedInteractions = new Set();
    this.pendingInteractionMap = new Map();
  }
  if (enableSuspenseCallback) {
    this.hydrationCallbacks = null;
  }
}
</code></pre></div><h5 id="_5-3-1-8-initializeupdatequeue"><a href="#_5-3-1-8-initializeupdatequeue" class="header-anchor">#</a> 5.3.1.8 initializeUpdateQueue</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberRoot.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>export function initializeUpdateQueue&lt;State&gt;(fiber: Fiber): void {
  const queue: UpdateQueue&lt;State&gt; = {
    baseState: fiber.memoizedState,
    baseQueue: null,
    shared: {
      pending: null,
    },
    effects: null,
  };
  fiber.updateQueue = queue;
}
</code></pre></div><h4 id="_5-1-4-è·å–-rootfiber-child-å®ä¾‹å¯¹è±¡"><a href="#_5-1-4-è·å–-rootfiber-child-å®ä¾‹å¯¹è±¡" class="header-anchor">#</a> 5.1.4 è·å– rootFiber.child å®ä¾‹å¯¹è±¡</h4> <h5 id="_5-1-4-1-getpublicrootinstance"><a href="#_5-1-4-1-getpublicrootinstance" class="header-anchor">#</a> 5.1.4.1  getPublicRootInstance</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberReconciler.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>/**
 * è·å– container çš„ç¬¬ä¸€ä¸ªå­å…ƒç´ çš„å®ä¾‹å¯¹è±¡
 */
export function getPublicRootInstance(
  // FiberRoot
  container: OpaqueRoot,
): React$Component&lt;any, any&gt; | PublicInstance | null {
  // è·å– rootFiber
  const containerFiber = container.current;
  // å¦‚æœ rootFiber æ²¡æœ‰å­å…ƒç´ 
  // æŒ‡çš„å°±æ˜¯ id=&quot;root&quot; çš„ div æ²¡æœ‰å­å…ƒç´ 
  if (!containerFiber.child) {
    // è¿”å› null
    return null;
  }
  // åŒ¹é…å­å…ƒç´ çš„ç±»å‹
  switch (containerFiber.child.tag) {
    // æ™®é€š
    case HostComponent:
      return getPublicInstance(containerFiber.child.stateNode);
    default:
      // è¿”å›å­å…ƒç´ çš„çœŸå® DOM å¯¹è±¡
      return containerFiber.child.stateNode;
  }
}
</code></pre></div><h5 id="_5-1-4-2-getpublicinstance"><a href="#_5-1-4-2-getpublicinstance" class="header-anchor">#</a> 5.1.4.2 getPublicInstance</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-dom/src/client/ReactDOMHostConfig.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>export function getPublicInstance(instance: Instance): * {
  return instance;
}
</code></pre></div><h4 id="_5-1-5-updatecontainer"><a href="#_5-1-5-updatecontainer" class="header-anchor">#</a> 5.1.5 updateContainer</h4> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberReconciler.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>/**
 * è®¡ç®—ä»»åŠ¡çš„è¿‡æœŸæ—¶é—´
 * å†æ ¹æ®ä»»åŠ¡è¿‡æœŸæ—¶é—´åˆ›å»º Update ä»»åŠ¡
 */
export function updateContainer(
	// element è¦æ¸²æŸ“çš„ ReactElement
  element: ReactNodeList,
  // container Fiber Root å¯¹è±¡
  container: OpaqueRoot,
  // parentComponent çˆ¶ç»„ä»¶ åˆå§‹æ¸²æŸ“ä¸º null
  parentComponent: ?React$Component&lt;any, any&gt;,
  // ReactElement æ¸²æŸ“å®Œæˆæ‰§è¡Œçš„å›è°ƒå‡½æ•°
  callback: ?Function,
): ExpirationTime {  
  // container è·å– rootFiber
  const current = container.current;
  // è·å–å½“å‰è·ç¦» react åº”ç”¨åˆå§‹åŒ–çš„æ—¶é—´ 1073741805
  const currentTime = requestCurrentTimeForUpdate();
  // å¼‚æ­¥åŠ è½½è®¾ç½®
  const suspenseConfig = requestCurrentSuspenseConfig();

  // è®¡ç®—è¿‡æœŸæ—¶é—´
  // ä¸ºé˜²æ­¢ä»»åŠ¡å› ä¸ºä¼˜å…ˆçº§çš„åŸå› ä¸€ç›´è¢«æ‰“æ–­è€Œæœªèƒ½æ‰§è¡Œ
  // react ä¼šè®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´, å½“æ—¶é—´åˆ°äº†è¿‡æœŸæ—¶é—´çš„æ—¶å€™
  // å¦‚æœä»»åŠ¡è¿˜æœªæ‰§è¡Œçš„è¯, react å°†ä¼šå¼ºåˆ¶æ‰§è¡Œè¯¥ä»»åŠ¡
  // åˆå§‹åŒ–æ¸²æŸ“æ—¶, ä»»åŠ¡åŒæ­¥æ‰§è¡Œä¸æ¶‰åŠè¢«æ‰“æ–­çš„é—®é¢˜ 1073741823
  const expirationTime = computeExpirationForFiber(
    currentTime,
    current,
    suspenseConfig,
  );
  // è®¾ç½®FiberRoot.context, é¦–æ¬¡æ‰§è¡Œè¿”å›ä¸€ä¸ªemptyContext, æ˜¯ä¸€ä¸ª {}
  const context = getContextForSubtree(parentComponent);
  // åˆå§‹æ¸²æŸ“æ—¶ Fiber Root å¯¹è±¡ä¸­çš„ context å±æ€§å€¼ä¸º null
  // æ‰€ä»¥ä¼šè¿›å…¥åˆ° if ä¸­
  if (container.context === null) {
    // åˆå§‹æ¸²æŸ“æ—¶å°† context å±æ€§å€¼è®¾ç½®ä¸º {}
    container.context = context;
  } else {
    container.pendingContext = context;
  }
  // åˆ›å»ºä¸€ä¸ªå¾…æ‰§è¡Œä»»åŠ¡
  const update = createUpdate(expirationTime, suspenseConfig);
  // å°†è¦æ›´æ–°çš„å†…å®¹æŒ‚è½½åˆ°æ›´æ–°å¯¹è±¡ä¸­çš„ payload ä¸­
  // å°†è¦æ›´æ–°çš„ç»„ä»¶å­˜å‚¨åœ¨ payload å¯¹è±¡ä¸­, æ–¹ä¾¿åæœŸè·å–
  update.payload = {element};
  // åˆ¤æ–­ callback æ˜¯å¦å­˜åœ¨
  callback = callback === undefined ? null : callback;
  // å¦‚æœ callback å­˜åœ¨
  if (callback !== null) {
    // å°† callback æŒ‚è½½åˆ° update å¯¹è±¡ä¸­
    // å…¶å®å°±æ˜¯ä¸€å±‚å±‚ä¼ é€’ æ–¹ä¾¿ ReactElement å…ƒç´ æ¸²æŸ“å®Œæˆè°ƒç”¨
    // å›è°ƒå‡½æ•°æ‰§è¡Œå®Œæˆåä¼šè¢«æ¸…é™¤ å¯ä»¥åœ¨ä»£ç çš„åé¢åŠ ä¸Š return è¿›è¡ŒéªŒè¯
    update.callback = callback;
  }
  // å°† update å¯¹è±¡åŠ å…¥åˆ°å½“å‰ Fiber çš„æ›´æ–°é˜Ÿåˆ—å½“ä¸­ (updateQueue)
  enqueueUpdate(current, update);
  // è°ƒåº¦å’Œæ›´æ–° current å¯¹è±¡
  scheduleWork(current, expirationTime);
  // è¿”å›è¿‡æœŸæ—¶é—´
  return expirationTime;
}
</code></pre></div><h4 id="_5-1-6-enqueueupdate"><a href="#_5-1-6-enqueueupdate" class="header-anchor">#</a> 5.1.6 enqueueUpdate</h4> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactUpdateQueue.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>// å°†ä»»åŠ¡(Update)å­˜æ”¾äºä»»åŠ¡é˜Ÿåˆ—(updateQueue)ä¸­
// åˆ›å»ºå•å‘é“¾è¡¨ç»“æ„å­˜æ”¾ update, next ç”¨æ¥ä¸²è” update
export function enqueueUpdate&lt;State&gt;(fiber: Fiber, update: Update&lt;State&gt;) {
  // è·å–å½“å‰ Fiber çš„ æ›´æ–°é˜Ÿåˆ—
  const updateQueue = fiber.updateQueue;
  // å¦‚æœæ›´æ–°é˜Ÿåˆ—ä¸å­˜åœ¨ å°±è¿”å› null
  if (updateQueue === null) {
    // ä»…å‘ç”Ÿåœ¨ fiber å·²ç»è¢«å¸è½½
    return;
  }
  // è·å–å¾…æ‰§è¡Œçš„ Update ä»»åŠ¡
  // åˆå§‹æ¸²æŸ“æ—¶æ²¡æœ‰å¾…æ‰§è¡Œçš„ä»»åŠ¡
  const sharedQueue = updateQueue.shared;
  const pending = sharedQueue.pending;
  // å¦‚æœæ²¡æœ‰å¾…æ‰§è¡Œçš„ Update ä»»åŠ¡
  if (pending === null) {
    // è¿™æ˜¯ç¬¬ä¸€æ¬¡æ›´æ–°, åˆ›å»ºä¸€ä¸ªå¾ªç¯åˆ—è¡¨.
    update.next = update;
  } else {
    update.next = pending.next;
    pending.next = update;
  }
  // å°† Update ä»»åŠ¡å­˜å‚¨åœ¨ pending å±æ€§ä¸­
  sharedQueue.pending = update;
}
</code></pre></div><h4 id="_5-1-7-scheduleupdateonfiber"><a href="#_5-1-7-scheduleupdateonfiber" class="header-anchor">#</a> 5.1.7 scheduleUpdateOnFiber</h4> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>/**
 * åˆ¤æ–­ä»»åŠ¡æ˜¯å¦ä¸ºåŒæ­¥ è°ƒç”¨åŒæ­¥ä»»åŠ¡å…¥å£
 */
export function scheduleUpdateOnFiber(
  // rootFiber
  fiber: Fiber,
  expirationTime: ExpirationTime,
) {
  /**
   * fiber: åˆå§‹åŒ–æ¸²æŸ“æ—¶ä¸º rootFiber, å³ &lt;div id=&quot;root&quot;&gt;&lt;/div&gt; å¯¹åº”çš„ Fiber å¯¹è±¡
   * expirationTime: ä»»åŠ¡è¿‡æœŸæ—¶é—´ =&gt;1073741823
   */
  /**
   * åˆ¤æ–­æ˜¯å¦æ˜¯æ— é™å¾ªç¯çš„ update å¦‚æœæ˜¯å°±æŠ¥é”™
   * åœ¨ componentWillUpdate æˆ–è€… componentDidUpdate ç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¸­é‡å¤è°ƒç”¨
   * setState æ–¹æ³•æ—¶, å¯èƒ½ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µ, React é™åˆ¶äº†åµŒå¥—æ›´æ–°çš„æ•°é‡ä»¥é˜²æ­¢æ— é™å¾ªç¯
   * é™åˆ¶çš„åµŒå¥—æ›´æ–°æ•°é‡ä¸º 50, å¯é€šè¿‡ NESTED_UPDATE_LIMIT å…¨å±€å˜é‡è·å–
   */
  checkForNestedUpdates();
  // åˆ¤æ–­ä»»åŠ¡æ˜¯å¦æ˜¯åŒæ­¥ä»»åŠ¡ Syncçš„å€¼ä¸º: 1073741823
  if (expirationTime === Sync) {
    if (
      // æ£€æŸ¥æ˜¯å¦å¤„äºéæ‰¹é‡æ›´æ–°æ¨¡å¼
      (executionContext &amp; LegacyUnbatchedContext) !== NoContext &amp;&amp;
      // æ£€æŸ¥æ˜¯å¦æ²¡æœ‰å¤„äºæ­£åœ¨è¿›è¡Œæ¸²æŸ“çš„ä»»åŠ¡
      (executionContext &amp; (RenderContext | CommitContext)) === NoContext
    ) {
      // åŒæ­¥ä»»åŠ¡å…¥å£ç‚¹
      performSyncWorkOnRoot(root);
    }
  // å¿½ç•¥äº†ä¸€äº›åˆå§‹åŒ–æ¸²æŸ“ä¸ä¼šå¾—åˆ°æ‰§è¡Œçš„ä»£ç 
}
</code></pre></div><h4 id="_5-1-8-æ„å»º-fiber-å¯¹è±¡"><a href="#_5-1-8-æ„å»º-fiber-å¯¹è±¡" class="header-anchor">#</a> 5.1.8 æ„å»º Fiber å¯¹è±¡</h4> <h5 id="_5-1-8-1-performsyncworkonroot"><a href="#_5-1-8-1-performsyncworkonroot" class="header-anchor">#</a> 5.1.8.1 performSyncWorkOnRoot</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>// è¿›å…¥ render é˜¶æ®µ, æ„å»º workInProgress Fiber æ ‘
function performSyncWorkOnRoot(root) {
  // å‚æ•° root ä¸º fiberRoot å¯¹è±¡
  // æ£€æŸ¥æ˜¯å¦æœ‰è¿‡æœŸçš„ä»»åŠ¡
  // å¦‚æœæ²¡æœ‰è¿‡æœŸçš„ä»»åŠ¡ å€¼ä¸º 0
  // åˆå§‹åŒ–æ¸²æŸ“æ²¡æœ‰è¿‡æœŸçš„ä»»åŠ¡å¾…æ‰§è¡Œ
  const lastExpiredTime = root.lastExpiredTime;
  // NoWork å€¼ä¸º 0
  // å¦‚æœæœ‰è¿‡æœŸçš„ä»»åŠ¡ å°†è¿‡æœŸæ—¶é—´è®¾ç½®ä¸º lastExpiredTime å¦åˆ™å°†è¿‡æœŸæ—¶é—´è®¾ç½®ä¸º Sync
  // åˆå§‹æ¸²æŸ“è¿‡æœŸæ—¶é—´è¢«è®¾ç½®æˆäº† Sync
  const expirationTime = lastExpiredTime !== NoWork ? lastExpiredTime : Sync;

  // å¦‚æœ root å’Œ workInProgressRoot ä¸ç›¸ç­‰
  // è¯´æ˜ workInProgressRoot ä¸å­˜åœ¨, è¯´æ˜è¿˜æ²¡æœ‰æ„å»º workInProgress Fiber æ ‘
  // workInProgressRoot ä¸ºå…¨å±€å˜é‡ é»˜è®¤å€¼ä¸º null, åˆå§‹æ¸²æŸ“æ—¶å€¼ä¸º null
  // expirationTime =&gt; 1073741823
  // renderExpirationTime =&gt; 0
  // true
  if (root !== workInProgressRoot || expirationTime !== renderExpirationTime) {
    // æ„å»º workInProgressFiber æ ‘åŠrootFiber
    prepareFreshStack(root, expirationTime);
  }
  // workInProgress å¦‚æœä¸ä¸º null
  if (workInProgress !== null) {
    do {
      try {
        // ä»¥åŒæ­¥çš„æ–¹å¼å¼€å§‹æ„å»º Fiber å¯¹è±¡
        workLoopSync();
        // è·³å‡º while å¾ªç¯
        break;
      } catch (thrownValue) {
        handleError(root, thrownValue);
      }
    } while (true);
    
    if (workInProgress !== null) {
      // è¿™æ˜¯ä¸€ä¸ªåŒæ­¥æ¸²æŸ“, æ‰€ä»¥æˆ‘ä»¬åº”è¯¥å®Œæˆæ•´æ£µæ ‘.
      // æ— æ³•æäº¤ä¸å®Œæ•´çš„ root, æ­¤é”™è¯¯å¯èƒ½æ˜¯ç”±äºReactä¸­çš„é”™è¯¯æ‰€è‡´. è¯·æå‡ºé—®é¢˜.
      invariant(
        false,
        'Cannot commit an incomplete root. This error is likely caused by a ' +
          'bug in React. Please file an issue.',
      );
    } else {
      // å°†æ„å»ºå¥½çš„æ–° Fiber å¯¹è±¡å­˜å‚¨åœ¨ finishedWork å±æ€§ä¸­
      // æäº¤é˜¶æ®µä½¿ç”¨
      root.finishedWork = (root.current.alternate: any);
      root.finishedExpirationTime = expirationTime;
      // ç»“æŸ render é˜¶æ®µ
      // è¿›å…¥ commit é˜¶æ®µ
      finishSyncRender(root);
    }
  }
}
</code></pre></div><h5 id="_5-1-8-2-preparefreshstack"><a href="#_5-1-8-2-preparefreshstack" class="header-anchor">#</a> 5.1.8.2 prepareFreshStack</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>/**
 * æ ¹æ® currentFiber æ ‘ä¸­çš„ rootFiber
 * æ„å»º workInProgressFiber æ ‘ä¸­çš„ rootFiber
 */
function prepareFreshStack(root, expirationTime) {
  // ä¸º FiberRoot å¯¹è±¡æ·»åŠ  finishedWork å±æ€§
  // finishedWork è¡¨ç¤º render é˜¶æ®µæ‰§è¡Œå®Œæˆåæ„å»ºçš„å¾…æäº¤çš„ Fiber å¯¹è±¡
  root.finishedWork = null;
  // åˆå§‹åŒ– finishedExpirationTime å€¼ä¸º 0
  root.finishedExpirationTime = NoWork;

  // å»ºæ„ workInProgress Fiber æ ‘çš„ Fiber å¯¹è±¡
  workInProgressRoot = root;
  // æ„å»º workInProgress Fiber æ ‘ä¸­çš„ rootFiber
  workInProgress = createWorkInProgress(root.current, null);
  renderExpirationTime = expirationTime;
  workInProgressRootExitStatus = RootIncomplete;
}
</code></pre></div><h5 id="_5-1-8-3-createworkinprogress"><a href="#_5-1-8-3-createworkinprogress" class="header-anchor">#</a> 5.1.8.3 createWorkInProgress</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiber.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>// æ„å»º workInProgress Fiber æ ‘ä¸­çš„ rootFiber
// æ„å»ºå®Œæˆåä¼šæ›¿æ¢ current fiber
// åˆå§‹æ¸²æŸ“ pendingProps ä¸º null
export function createWorkInProgress(current: Fiber, pendingProps: any): Fiber {
  // current: current Fiber ä¸­çš„ rootFiber
  // è·å– current Fiber ä¸­å¯¹åº”çš„ workInProgress Fiber
  let workInProgress = current.alternate;
  // å¦‚æœ workInProgress ä¸å­˜åœ¨
  if (workInProgress === null) {
    // åˆ›å»º fiber å¯¹è±¡
    workInProgress = createFiber(
      current.tag,
      pendingProps,
      current.key,
      current.mode,
    );
    // å±æ€§å¤ç”¨
    workInProgress.elementType = current.elementType;
    workInProgress.type = current.type;
    workInProgress.stateNode = current.stateNode;
    // ä½¿ç”¨ alternate å­˜å‚¨ current
    workInProgress.alternate = current;
    // ä½¿ç”¨ alternate å­˜å‚¨ workInProgress
    current.alternate = workInProgress;
  }
  
  workInProgress.childExpirationTime = current.childExpirationTime;
  workInProgress.expirationTime = current.expirationTime;
  workInProgress.child = current.child;
  workInProgress.memoizedProps = current.memoizedProps;
  workInProgress.memoizedState = current.memoizedState;
  workInProgress.updateQueue = current.updateQueue;
  workInProgress.sibling = current.sibling;
  workInProgress.index = current.index;
  workInProgress.ref = current.ref;
	
  // è¿”å›åˆ›å»ºå¥½çš„ workInProgress Fiber å¯¹è±¡
  return workInProgress;
}
</code></pre></div><h5 id="_5-1-8-4-workloopsync"><a href="#_5-1-8-4-workloopsync" class="header-anchor">#</a> 5.1.8.4 workLoopSync</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>// ä»¥åŒæ­¥çš„æ–¹å¼æ„å»º workInProgress Fiber å¯¹è±¡
function workLoopSync() {
  // workInProgress æ˜¯ä¸€ä¸ª fiber å¯¹è±¡
  // å®ƒçš„å€¼ä¸ä¸º null æ„å‘³ç€è¯¥ fiber å¯¹è±¡ä¸Šä»ç„¶æœ‰æ›´æ–°è¦æ‰§è¡Œ
  while (workInProgress !== null) {
    workInProgress = performUnitOfWork(workInProgress);
  }
}
</code></pre></div><h5 id="_5-1-8-5-performunitofwork"><a href="#_5-1-8-5-performunitofwork" class="header-anchor">#</a> 5.1.8.5 performUnitOfWork</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>function performUnitOfWork(unitOfWork: Fiber): Fiber | null {
  // unitOfWork =&gt; workInProgress Fiber æ ‘ä¸­çš„ rootFiber
  // current =&gt; currentFiber æ ‘ä¸­çš„ rootFiber
  const current = unitOfWork.alternate;
  // å­˜å‚¨ä¸‹ä¸€ä¸ªè¦æ„å»ºçš„å­çº§ Fiber å¯¹è±¡
  let next;
  // false
  if (enableProfilerTimer &amp;&amp; (unitOfWork.mode &amp; ProfileMode) !== NoMode) {
    // åˆå§‹æ¸²æŸ“ ä¸æ‰§è¡Œ
  } else {
    // beginWork: ä»çˆ¶åˆ°å­, æ„å»º Fiber èŠ‚ç‚¹å¯¹è±¡
    // è¿”å›å€¼ next ä¸ºå½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
    next = beginWork(current, unitOfWork, renderExpirationTime);
  }
  // ä¸ºæ—§çš„ props å±æ€§èµ‹å€¼
  // æ­¤æ¬¡æ›´æ–°å pendingProps å˜ä¸º memoizedProps
  unitOfWork.memoizedProps = unitOfWork.pendingProps;
  // å¦‚æœå­èŠ‚ç‚¹ä¸å­˜åœ¨è¯´æ˜å½“å‰èŠ‚ç‚¹å‘ä¸‹éå†å­èŠ‚ç‚¹å·²ç»åˆ°åº•äº†
  // ç»§ç»­å‘ä¸Šè¿”å› é‡åˆ°å…„å¼ŸèŠ‚ç‚¹ æ„å»ºå…„å¼ŸèŠ‚ç‚¹çš„å­ Fiber å¯¹è±¡ ç›´åˆ°è¿”å›åˆ°æ ¹ Fiber å¯¹è±¡
  if (next === null) {
    // ä»å­åˆ°çˆ¶, æ„å»ºå…¶ä½™èŠ‚ç‚¹ Fiber å¯¹è±¡
    next = completeUnitOfWork(unitOfWork);
  }
  return next;
}
</code></pre></div><h5 id="_5-1-8-6-beginwork"><a href="#_5-1-8-6-beginwork" class="header-anchor">#</a> 5.1.8.6 beginWork</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberBeginWork.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>// ä»çˆ¶åˆ°å­, æ„å»º Fiber èŠ‚ç‚¹å¯¹è±¡
function beginWork(
  current: Fiber | null,
  workInProgress: Fiber,
  renderExpirationTime: ExpirationTime,
): Fiber | null {
  // NoWork å¸¸é‡ å€¼ä¸º0 æ¸…ç©ºè¿‡æœŸæ—¶é—´
  workInProgress.expirationTime = NoWork;
  // æ ¹æ®å½“å‰ Fiber çš„ç±»å‹å†³å®šå¦‚ä½•æ„å»ºèµ·å­çº§ Fiber å¯¹è±¡
  // æ–‡ä»¶ä½ç½®: shared/ReactWorkTags.js
  switch (workInProgress.tag) {
    // 2
    // å‡½æ•°å‹ç»„ä»¶åœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“ç»„ä»¶æ—¶ä½¿ç”¨
    case IndeterminateComponent: {
      return mountIndeterminateComponent(
        // æ—§ Fiber
        current,
        // æ–° Fiber
        workInProgress,
        // æ–° Fiber çš„ type å€¼ åˆå§‹æ¸²æŸ“æ—¶æ˜¯Appç»„ä»¶å‡½æ•°
        workInProgress.type,
        // åŒæ­¥ æ•´æ•°æœ€å¤§å€¼ 1073741823
        renderExpirationTime,
      );
    }
    // 0
    case FunctionComponent: {
      const Component = workInProgress.type;
      const unresolvedProps = workInProgress.pendingProps;
      const resolvedProps =
        workInProgress.elementType === Component
          ? unresolvedProps
          : resolveDefaultProps(Component, unresolvedProps);
      return updateFunctionComponent(
        current,
        workInProgress,
        Component,
        resolvedProps,
        renderExpirationTime,
      );
    }
    // 1
    case ClassComponent: {
      const Component = workInProgress.type;
      const unresolvedProps = workInProgress.pendingProps;
      const resolvedProps =
        workInProgress.elementType === Component
          ? unresolvedProps
          : resolveDefaultProps(Component, unresolvedProps);
      return updateClassComponent(
        current,
        workInProgress,
        Component,
        resolvedProps,
        renderExpirationTime,
      );
    }
    // 3
    case HostRoot:
      return updateHostRoot(current, workInProgress, renderExpirationTime);
    // 5
    case HostComponent:
      return updateHostComponent(current, workInProgress, renderExpirationTime);
    // 6
    case HostText:
      return updateHostText(current, workInProgress);
  // ç»„ä»¶ç±»å‹æœªçŸ¥ æŠ¥é”™
  invariant(
    false,
    'Unknown unit of work tag (%s). This error is likely caused by a bug in ' +
      'React. Please file an issue.',
    workInProgress.tag,
  );
}
</code></pre></div><h5 id="_5-1-8-7-updatehostroot"><a href="#_5-1-8-7-updatehostroot" class="header-anchor">#</a> 5.1.8.7 updateHostRoot</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberBeginWork.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>// HostRoot =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt; å¯¹åº”çš„ Fiber å¯¹è±¡
// æ‰¾å‡º HostRoot çš„å­ ReactElement å¹¶ä¸ºå…¶æ„å»º Fiber å¯¹è±¡
function updateHostRoot(current, workInProgress, renderExpirationTime) {
  // è·å–æ›´æ–°é˜Ÿåˆ—
  const updateQueue = workInProgress.updateQueue;
  // è·å–æ–°çš„ props å¯¹è±¡ null
  const nextProps = workInProgress.pendingProps;
  // è·å–ä¸Šä¸€æ¬¡æ¸²æŸ“ä½¿ç”¨çš„ state null
  const prevState = workInProgress.memoizedState;
  // è·å–ä¸Šä¸€æ¬¡æ¸²æŸ“ä½¿ç”¨çš„ children null
  const prevChildren = prevState !== null ? prevState.element : null;
  // æµ…å¤åˆ¶æ›´æ–°é˜Ÿåˆ—, é˜²æ­¢å¼•ç”¨å±æ€§äº’ç›¸å½±å“
  // workInProgress.updateQueue æµ…æ‹·è´ current.updateQueue
  cloneUpdateQueue(current, workInProgress);
  // è·å– updateQueue.payload å¹¶èµ‹å€¼åˆ° workInProgress.memoizedState
  // è¦æ›´æ–°çš„å†…å®¹å°±æ˜¯ element å°±æ˜¯ rootFiber çš„å­å…ƒç´ 
  processUpdateQueue(workInProgress, nextProps, null, renderExpirationTime);
  // è·å– element æ‰€åœ¨å¯¹è±¡
  const nextState = workInProgress.memoizedState;
  // ä»å¯¹è±¡ä¸­è·å– element
  const nextChildren = nextState.element;
  // è·å– fiberRoot å¯¹è±¡
  const root: FiberRoot = workInProgress.stateNode;
  // æœåŠ¡å™¨ç«¯æ¸²æŸ“èµ° if
  if (root.hydrate &amp;&amp; enterHydrationState(workInProgress)) {
    // å¿½ç•¥
  } else {
    // å®¢æˆ·ç«¯æ¸²æŸ“èµ° else
    // æ„å»ºå­èŠ‚ç‚¹ fiber å¯¹è±¡
    reconcileChildren(
      current,
      workInProgress,
      nextChildren,
      renderExpirationTime,
    );
  }
  // è¿”å›å­èŠ‚ç‚¹ fiber å¯¹è±¡
  return workInProgress.child;
}
</code></pre></div><h5 id="_5-1-8-8-reconcilechildren"><a href="#_5-1-8-8-reconcilechildren" class="header-anchor">#</a> 5.1.8.8 reconcileChildren</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberBeginWork.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>export function reconcileChildren(
  // æ—§ Fiber
  current: Fiber | null,
  // çˆ¶çº§ Fiber
  workInProgress: Fiber,
  // å­çº§ vdom å¯¹è±¡
  nextChildren: any,
  // åˆå§‹æ¸²æŸ“ æ•´å‹æœ€å¤§å€¼ ä»£è¡¨åŒæ­¥ä»»åŠ¡
  renderExpirationTime: ExpirationTime,
) {
  /**
   * ä¸ºä»€ä¹ˆè¦ä¼ é€’ current ?
   * å¦‚æœä¸æ˜¯åˆå§‹æ¸²æŸ“çš„æƒ…å†µ, è¦è¿›è¡Œæ–°æ—§ Fiber å¯¹æ¯”
   * åˆå§‹æ¸²æŸ“æ—¶åˆ™ç”¨ä¸åˆ° current
   */
  // å¦‚æœå°± Fiber ä¸º null è¡¨ç¤ºåˆå§‹æ¸²æŸ“
  if (current === null) {
    // ä¸ºå½“å‰æ„å»ºçš„ Fiber å¯¹è±¡æ·»åŠ å­çº§ Fiber å¯¹è±¡
    workInProgress.child = mountChildFibers(
      workInProgress,
      null,
      nextChildren,
      renderExpirationTime,
    );
  }
  // å¿½ç•¥äº† else çš„æƒ…å†µ
}
</code></pre></div><h5 id="_5-1-8-9-childreconciler"><a href="#_5-1-8-9-childreconciler" class="header-anchor">#</a> 5.1.8.9 ChildReconciler</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactChildFiber.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>/**
 * shouldTrackSideEffects æ ‡è¯†, æ˜¯å¦ä¸º Fiber å¯¹è±¡æ·»åŠ  effectTag
 * true æ·»åŠ  false ä¸æ·»åŠ 
 * å¯¹äºåˆå§‹æ¸²æŸ“æ¥è¯´, åªæœ‰æ ¹ç»„ä»¶éœ€è¦æ·»åŠ , å…¶ä»–å…ƒç´ ä¸éœ€è¦æ·»åŠ , é˜²æ­¢è¿‡å¤šçš„ DOM æ“ä½œ
 */
// ç”¨äºåˆå§‹æ¸²æŸ“
export const mountChildFibers = ChildReconciler(false);

function ChildReconciler(shouldTrackSideEffects) {
 
  function placeChild(
    newFiber: Fiber,
    lastPlacedIndex: number,
    newIndex: number,
  ): number {
    newFiber.index = newIndex;
    if (!shouldTrackSideEffects) {
      return lastPlacedIndex;
    }
    // å¿½ç•¥äº†ä¸€éƒ¨åˆ†åˆå§‹åŒ–æ¸²æŸ“ä¸æ‰§è¡Œçš„ä»£ç 
  }

  function placeSingleChild(newFiber: Fiber): Fiber {
    // å¦‚æœæ˜¯åˆå§‹æ¸²æŸ“ ä¼šåœ¨æ ¹ç»„ä»¶(App)ä¸Šè®¾ç½® effectTag å±æ€§ä¸º Placement å€¼ä¸º 1
    // å…¶ä»–å­çº§èŠ‚ç‚¹å…·æœ‰é»˜è®¤å€¼ä¸º 0 é˜²æ­¢åœ¨ commit é˜¶æ®µåå¤æ“ä½œçœŸå®DOM
    // åˆå§‹æ¸²æŸ“æ—¶å¦‚æœå½“å‰å¤„ç†çš„æ˜¯æ ¹ç»„ä»¶ true å…¶ä»–ç»„ä»¶ false
    if (shouldTrackSideEffects &amp;&amp; newFiber.alternate === null) {
      // Placement è¡¨ç¤ºæ–°åˆ›å»ºçš„èŠ‚ç‚¹
      newFiber.effectTag = Placement;
    }
    return newFiber;
  }
  
  // å¤„ç†å­å…ƒç´ æ˜¯æ•°ç»„çš„æƒ…å†µ
  function reconcileChildrenArray(
    // çˆ¶çº§ Fiber
    returnFiber: Fiber,
    currentFirstChild: Fiber | null,
    // å­çº§ vdom æ•°ç»„
    newChildren: Array&lt;*&gt;,
    expirationTime: ExpirationTime,
  ): Fiber | null {
    /**
     * å­˜å‚¨ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ Fiber å¯¹è±¡
     * æ–¹æ³•è¿”å›çš„ä¹Ÿæ˜¯ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ Fiber å¯¹è±¡
     * å› ä¸ºå…¶ä»–å­èŠ‚ç‚¹ Fiber å¯¹è±¡éƒ½å­˜å‚¨åœ¨ä¸Šä¸€ä¸ªå­ Fiber èŠ‚ç‚¹å¯¹è±¡çš„ sibling å±æ€§ä¸­
     */
    let resultingFirstChild: Fiber | null = null;
    // ä¸Šä¸€æ¬¡åˆ›å»ºçš„ Fiber å¯¹è±¡
    let previousNewFiber: Fiber | null = null;
    // åˆå§‹æ¸²æŸ“æ²¡æœ‰æ—§çš„å­çº§ æ‰€ä»¥ä¸º null
    let oldFiber = currentFirstChild;

    let lastPlacedIndex = 0;
    let newIdx = 0;
    let nextOldFiber = null;

    // oldFiber ä¸ºç©º è¯´æ˜æ˜¯åˆå§‹æ¸²æŸ“
    if (oldFiber === null) {
      // éå†å­ vdom å¯¹è±¡
      for (; newIdx &lt; newChildren.length; newIdx++) {
        // åˆ›å»ºå­ vdom å¯¹åº”çš„ fiber å¯¹è±¡
        const newFiber = createChild(
          returnFiber,
          newChildren[newIdx],
          expirationTime,
        );
        // å¦‚æœ newFiber ä¸º null
        if (newFiber === null) {
          // è¿›å…¥ä¸‹æ¬¡å¾ªç¯
          continue;
        }
        // åˆå§‹æ¸²æŸ“æ—¶åªä¸º newFiber æ·»åŠ äº† index å±æ€§,
        // å…¶ä»–äº‹æ²¡å¹². lastPlacedIndex è¢«åŸå°ä¸åŠ¨çš„è¿”å›äº†
        lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);
        // ä¸ºå½“å‰èŠ‚ç‚¹è®¾ç½®ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹
        if (previousNewFiber === null) {
          // å­˜å‚¨ç¬¬ä¸€ä¸ªå­ Fiber å‘ç”Ÿåœ¨ç¬¬ä¸€æ¬¡å¾ªç¯æ—¶
          resultingFirstChild = newFiber;
        } else {
          // ä¸ºèŠ‚ç‚¹è®¾ç½®ä¸‹ä¸€ä¸ªå…„å¼Ÿ Fiber
          previousNewFiber.sibling = newFiber;
        }
        // åœ¨å¾ªç¯çš„è¿‡ç¨‹ä¸­æ›´æ–°ä¸Šä¸€ä¸ªåˆ›å»ºçš„Fiber å¯¹è±¡
        previousNewFiber = newFiber;
      }
      // è¿”å›åˆ›å»ºå¥½çš„å­ Fiber
      // å…¶ä»– Fiber éƒ½ä½œä¸º sibling å­˜åœ¨
      return resultingFirstChild;
    }
    // è¿”å›ç¬¬ä¸€ä¸ªå­å…ƒç´  Fiber å¯¹è±¡
    return resultingFirstChild;
  }

  // å¤„ç†å­å…ƒç´ æ˜¯æ–‡æœ¬æˆ–è€…æ•°å€¼çš„æƒ…å†µ
  function reconcileSingleTextNode(
    returnFiber: Fiber,
    currentFirstChild: Fiber | null,
    textContent: string,
    expirationTime: ExpirationTime,
  ): Fiber {
    // åˆå§‹æ¸²æŸ“ä¸æ‰§è¡Œ
    if (currentFirstChild !== null &amp;&amp; currentFirstChild.tag === HostText) {
      // We already have an existing node so let's just update it and delete
      // the rest.
      deleteRemainingChildren(returnFiber, currentFirstChild.sibling);
      const existing = useFiber(currentFirstChild, textContent);
      existing.return = returnFiber;
      return existing;
    }
    // ç°æœ‰çš„ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ä¸æ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªå¹¶åˆ é™¤ç°æœ‰çš„.
    // åˆå§‹æ¸²æŸ“ä¸æ‰§è¡Œ
    deleteRemainingChildren(returnFiber, currentFirstChild);
    // æ ¹æ®æ–‡æœ¬åˆ›å»º Fiber å¯¹è±¡
    const created = createFiberFromText(
      textContent,
      returnFiber.mode,
      expirationTime,
    );
    // è®¾ç½®çˆ¶ Fiber å¯¹è±¡
    created.return = returnFiber;
    // è¿”å›åˆ›å»ºå¥½çš„ Fiber å¯¹è±¡
    return created;
  }
  // å¤„ç†å­å…ƒç´ æ˜¯å•ä¸ªå¯¹è±¡çš„æƒ…å†µ
  function reconcileSingleElement(
    // çˆ¶ Fiber å¯¹è±¡
    returnFiber: Fiber,
    // å¤‡ä»½å­ fiber
    currentFirstChild: Fiber | null,
    // å­ vdom å¯¹è±¡
    element: ReactElement,
    expirationTime: ExpirationTime,
  ): Fiber {
    // æŸ¥çœ‹å­ vdom å¯¹è±¡æ˜¯å¦è¡¨ç¤º fragment
    if (element.type === REACT_FRAGMENT_TYPE) {
      // false
    } else {
      // æ ¹æ® React Element åˆ›å»º Fiber å¯¹è±¡
      // è¿”å›åˆ›å»ºå¥½çš„ Fiber å¯¹è±¡
      const created = createFiberFromElement(
        element,
        // ç”¨æ¥è¡¨ç¤ºå½“å‰ç»„ä»¶ä¸‹çš„æ‰€æœ‰å­ç»„ä»¶è¦ç”¨å¤„äºä½•ç§æ¸²æŸ“æ¨¡å¼
        // æ–‡ä»¶ä½ç½®: ./ReactTypeOfMode.js
        // 0    åŒæ­¥æ¸²æŸ“æ¨¡å¼
        // 100  å¼‚æ­¥æ¸²æŸ“æ¨¡å¼
        returnFiber.mode,
        expirationTime,
      );
      // æ·»åŠ  ref å±æ€§ { current: DOM }
      created.ref = coerceRef(returnFiber, currentFirstChild, element);
      // æ·»åŠ çˆ¶çº§ Fiber å¯¹è±¡
      created.return = returnFiber;
      // è¿”å›åˆ›å»ºå¥½çš„å­ Fiber
      return created;
    }
  }

  function reconcileChildFibers(
    // çˆ¶ Fiber å¯¹è±¡
    returnFiber: Fiber,
    // æ—§çš„ç¬¬ä¸€ä¸ªå­ Fiber åˆå§‹æ¸²æŸ“ null
    currentFirstChild: Fiber | null,
    // æ–°çš„å­ vdom å¯¹è±¡
    newChild: any,
    // åˆå§‹æ¸²æŸ“ æ•´å‹æœ€å¤§å€¼ ä»£è¡¨åŒæ­¥ä»»åŠ¡
    expirationTime: ExpirationTime,
  ): Fiber | null {
    // è¿™æ˜¯å…¥å£æ–¹æ³•, æ ¹æ® newChild ç±»å‹è¿›è¡Œå¯¹åº”å¤„ç†

    // åˆ¤æ–­æ–°çš„å­ vdom æ˜¯å¦ä¸ºå ä½ç»„ä»¶ æ¯”å¦‚ &lt;&gt;&lt;/&gt;
    // false
    const isUnkeyedTopLevelFragment =
      typeof newChild === 'object' &amp;&amp;
      newChild !== null &amp;&amp;
      newChild.type === REACT_FRAGMENT_TYPE &amp;&amp;
      newChild.key === null;

    // å¦‚æœ newChild ä¸ºå ä½ç¬¦, ä½¿ç”¨ å ä½ç¬¦ç»„ä»¶çš„å­å…ƒç´ ä½œä¸º newChild
    if (isUnkeyedTopLevelFragment) {
      newChild = newChild.props.children;
    }

    // æ£€æµ‹ newChild æ˜¯å¦ä¸ºå¯¹è±¡ç±»å‹
    const isObject = typeof newChild === 'object' &amp;&amp; newChild !== null;

    // newChild æ˜¯å•ä¸ªå¯¹è±¡çš„æƒ…å†µ
    if (isObject) {
      // åŒ¹é…å­å…ƒç´ çš„ç±»å‹
      switch (newChild.$$typeof) {
        // å­å…ƒç´ ä¸º ReactElement
        case REACT_ELEMENT_TYPE:
          // ä¸º Fiber å¯¹è±¡è®¾ç½® effectTag å±æ€§
          // è¿”å›åˆ›å»ºå¥½çš„å­ Fiber
          return placeSingleChild(
            // å¤„ç†å•ä¸ª React Element çš„æƒ…å†µ
            // å†…éƒ¨ä¼šè°ƒç”¨å…¶ä»–æ–¹æ³•åˆ›å»ºå¯¹åº”çš„ Fiber å¯¹è±¡
            reconcileSingleElement(
              returnFiber,
              currentFirstChild,
              newChild,
              expirationTime,
            ),
          );
      }
    }
      
    // å¤„ç† children ä¸ºæ–‡æœ¬å’Œæ•°å€¼çš„æƒ…å†µ return &quot;App works&quot;
    if (typeof newChild === 'string' || typeof newChild === 'number') {
      return placeSingleChild(
        reconcileSingleTextNode(
          returnFiber,
          currentFirstChild,
          // å¦‚æœ newChild æ˜¯æ•°å€¼, è½¬æ¢ä¸ºå­—ç¬¦ä¸²
          '' + newChild,
          expirationTime,
        ),
      );
    }

    // children æ˜¯æ•°ç»„çš„æƒ…å†µ
    if (isArray(newChild)) {
      // è¿”å›åˆ›å»ºå¥½çš„å­ Fiber
      return reconcileChildrenArray(
        returnFiber,
        currentFirstChild,
        newChild,
        expirationTime,
      );
    }
  }
}
</code></pre></div><h5 id="_5-1-8-10-completeunitofwork"><a href="#_5-1-8-10-completeunitofwork" class="header-anchor">#</a> 5.1.8.10 completeUnitOfWork</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>/**
 *
 * ä»ä¸‹è‡³ä¸Šç§»åŠ¨åˆ°è¯¥èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹, å¦‚æœä¸€ç›´å¾€ä¸Šæ²¡æœ‰å…„å¼ŸèŠ‚ç‚¹å°±è¿”å›çˆ¶èŠ‚ç‚¹, æœ€ç»ˆä¼šåˆ°è¾¾ root èŠ‚ç‚¹
 * 1. åˆ›å»ºå…¶ä»–èŠ‚ç‚¹çš„ Fiber å¯¹è±¡
 * 2. åˆ›å»ºæ¯ä¸€ä¸ªèŠ‚ç‚¹çš„çœŸå® DOM å¯¹è±¡å¹¶å°†å…¶æ·»åŠ åˆ° stateNode å±æ€§ä¸­
 * 3. æ„å»º effect é“¾è¡¨ç»“æ„
 */
function completeUnitOfWork(unitOfWork: Fiber): Fiber | null {
  // ä¸º workInProgress å…¨å±€å˜é‡é‡æ–°èµ‹å€¼
  workInProgress = unitOfWork;
  do {
    // è·å–å¤‡ä»½èŠ‚ç‚¹
    // åˆå§‹åŒ–æ¸²æŸ“ éæ ¹ Fiber å¯¹è±¡æ²¡æœ‰å¤‡ä»½èŠ‚ç‚¹ æ‰€ä»¥ current ä¸º null
    const current = workInProgress.alternate;
    // çˆ¶çº§ Fiber å¯¹è±¡, éæ ¹ Fiber å¯¹è±¡éƒ½æœ‰çˆ¶çº§
    const returnFiber = workInProgress.return;
    // åˆ¤æ–­ä¼ å…¥çš„ Fiber å¯¹è±¡æ˜¯å¦æ„å»ºå®Œæˆ, ä»»åŠ¡è°ƒåº¦ç›¸å…³
    // &amp; æ˜¯è¡¨ç¤ºä½çš„ä¸è¿ç®—, æŠŠå·¦å³ä¸¤è¾¹çš„æ•°å­—è½¬åŒ–ä¸ºäºŒè¿›åˆ¶
    // ç„¶åæ¯ä¸€ä½åˆ†åˆ«è¿›è¡Œæ¯”è¾ƒ, å¦‚æœç›¸ç­‰å°±ä¸º1, ä¸ç›¸ç­‰å³ä¸º0
    // æ­¤å¤„åº”ç”¨&quot;ä½ä¸&quot;è¿ç®—ç¬¦çš„ç›®çš„æ˜¯&quot;æ¸…é›¶&quot;
    // true
    if ((workInProgress.effectTag &amp; Incomplete) === NoEffect) {
      let next;
      // å¦‚æœä¸èƒ½ä½¿ç”¨åˆ†æå™¨çš„ timer, ç›´æ¥æ‰§è¡Œ completeWork
      // enableProfilerTimer =&gt; true
      // ä½†æ­¤å¤„æ— è®ºæ¡ä»¶æ˜¯å¦æˆç«‹éƒ½ä¼šæ‰§è¡Œ completeWork
      if (
        !enableProfilerTimer ||
        (workInProgress.mode &amp; ProfileMode) === NoMode
      ) {
        // é‡ç‚¹ä»£ç (äºŒ)
        // åˆ›å»ºèŠ‚ç‚¹çœŸå® DOM å¯¹è±¡å¹¶å°†å…¶æ·»åŠ åˆ° stateNode å±æ€§ä¸­
        next = completeWork(current, workInProgress, renderExpirationTime);
      } else {
        // åˆ›å»ºèŠ‚ç‚¹çœŸå® DOM å¯¹è±¡å¹¶å°†å…¶æ·»åŠ åˆ° stateNode å±æ€§ä¸­
        next = completeWork(current, workInProgress, renderExpirationTime);
      }
      // é‡ç‚¹ä»£ç (ä¸€)
      // å¦‚æœå­çº§å­˜åœ¨
      if (next !== null) {
        // è¿”å›å­çº§ ä¸€ç›´è¿”å›åˆ° workLoopSync
        // å†é‡æ–°æ‰§è¡Œ performUnitOfWork æ„å»ºå­çº§ Fiber èŠ‚ç‚¹å¯¹è±¡
        return next;
      }

      // æ„å»º effect é“¾è¡¨ç»“æ„
      // å¦‚æœä¸æ˜¯æ ¹ Fiber å°±æ˜¯ true å¦åˆ™å°±æ˜¯ false
      // å°†å­æ ‘å’Œæ­¤ Fiber çš„æ‰€æœ‰ effect é™„åŠ åˆ°çˆ¶çº§çš„ effect åˆ—è¡¨ä¸­
      if (
        // å¦‚æœçˆ¶ Fiber å­˜åœ¨ å¹¶ä¸”
        returnFiber !== null &amp;&amp;
        // çˆ¶ Fiber å¯¹è±¡ä¸­çš„ effectTag ä¸º 0
        (returnFiber.effectTag &amp; Incomplete) === NoEffect
      ) {
        // å°†å­æ ‘å’Œæ­¤ Fiber çš„æ‰€æœ‰å‰¯ä½œç”¨é™„åŠ åˆ°çˆ¶çº§çš„ effect åˆ—è¡¨ä¸Š

        // ä»¥ä¸‹ä¸¤ä¸ªåˆ¤æ–­çš„ä½œç”¨æ˜¯æœé›†å­ Fiberçš„ effect åˆ°çˆ¶ Fiber
        if (returnFiber.firstEffect === null) {
          // first
          returnFiber.firstEffect = workInProgress.firstEffect;
        }

        if (workInProgress.lastEffect !== null) {
          if (returnFiber.lastEffect !== null) {
            // next
            returnFiber.lastEffect.nextEffect = workInProgress.firstEffect;
          }
          // last
          returnFiber.lastEffect = workInProgress.lastEffect;
        }

        // è·å–å‰¯ä½œç”¨æ ‡è®°
        // åˆå§‹æ¸²æŸ“æ—¶é™¤[æ ¹ç»„ä»¶]ä»¥å¤–çš„ Fiber, effectTag å€¼éƒ½ä¸º 0, å³ä¸éœ€è¦æ‰§è¡Œä»»ä½•çœŸå®DOMæ“ä½œ
        // æ ¹ç»„ä»¶çš„ effectTag å€¼ä¸º 3, å³éœ€è¦å°†æ­¤èŠ‚ç‚¹å¯¹åº”çš„çœŸå®DOMå¯¹è±¡æ·»åŠ åˆ°é¡µé¢ä¸­
        const effectTag = workInProgress.effectTag;

        // åˆ›å»º effect åˆ—è¡¨æ—¶è·³è¿‡ NoWork(0) å’Œ PerformedWork(1) æ ‡è®°
        // PerformedWork ç”± React DevTools è¯»å–, ä¸æäº¤
        // åˆå§‹æ¸²æŸ“æ—¶ åªæœ‰éå†åˆ°äº†æ ¹ç»„ä»¶ åˆ¤æ–­æ¡ä»¶æ‰èƒ½æˆç«‹, å°† effect é“¾è¡¨æ·»åŠ åˆ° rootFiber
        // åˆå§‹æ¸²æŸ“ FiberRoot å¯¹è±¡ä¸­çš„ firstEffect å’Œ lastEffect éƒ½æ˜¯ App ç»„ä»¶
        // å› ä¸ºå½“æ‰€æœ‰èŠ‚ç‚¹åœ¨å†…å­˜ä¸­æ„å»ºå®Œæˆå, åªéœ€è¦ä¸€æ¬¡å°†æ‰€æœ‰ DOM æ·»åŠ åˆ°é¡µé¢ä¸­
        if (effectTag &gt; PerformedWork) {
          // false
          if (returnFiber.lastEffect !== null) {
            returnFiber.lastEffect.nextEffect = workInProgress;
          } else {
            // ä¸º fiberRoot æ·»åŠ  firstEffect
            returnFiber.firstEffect = workInProgress;
          }
          // ä¸º fiberRoot æ·»åŠ  lastEffect
          returnFiber.lastEffect = workInProgress;
        }
      }
    } else {
    	// å¿½ç•¥äº†åˆå§‹æ¸²æŸ“ä¸æ‰§è¡Œçš„ä»£ç       
    }
    // è·å–ä¸‹ä¸€ä¸ªåŒçº§ Fiber å¯¹è±¡
    const siblingFiber = workInProgress.sibling;
    // å¦‚æœä¸‹ä¸€ä¸ªåŒçº§ Fiber å¯¹è±¡å­˜åœ¨
    if (siblingFiber !== null) {
      // è¿”å›ä¸‹ä¸€ä¸ªåŒçº§ Fiber å¯¹è±¡
      return siblingFiber;
    }
    // å¦åˆ™é€€å›çˆ¶çº§
    workInProgress = returnFiber;
  } while (workInProgress !== null);

  // å½“æ‰§è¡Œåˆ°è¿™é‡Œçš„æ—¶å€™, è¯´æ˜éå†åˆ°äº† root èŠ‚ç‚¹, å·²å®Œæˆéå†
  // æ›´æ–° workInProgressRootExitStatus çš„çŠ¶æ€ä¸º å·²å®Œæˆ
  if (workInProgressRootExitStatus === RootIncomplete) {
    workInProgressRootExitStatus = RootCompleted;
  }
  return null;
}
</code></pre></div><h5 id="_5-1-8-11-completework"><a href="#_5-1-8-11-completework" class="header-anchor">#</a> 5.1.8.11 completeWork</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberCompleteWork.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>function completeWork(
  current: Fiber | null,
  workInProgress: Fiber,
  renderExpirationTime: ExpirationTime,
): Fiber | null {
  // è·å–å¾…æ›´æ–° props
  const newProps = workInProgress.pendingProps;
  switch (workInProgress.tag) {
    // 0
    case FunctionComponent:
      return null;
    // 3
    case HostRoot: {
      updateHostContainer(workInProgress);
      return null;
    }
    // 5
    case HostComponent: {
      // è·å– rootDOM èŠ‚ç‚¹ &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;
      const rootContainerInstance = getRootHostContainer();
      // èŠ‚ç‚¹çš„å…·ä½“çš„ç±»å‹ div span ...
      const type = workInProgress.type;
      // false current = null
      if (current !== null &amp;&amp; workInProgress.stateNode != null) {
       // åˆå§‹æ¸²æŸ“ä¸æ‰§è¡Œ
      } else {
				// false
        if (wasHydrated) {
         // åˆå§‹æ¸²æŸ“ä¸æ‰§è¡Œ
        } else {
          // åˆ›å»ºèŠ‚ç‚¹å®ä¾‹å¯¹è±¡ &lt;div&gt;&lt;/div&gt; &lt;span&gt;&lt;/span&gt;
          let instance = createInstance(
            type,
            newProps,
            rootContainerInstance,
            currentHostContext,
            workInProgress,
          );
          /**
           * å°†æ‰€æœ‰çš„å­çº§è¿½åŠ åˆ°çˆ¶çº§ä¸­
           * instance ä¸ºçˆ¶çº§
           * workInProgress.child ä¸ºå­çº§
           */
          appendAllChildren(instance, workInProgress, false, false);
          // ä¸º Fiber å¯¹è±¡æ·»åŠ  stateNode å±æ€§
          workInProgress.stateNode = instance;
        }
        // å¤„ç† ref DOM å¼•ç”¨
        if (workInProgress.ref !== null) {
          markRef(workInProgress);
        }
      }
      return null;
    } 
  }
}
</code></pre></div><h5 id="_5-1-8-12-appendallchildren"><a href="#_5-1-8-12-appendallchildren" class="header-anchor">#</a> 5.1.8.12 appendAllChildren</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberCompleteWork.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>appendAllChildren = function (
    parent: Instance,
    workInProgress: Fiber,
    needsVisibilityToggle: boolean,
    isHidden: boolean,
  ) {
    // è·å–å­çº§
    let node = workInProgress.child;
    // å¦‚æœå­çº§ä¸ä¸ºç©º æ‰§è¡Œå¾ªç¯
    while (node !== null) {
      // å¦‚æœ node æ˜¯æ™®é€š ReactElement æˆ–è€…ä¸ºæ–‡æœ¬
      if (node.tag === HostComponent || node.tag === HostText) {
        // å°†å­çº§è¿½åŠ åˆ°çˆ¶çº§ä¸­
        appendInitialChild(parent, node.stateNode);
      } else if (node.child !== null) {
        // å¦‚æœ node ä¸æ˜¯æ™®é€š ReactElement åˆä¸æ˜¯æ–‡æœ¬
        // å°† node è§†ä¸ºç»„ä»¶, ç»„ä»¶æœ¬èº«ä¸èƒ½è½¬æ¢ä¸ºçœŸå® DOM å…ƒç´ 
        // è·å–åˆ°ç»„ä»¶çš„ç¬¬ä¸€ä¸ªå­å…ƒç´ , ç»§ç»­æ‰§è¡Œå¾ªç¯
        node.child.return = node;
        node = node.child;
        continue;
      }
      // å¦‚æœ node å’Œ workInProgress æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹
      // è¯´æ˜ node å·²ç»é€€å›åˆ°çˆ¶çº§ ç»ˆæ­¢å¾ªç¯
      // è¯´æ˜æ­¤æ—¶æ‰€æœ‰å­çº§éƒ½å·²ç»è¿½åŠ åˆ°çˆ¶çº§ä¸­äº†
      if (node === workInProgress) {
        return;
      }
      // å¤„ç†å­çº§èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹
      while (node.sibling === null) {
        // å¦‚æœèŠ‚ç‚¹æ²¡æœ‰çˆ¶çº§æˆ–è€…èŠ‚ç‚¹çš„çˆ¶çº§æ˜¯è‡ªå·±, é€€å‡ºå¾ªç¯
        // è¯´æ˜æ­¤æ—¶æ‰€æœ‰å­çº§éƒ½å·²ç»è¿½åŠ åˆ°çˆ¶çº§ä¸­äº†
        if (node.return === null || node.return === workInProgress) {
          return;
        }
        // æ›´æ–° node
        node = node.return;
      }
      // æ›´æ–°çˆ¶çº§ æ–¹ä¾¿å›é€€
      node.sibling.return = node.return;
      // å°† node æ›´æ–°ä¸ºä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹
      node = node.sibling;
    }
  };
</code></pre></div><h3 id="_5-2-commit-é˜¶æ®µ"><a href="#_5-2-commit-é˜¶æ®µ" class="header-anchor">#</a> 5.2 commit é˜¶æ®µ</h3> <h4 id="_5-2-1-finishsyncrender"><a href="#_5-2-1-finishsyncrender" class="header-anchor">#</a> 5.2.1 finishSyncRender</h4> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>function finishSyncRender(root) {
  // é”€æ¯ workInProgress Fiber æ ‘
  // å› ä¸ºå¾…æäº¤ Fiber å¯¹è±¡å·²ç»è¢«å­˜å‚¨åœ¨äº† root.finishedWork ä¸­
  workInProgressRoot = null;
  // è¿›å…¥ commit é˜¶æ®µ
  commitRoot(root);
}
</code></pre></div><h4 id="_5-2-2-commitroot"><a href="#_5-2-2-commitroot" class="header-anchor">#</a> 5.2.2 commitRoot</h4> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>function commitRoot(root) {
  // è·å–ä»»åŠ¡ä¼˜å…ˆçº§ 97 =&gt; æ™®é€šä¼˜å…ˆçº§
  const renderPriorityLevel = getCurrentPriorityLevel();
  // ä½¿ç”¨æœ€é«˜ä¼˜å…ˆçº§æ‰§è¡Œå½“å‰ä»»åŠ¡, å› ä¸º commit é˜¶æ®µä¸å¯ä»¥è¢«æ‰“æ–­
  // ImmediatePriority, ä¼˜å…ˆçº§ä¸º 99, æœ€é«˜ä¼˜å…ˆçº§
  runWithPriority(
    ImmediatePriority,
    commitRootImpl.bind(null, root, renderPriorityLevel),
  );
  return null;
}
</code></pre></div><h4 id="_5-2-3-commitrootimpl"><a href="#_5-2-3-commitrootimpl" class="header-anchor">#</a> 5.2.3 commitRootImpl</h4> <p>commit é˜¶æ®µå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªå­é˜¶æ®µï¼š</p> <ul><li>before mutation é˜¶æ®µï¼ˆæ‰§è¡Œ DOM æ“ä½œå‰ï¼‰</li> <li>mutation é˜¶æ®µï¼ˆæ‰§è¡Œ DOM æ“ä½œï¼‰</li> <li>layout é˜¶æ®µï¼ˆæ‰§è¡Œ DOM æ“ä½œåï¼‰</li></ul> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>function commitRootImpl(root, renderPriorityLevel) {
  // è·å–å¾…æäº¤ Fiber å¯¹è±¡ rootFiber
  const finishedWork = root.finishedWork;
  // å¦‚æœæ²¡æœ‰ä»»åŠ¡è¦æ‰§è¡Œ
  if (finishedWork === null) {
    // é˜»æ­¢ç¨‹åºç»§ç»­å‘ä¸‹æ‰§è¡Œ
    return null;
  }
  // é‡ç½®ä¸ºé»˜è®¤å€¼
  root.finishedWork = null;
  root.callbackNode = null;
  root.callbackExpirationTime = NoWork;
  root.callbackPriority = NoPriority;
  root.nextKnownPendingLevel = NoWork;
  
  // è·å–è¦æ‰§è¡Œ DOM æ“ä½œçš„å‰¯ä½œç”¨åˆ—è¡¨
  let firstEffect = finishedWork.firstEffect;

  // true
  if (firstEffect !== null) {
    // commit ç¬¬ä¸€ä¸ªå­é˜¶æ®µ
    nextEffect = firstEffect;
    // å¤„ç†ç±»ç»„ä»¶çš„ getSnapShotBeforeUpdate ç”Ÿå‘½å‘¨æœŸå‡½æ•°
    do {
      invokeGuardedCallback(null, commitBeforeMutationEffects, null);
    } while (nextEffect !== null);
    
		// commit ç¬¬äºŒä¸ªå­é˜¶æ®µ
    nextEffect = firstEffect;
    do {
      invokeGuardedCallback(null, commitMutationEffects, null, root, renderPriorityLevel);
    } while (nextEffect !== null);
    // å°† workInProgress Fiber æ ‘å˜æˆ current Fiber æ ‘
    root.current = finishedWork;
    
		// commit ç¬¬ä¸‰ä¸ªå­é˜¶æ®µ
    nextEffect = firstEffect;
    do {
      invokeGuardedCallback(null, commitLayoutEffects, null, root,expirationTime);
    } while (nextEffect !== null);
		
    // é‡ç½® nextEffect
    nextEffect = null;
  }
}
</code></pre></div><h4 id="_5-2-4-ç¬¬ä¸€å­é˜¶æ®µ"><a href="#_5-2-4-ç¬¬ä¸€å­é˜¶æ®µ" class="header-anchor">#</a> 5.2.4 ç¬¬ä¸€å­é˜¶æ®µ</h4> <h5 id="_5-2-4-1-commitbeforemutationeffects"><a href="#_5-2-4-1-commitbeforemutationeffects" class="header-anchor">#</a> 5.2.4.1 commitBeforeMutationEffects</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>// commit é˜¶æ®µçš„ç¬¬ä¸€ä¸ªå­é˜¶æ®µ
// è°ƒç”¨ç±»ç»„ä»¶çš„ getSnapshotBeforeUpdate ç”Ÿå‘½å‘¨æœŸå‡½æ•°
function commitBeforeMutationEffects() {
  // å¾ªç¯ effect é“¾
  while (nextEffect !== null) {
    // nextEffect æ˜¯ effect é“¾ä¸Šä» firstEffect åˆ° lastEffec çš„æ¯ä¸€ä¸ªéœ€è¦commitçš„ fiber å¯¹è±¡

    // åˆå§‹åŒ–æ¸²æŸ“ç¬¬ä¸€ä¸ª nextEffect ä¸º App ç»„ä»¶
    // effectTag =&gt; 3
    const effectTag = nextEffect.effectTag;
    // console.log(effectTag);
    // nextEffect = null;
    // return;

    // å¦‚æœ fiber å¯¹è±¡ä¸­é‡Œæœ‰ Snapshot è¿™ä¸ª effectTag çš„è¯
    // Snapshot å’Œæ›´æ–°æœ‰å…³ç³» åˆå§‹åŒ–æ¸²æŸ“ ä¸æ‰§è¡Œ
    // false
    if ((effectTag &amp; Snapshot) !== NoEffect) {
      // è·å–å½“å‰ fiber èŠ‚ç‚¹
      const current = nextEffect.alternate;
      // å½“ nextEffect ä¸Šæœ‰ Snapshot è¿™ä¸ª effectTag æ—¶
      // æ‰§è¡Œä»¥ä¸‹æ–¹æ³•, ä¸»è¦æ˜¯ç±»ç»„ä»¶è°ƒç”¨ getSnapshotBeforeUpdate ç”Ÿå‘½å‘¨æœŸå‡½æ•°
      commitBeforeMutationEffectOnFiber(current, nextEffect);
    }
    // æ›´æ–°å¾ªç¯æ¡ä»¶
    nextEffect = nextEffect.nextEffect;
  }
}
</code></pre></div><h5 id="_5-2-4-2-commitbeforemutationlifecycles"><a href="#_5-2-4-2-commitbeforemutationlifecycles" class="header-anchor">#</a> 5.2.4.2 commitBeforeMutationLifeCycles</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>function commitBeforeMutationLifeCycles(
  current: Fiber | null,
  finishedWork: Fiber,
): void {
  switch (finishedWork.tag) {
    case FunctionComponent:
    case ForwardRef:
    case SimpleMemoComponent:
    case Block: {
      return;
    }
    // å¦‚æœè¯¥ fiber ç±»å‹æ˜¯ ClassComponent
    case ClassComponent: {
      if (finishedWork.effectTag &amp; Snapshot) {
        if (current !== null) {
          // æ—§çš„ props
          const prevProps = current.memoizedProps;
          // æ—§çš„ state
          const prevState = current.memoizedState;
          // è·å– classComponent ç»„ä»¶çš„å®ä¾‹å¯¹è±¡
          const instance = finishedWork.stateNode;
          // æ‰§è¡Œ getSnapshotBeforeUpdate ç”Ÿå‘½å‘¨æœŸå‡½æ•°
          // åœ¨ç»„ä»¶æ›´æ–°å‰æ•è·ä¸€äº› DOM ä¿¡æ¯
          // è¿”å›è‡ªå®šä¹‰çš„å€¼æˆ– null, ç»Ÿç§°ä¸º snapshot
          const snapshot = instance.getSnapshotBeforeUpdate(
            finishedWork.elementType === finishedWork.type
              ? prevProps
              : resolveDefaultProps(finishedWork.type, prevProps),
            prevState,
          );
        }
      }
      return;
    }
    case HostRoot:
    case HostComponent:
    case HostText:
    case HostPortal:
    case IncompleteClassComponent:
      // Nothing to do for these component types
      return;
  }
}
</code></pre></div><h4 id="_5-2-5-ç¬¬äºŒå­é˜¶æ®µ"><a href="#_5-2-5-ç¬¬äºŒå­é˜¶æ®µ" class="header-anchor">#</a> 5.2.5 ç¬¬äºŒå­é˜¶æ®µ</h4> <h5 id="_5-2-5-1-commitmutationeffects"><a href="#_5-2-5-1-commitmutationeffects" class="header-anchor">#</a> 5.2.5.1 commitMutationEffects</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>// commit é˜¶æ®µçš„ç¬¬äºŒä¸ªå­é˜¶æ®µ
// æ ¹æ® effectTag æ‰§è¡Œ DOM æ“ä½œ
function commitMutationEffects(root: FiberRoot, renderPriorityLevel) {
  // å¾ªç¯ effect é“¾
  while (nextEffect !== null) {
    // è·å– effectTag
    // åˆå§‹æ¸²æŸ“ç¬¬ä¸€æ¬¡å¾ªç¯ä¸º App ç»„ä»¶
    // å³å°†æ ¹ç»„ä»¶åŠå†…éƒ¨æ‰€æœ‰å†…å®¹ä¸€æ¬¡æ€§æ·»åŠ åˆ°é¡µé¢ä¸­
    const effectTag = nextEffect.effectTag;

    // æ ¹æ® effectTag åˆ†åˆ«å¤„ç†
    let primaryEffectTag =
      effectTag &amp; (Placement | Update | Deletion | Hydrating);
    // åŒ¹é… effectTag
    // åˆå§‹æ¸²æŸ“ primaryEffectTag ä¸º 2 åŒ¹é…åˆ° Placement
    switch (primaryEffectTag) {
      // é’ˆå¯¹è¯¥èŠ‚ç‚¹åŠå­èŠ‚ç‚¹è¿›è¡Œæ’å…¥æ“ä½œ
      case Placement: {
        commitPlacement(nextEffect);
        // effectTag ä» 3 å˜ä¸º 1
        // ä» effect æ ‡ç­¾ä¸­æ¸…é™¤ &quot;placement&quot; é‡ç½® effectTag å€¼
        // ä»¥ä¾¿æˆ‘ä»¬çŸ¥é“åœ¨è°ƒç”¨è¯¸å¦‚componentDidMountä¹‹ç±»çš„ä»»ä½•ç”Ÿå‘½å‘¨æœŸä¹‹å‰å·²å°†å…¶æ’å…¥ã€‚
        nextEffect.effectTag &amp;= ~Placement;
        break;
      }
      // æ’å…¥å¹¶æ›´æ–° DOM
      case PlacementAndUpdate: {
        // æ’å…¥
        commitPlacement(nextEffect);
        nextEffect.effectTag &amp;= ~Placement;

        // æ›´æ–°
        const current = nextEffect.alternate;
        commitWork(current, nextEffect);
        break;
      }
      // æœåŠ¡å™¨ç«¯æ¸²æŸ“
      case Hydrating: {
        nextEffect.effectTag &amp;= ~Hydrating;
        break;
      }
      // æœåŠ¡å™¨ç«¯æ¸²æŸ“
      case HydratingAndUpdate: {
        nextEffect.effectTag &amp;= ~Hydrating;

        // Update
        const current = nextEffect.alternate;
        commitWork(current, nextEffect);
        break;
      }
      // æ›´æ–° DOM
      case Update: {
        const current = nextEffect.alternate;
        commitWork(current, nextEffect);
        break;
      }
      // åˆ é™¤ DOM
      case Deletion: {
        commitDeletion(root, nextEffect, renderPriorityLevel);
        break;
      }
    }
    nextEffect = nextEffect.nextEffect;
  }
}
</code></pre></div><h5 id="_5-2-5-2-commitplacement"><a href="#_5-2-5-2-commitplacement" class="header-anchor">#</a> 5.2.5.2 commitPlacement</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>// æŒ‚è½½ DOM å…ƒç´ 
function commitPlacement(finishedWork: Fiber): void {
  // finishedWork åˆå§‹åŒ–æ¸²æŸ“æ—¶ä¸ºæ ¹ç»„ä»¶ Fiber å¯¹è±¡
  // è·å–éç»„ä»¶çˆ¶çº§ Fiber å¯¹è±¡
  // åˆå§‹æ¸²æŸ“æ—¶ä¸º &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;
  const parentFiber = getHostParentFiber(finishedWork);

  // å­˜å‚¨çœŸæ­£çš„çˆ¶çº§ DOM èŠ‚ç‚¹å¯¹è±¡
  let parent;
  // æ˜¯å¦ä¸ºæ¸²æŸ“å®¹å™¨
  // æ¸²æŸ“å®¹å™¨å’Œæ™®é€šreactå…ƒç´ çš„ä¸»è¦åŒºåˆ«åœ¨äºæ˜¯å¦éœ€è¦ç‰¹æ®Šå¤„ç†æ³¨é‡ŠèŠ‚ç‚¹
  let isContainer;
  // è·å–çˆ¶çº§ DOM èŠ‚ç‚¹å¯¹è±¡
  // ä½†æ˜¯åˆå§‹æ¸²æŸ“æ—¶ rootFiber å¯¹è±¡ä¸­çš„ stateNode å­˜å‚¨çš„æ˜¯ FiberRoot
  const parentStateNode = parentFiber.stateNode;
  // åˆ¤æ–­çˆ¶èŠ‚ç‚¹çš„ç±»å‹
  // åˆå§‹æ¸²æŸ“æ—¶æ˜¯ hostRoot 3
  switch (parentFiber.tag) {
    case HostComponent:
      parent = parentStateNode;
      isContainer = false;
      break;
    case HostRoot:
      // è·å–çœŸæ­£çš„ DOM èŠ‚ç‚¹å¯¹è±¡
      // &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;
      parent = parentStateNode.containerInfo;
      // æ˜¯ container å®¹å™¨
      isContainer = true;
      break;
    case HostPortal:
      parent = parentStateNode.containerInfo;
      isContainer = true;
      break;
    case FundamentalComponent:
      if (enableFundamentalAPI) {
        parent = parentStateNode.instance;
        isContainer = false;
      }
  }
  // æŸ¥çœ‹å½“å‰èŠ‚ç‚¹æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹
  // æœ‰, æ‰§è¡Œ insertBefore
  // æ²¡æœ‰, æ‰§è¡Œ appendChild
  const before = getHostSibling(finishedWork);
	// æ¸²æŸ“å®¹å™¨
  if (isContainer) {
    // å‘çˆ¶èŠ‚ç‚¹ä¸­è¿½åŠ èŠ‚ç‚¹ æˆ–è€… å°†å­èŠ‚ç‚¹æ’å…¥åˆ° before èŠ‚ç‚¹çš„å‰é¢
    insertOrAppendPlacementNodeIntoContainer(finishedWork, before, parent);
  } else {
    // éæ¸²æŸ“å®¹å™¨
    // å‘çˆ¶èŠ‚ç‚¹ä¸­è¿½åŠ èŠ‚ç‚¹ æˆ–è€… å°†å­èŠ‚ç‚¹æ’å…¥åˆ° before èŠ‚ç‚¹çš„å‰é¢
    insertOrAppendPlacementNode(finishedWork, before, parent);
  }
}
</code></pre></div><h5 id="_5-2-5-3-gethostparentfiber"><a href="#_5-2-5-3-gethostparentfiber" class="header-anchor">#</a> 5.2.5.3 getHostParentFiber</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>// è·å– HostRootFiber å¯¹è±¡
function getHostParentFiber(fiber: Fiber): Fiber {
  // è·å–å½“å‰ Fiber çˆ¶çº§
  let parent = fiber.return;
  // æŸ¥çœ‹çˆ¶çº§æ˜¯å¦ä¸º null
  while (parent !== null) {
    // æŸ¥çœ‹çˆ¶çº§æ˜¯å¦ä¸º hostRoot
    if (isHostParent(parent)) {
      // è¿”å›
      return parent;
    }
    // ç»§ç»­å‘ä¸ŠæŸ¥æ‰¾
    parent = parent.return;
  }
}
</code></pre></div><h5 id="_5-2-5-4-insertorappendplacementnodeintocontainer"><a href="#_5-2-5-4-insertorappendplacementnodeintocontainer" class="header-anchor">#</a> 5.2.5.4 insertOrAppendPlacementNodeIntoContainer</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>// å‘å®¹å™¨ä¸­è¿½åŠ  | æ’å…¥åˆ°æŸä¸€ä¸ªèŠ‚ç‚¹çš„å‰é¢
function insertOrAppendPlacementNodeIntoContainer(
  node: Fiber,
  before: ?Instance,
  parent: Container,
): void {
  const {tag} = node;
  // å¦‚æœå¾…æ’å…¥çš„èŠ‚ç‚¹æ˜¯ä¸€ä¸ª DOM å…ƒç´ æˆ–è€…æ–‡æœ¬çš„è¯
  // æ¯”å¦‚ ç»„ä»¶fiber =&gt; false div =&gt; true
  const isHost = tag === HostComponent || tag === HostText;

  if (isHost || (enableFundamentalAPI &amp;&amp; tag === FundamentalComponent)) {
    // è·å– DOM èŠ‚ç‚¹
    const stateNode = isHost ? node.stateNode : node.stateNode.instance;
    // å¦‚æœ before å­˜åœ¨
    if (before) {
      // æ’å…¥åˆ° before å‰é¢
      insertInContainerBefore(parent, stateNode, before);
    } else {
      // è¿½åŠ åˆ°çˆ¶å®¹å™¨ä¸­
      appendChildToContainer(parent, stateNode);
    }
  } else {
    // å¦‚æœæ˜¯ç»„ä»¶èŠ‚ç‚¹, æ¯”å¦‚ ClassComponent, åˆ™æ‰¾å®ƒçš„ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹(DOM å…ƒç´ )
    // è¿›è¡Œæ’å…¥æ“ä½œ
    const child = node.child;
    if (child !== null) {
      // å‘çˆ¶çº§ä¸­è¿½åŠ å­èŠ‚ç‚¹æˆ–è€…å°†å­èŠ‚ç‚¹æ’å…¥åˆ° before çš„å‰é¢
      insertOrAppendPlacementNodeIntoContainer(child, before, parent);
      // è·å–ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹
      let sibling = child.sibling;
      // å¦‚æœå…„å¼ŸèŠ‚ç‚¹å­˜åœ¨
      while (sibling !== null) {
        // å‘çˆ¶çº§ä¸­è¿½åŠ å­èŠ‚ç‚¹æˆ–è€…å°†å­èŠ‚ç‚¹æ’å…¥åˆ° before çš„å‰é¢
        insertOrAppendPlacementNodeIntoContainer(sibling, before, parent);
        // åŒæ­¥å…„å¼ŸèŠ‚ç‚¹
        sibling = sibling.sibling;
      }
    }
  }
}
</code></pre></div><h5 id="_5-2-5-5-insertincontainerbefore"><a href="#_5-2-5-5-insertincontainerbefore" class="header-anchor">#</a> 5.2.5.5 insertInContainerBefore</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-dom/src/client/ReactDOMHostConfig.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>export function insertInContainerBefore(
  container: Container,
  child: Instance | TextInstance,
  beforeChild: Instance | TextInstance | SuspenseInstance,
): void {
  // å¦‚æœçˆ¶å®¹å™¨æ˜¯æ³¨é‡ŠèŠ‚ç‚¹
  if (container.nodeType === COMMENT_NODE) {
    // æ‰¾åˆ°æ³¨é‡ŠèŠ‚ç‚¹çš„çˆ¶çº§èŠ‚ç‚¹ å› ä¸ºæ³¨é‡ŠèŠ‚ç‚¹æ²¡æ³•è°ƒç”¨ insertBefore
    (container.parentNode: any).insertBefore(child, beforeChild);
  } else {
    // å°† child æ’å…¥åˆ° beforeChild çš„å‰é¢
    container.insertBefore(child, beforeChild);
  }
}
</code></pre></div><h5 id="_5-2-5-6-appendchildtocontainer"><a href="#_5-2-5-6-appendchildtocontainer" class="header-anchor">#</a> 5.2.5.6 appendChildToContainer</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-dom/src/client/ReactDOMHostConfig.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>export function appendChildToContainer(
  container: Container,
  child: Instance | TextInstance,
): void {
  // ç›‘æµ‹ container æ˜¯å¦æ³¨é‡ŠèŠ‚ç‚¹
  if (container.nodeType === COMMENT_NODE) {
    // è·å–çˆ¶çº§çš„çˆ¶çº§
    parentNode = (container.parentNode: any);
    // å°†å­çº§èŠ‚ç‚¹æ’å…¥åˆ°æ³¨é‡ŠèŠ‚ç‚¹çš„å‰é¢
    parentNode.insertBefore(child, container);
  } else {
    // ç›´æ¥å°† child æ’å…¥åˆ°çˆ¶çº§ä¸­
    parentNode = container;
    parentNode.appendChild(child);
  }
}
</code></pre></div><h4 id="_5-2-6-ç¬¬ä¸‰å­é˜¶æ®µ"><a href="#_5-2-6-ç¬¬ä¸‰å­é˜¶æ®µ" class="header-anchor">#</a> 5.2.6 ç¬¬ä¸‰å­é˜¶æ®µ</h4> <h5 id="_5-2-6-1-commitlayouteffects"><a href="#_5-2-6-1-commitlayouteffects" class="header-anchor">#</a> 5.2.6.1 commitLayoutEffects</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>// commit é˜¶æ®µçš„ç¬¬ä¸‰ä¸ªå­é˜¶æ®µ
function commitLayoutEffects(
  root: FiberRoot,
  committedExpirationTime: ExpirationTime,
) {
  while (nextEffect !== null) {
    // æ­¤æ—¶ effectTag å·²ç»è¢«é‡ç½®ä¸º 1, è¡¨ç¤º DOM æ“ä½œå·²ç»å®Œæˆ
    const effectTag = nextEffect.effectTag;
    // è°ƒç”¨ç”Ÿå‘½å‘¨æœŸå‡½æ•°å’Œé’©å­å‡½æ•°
    // å‰ææ˜¯ç±»ç»„ä»¶ä¸­è°ƒç”¨äº†ç”Ÿå‘½å‘¨æœŸå‡½æ•° æˆ–è€…å‡½æ•°ç»„ä»¶ä¸­è°ƒç”¨äº† useEffect
    if (effectTag &amp; (Update | Callback)) {
      // ç±»ç»„ä»¶å¤„ç†ç”Ÿå‘½å‘¨æœŸå‡½æ•°
      // å‡½æ•°ç»„ä»¶å¤„ç†é’©å­å‡½æ•°
      commitLayoutEffectOnFiber(root, current,nextEffect, committedExpirationTime);
    }
    // æ›´æ–°å¾ªç¯æ¡ä»¶
    nextEffect = nextEffect.nextEffect;
  }
}
</code></pre></div><h5 id="_5-2-6-2-commitlifecycles"><a href="#_5-2-6-2-commitlifecycles" class="header-anchor">#</a> 5.2.6.2 commitLifeCycles</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>function commitLifeCycles(
  finishedRoot: FiberRoot,
  current: Fiber | null,
  finishedWork: Fiber,
  committedExpirationTime: ExpirationTime,
): void {
  switch (finishedWork.tag) {
    case FunctionComponent: {
      // å¤„ç†é’©å­å‡½æ•°
      commitHookEffectListMount(HookLayout | HookHasEffect, finishedWork);
      return;
    }
    case ClassComponent: {
      // è·å–ç±»ç»„ä»¶å®ä¾‹å¯¹è±¡
      const instance = finishedWork.stateNode;
      // å¦‚æœåœ¨ç±»ç»„ä»¶ä¸­å­˜åœ¨ç”Ÿå‘½å‘¨æœŸå‡½æ•°åˆ¤æ–­æ¡ä»¶å°±ä¼šæˆç«‹
      if (finishedWork.effectTag &amp; Update) {
        // åˆå§‹æ¸²æŸ“é˜¶æ®µ
        if (current === null) {
          // è°ƒç”¨ componentDidMount ç”Ÿå‘½å‘¨æœŸå‡½æ•°
          instance.componentDidMount();
        } else {
          // æ›´æ–°é˜¶æ®µ
          // è·å–æ—§çš„ props
          const prevProps = finishedWork.elementType === finishedWork.type
              ? current.memoizedProps
              : resolveDefaultProps(finishedWork.type, current.memoizedProps);
          // è·å–æ—§çš„ state
          const prevState = current.memoizedState;
          // è°ƒç”¨ componentDidUpdate ç”Ÿå‘½å‘¨æœŸå‡½æ•°
          // instance.__reactInternalSnapshotBeforeUpdate å¿«ç…§ getSnapShotBeforeUpdate æ–¹æ³•çš„è¿”å›å€¼
          instance.componentDidUpdate(prevProps, prevState, instance.__reactInternalSnapshotBeforeUpdate);
        }
      }
      // è·å–ä»»åŠ¡é˜Ÿåˆ—
      const updateQueue = finishedWork.updateQueue;
      // å¦‚æœä»»åŠ¡é˜Ÿåˆ—å­˜åœ¨
      if (updateQueue !== null) {
        /**
         * è°ƒç”¨ ReactElement æ¸²æŸ“å®Œæˆä¹‹åçš„å›è°ƒå‡½æ•°
         * å³ render æ–¹æ³•çš„ç¬¬ä¸‰ä¸ªå‚æ•°
         */
        commitUpdateQueue(finishedWork, updateQueue, instance);
      }
      return;
    }
}
</code></pre></div><h5 id="_5-2-6-3-commitupdatequeue"><a href="#_5-2-6-3-commitupdatequeue" class="header-anchor">#</a> 5.2.6.3 commitUpdateQueue</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactUpdateQueue.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>/**
 * æ‰§è¡Œæ¸²æŸ“å®Œæˆä¹‹åçš„å›è°ƒå‡½æ•°
 */
export function commitUpdateQueue&lt;State&gt;(
  finishedWork: Fiber,
  finishedQueue: UpdateQueue&lt;State&gt;,
  instance: any,
): void {
  // effects ä¸ºæ•°ç»„, å­˜å‚¨ä»»åŠ¡å¯¹è±¡ (Update å¯¹è±¡)
  // ä½†å‰ææ˜¯åœ¨è°ƒç”¨ render æ–¹æ³•æ—¶ä¼ é€’äº†å›è°ƒå‡½æ•°, å°±æ˜¯ render æ–¹æ³•çš„ç¬¬ä¸‰ä¸ªå‚æ•°
  const effects = finishedQueue.effects;
  // é‡ç½® finishedQueue.effects æ•°ç»„
  finishedQueue.effects = null;
  // å¦‚æœä¼ é€’äº† render æ–¹æ³•çš„ç¬¬ä¸‰ä¸ªå‚æ•°, effect æ•°ç»„å°±ä¸ä¼šä¸º null
  if (effects !== null) {
    // éå† effect æ•°ç»„
    for (let i = 0; i &lt; effects.length; i++) {
      // è·å–æ•°ç»„ä¸­çš„ç¬¬ i ä¸ªéœ€è¦æ‰§è¡Œçš„ effect
      const effect = effects[i];
      // è·å– callback å›è°ƒå‡½æ•°
      const callback = effect.callback;
      // å¦‚æœå›è°ƒå‡½æ•°ä¸ä¸º null
      if (callback !== null) {
        // æ¸…ç©º effect ä¸­çš„ callback
        effect.callback = null;
        // æ‰§è¡Œå›è°ƒå‡½æ•°
        callCallback(callback, instance);
      }
    }
  }
}
</code></pre></div><h5 id="_5-2-6-4-commithookeffectlistmount"><a href="#_5-2-6-4-commithookeffectlistmount" class="header-anchor">#</a> 5.2.6.4 commitHookEffectListMount</h5> <p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p> <div class="language-react extra-class"><pre class="language-text"><code>/**
 * useEffect å›è°ƒå‡½æ•°è°ƒç”¨
 */
function commitHookEffectListMount(tag: number, finishedWork: Fiber) {
  // è·å–ä»»åŠ¡é˜Ÿåˆ—
  const updateQueue: FunctionComponentUpdateQueue | null = (finishedWork.updateQueue: any);
  // è·å– lastEffect
  let lastEffect = updateQueue !== null ? updateQueue.lastEffect : null;
  // å¦‚æœ lastEffect ä¸ä¸º null
  if (lastEffect !== null) {
    // è·å–è¦æ‰§è¡Œçš„å‰¯ä½œç”¨
    const firstEffect = lastEffect.next;
    let effect = firstEffect;
    // é€šè¿‡éå†çš„æ–¹å¼è°ƒç”¨ useEffect ä¸­çš„å›è°ƒå‡½æ•°
    // åœ¨ç»„ä»¶ä¸­å®šä¹‰äº†è°ƒç”¨äº†å‡ æ¬¡ useEffect éå†å°±ä¼šæ‰§è¡Œå‡ æ¬¡
    do {
      if ((effect.tag &amp; tag) === tag) {
        // Mount
        const create = effect.create;
        // create å°±æ˜¯ useEffect æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°
        // è¿”å›å€¼å°±æ˜¯æ¸…ç†å‡½æ•°
        effect.destroy = create();
      }
      // æ›´æ–°å¾ªç¯æ¡ä»¶
      effect = effect.next;
    } while (effect !== firstEffect);
  }
}
</code></pre></div></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">10/13/2022, 1:55:02 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/blog/web/react/03-fiber.html" class="prev">
          React-- Fiber
        </a></span> <span class="next"><a href="/blog/web/react/05-redux.html">
          React-- Redux
        </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-2c0089e8><li class="level-2" data-v-2c0089e8><a href="/blog/web/react/04-core-source-code.html#_1-é…ç½®-react-æºç æœ¬åœ°è°ƒè¯•ç¯å¢ƒ" class="sidebar-link reco-side-_1-é…ç½®-react-æºç æœ¬åœ°è°ƒè¯•ç¯å¢ƒ" data-v-2c0089e8>1. é…ç½® React æºç æœ¬åœ°è°ƒè¯•ç¯å¢ƒ</a></li><li class="level-2" data-v-2c0089e8><a href="/blog/web/react/04-core-source-code.html#_2-åˆ›å»º-react-å…ƒç´ " class="sidebar-link reco-side-_2-åˆ›å»º-react-å…ƒç´ " data-v-2c0089e8>2. åˆ›å»º React å…ƒç´ </a></li><li class="level-3" data-v-2c0089e8><a href="/blog/web/react/04-core-source-code.html#_2-1-createelement" class="sidebar-link reco-side-_2-1-createelement" data-v-2c0089e8>2.1 createElement</a></li><li class="level-3" data-v-2c0089e8><a href="/blog/web/react/04-core-source-code.html#_2-2-reactelement" class="sidebar-link reco-side-_2-2-reactelement" data-v-2c0089e8>2.2 ReactElement</a></li><li class="level-3" data-v-2c0089e8><a href="/blog/web/react/04-core-source-code.html#_2-3-hasvalidref" class="sidebar-link reco-side-_2-3-hasvalidref" data-v-2c0089e8>2.3 hasValidRef</a></li><li class="level-3" data-v-2c0089e8><a href="/blog/web/react/04-core-source-code.html#_2-4-hasvalidkey" class="sidebar-link reco-side-_2-4-hasvalidkey" data-v-2c0089e8>2.4 hasValidKey</a></li><li class="level-3" data-v-2c0089e8><a href="/blog/web/react/04-core-source-code.html#_2-5-isvalidelement" class="sidebar-link reco-side-_2-5-isvalidelement" data-v-2c0089e8>2.5 isValidElement</a></li><li class="level-3" data-v-2c0089e8><a href="/blog/web/react/04-core-source-code.html#_2-6-definekeypropwarninggetter" class="sidebar-link reco-side-_2-6-definekeypropwarninggetter" data-v-2c0089e8>2.6 defineKeyPropWarningGetter</a></li><li class="level-3" data-v-2c0089e8><a href="/blog/web/react/04-core-source-code.html#_2-7-definerefpropwarninggetter" class="sidebar-link reco-side-_2-7-definerefpropwarninggetter" data-v-2c0089e8>2.7 defineRefPropWarningGetter</a></li><li class="level-2" data-v-2c0089e8><a href="/blog/web/react/04-core-source-code.html#_3-react-æ¶æ„" class="sidebar-link reco-side-_3-react-æ¶æ„" data-v-2c0089e8>3. React æ¶æ„</a></li><li class="level-3" data-v-2c0089e8><a href="/blog/web/react/04-core-source-code.html#_3-1-scheduler-è°ƒåº¦å±‚" class="sidebar-link reco-side-_3-1-scheduler-è°ƒåº¦å±‚" data-v-2c0089e8>3.1 Scheduler è°ƒåº¦å±‚</a></li><li class="level-3" data-v-2c0089e8><a href="/blog/web/react/04-core-source-code.html#_3-2-reconciler-åè°ƒå±‚" class="sidebar-link reco-side-_3-2-reconciler-åè°ƒå±‚" data-v-2c0089e8>3.2 Reconciler åè°ƒå±‚</a></li><li class="level-3" data-v-2c0089e8><a href="/blog/web/react/04-core-source-code.html#_3-3-renderer-æ¸²æŸ“å±‚" class="sidebar-link reco-side-_3-3-renderer-æ¸²æŸ“å±‚" data-v-2c0089e8>3.3 Renderer æ¸²æŸ“å±‚</a></li><li class="level-2" data-v-2c0089e8><a href="/blog/web/react/04-core-source-code.html#_4-æ•°æ®ç»“æ„" class="sidebar-link reco-side-_4-æ•°æ®ç»“æ„" data-v-2c0089e8>4. æ•°æ®ç»“æ„</a></li><li class="level-3" data-v-2c0089e8><a href="/blog/web/react/04-core-source-code.html#_4-1-fiber" class="sidebar-link reco-side-_4-1-fiber" data-v-2c0089e8>4.1 Fiber</a></li><li class="level-3" data-v-2c0089e8><a href="/blog/web/react/04-core-source-code.html#_4-2-worktag" class="sidebar-link reco-side-_4-2-worktag" data-v-2c0089e8>4.2 WorkTag</a></li><li class="level-3" data-v-2c0089e8><a href="/blog/web/react/04-core-source-code.html#_4-3-typeofmode" class="sidebar-link reco-side-_4-3-typeofmode" data-v-2c0089e8>4.3 TypeOfMode</a></li><li class="level-3" data-v-2c0089e8><a href="/blog/web/react/04-core-source-code.html#_4-3-sideeffecttag" class="sidebar-link reco-side-_4-3-sideeffecttag" data-v-2c0089e8>4.3 SideEffectTag</a></li><li class="level-3" data-v-2c0089e8><a href="/blog/web/react/04-core-source-code.html#_4-4-update" class="sidebar-link reco-side-_4-4-update" data-v-2c0089e8>4.4 Update</a></li><li class="level-3" data-v-2c0089e8><a href="/blog/web/react/04-core-source-code.html#_4-5-updatequeue" class="sidebar-link reco-side-_4-5-updatequeue" data-v-2c0089e8>4.5 UpdateQueue</a></li><li class="level-3" data-v-2c0089e8><a href="/blog/web/react/04-core-source-code.html#_4-6-roottag" class="sidebar-link reco-side-_4-6-roottag" data-v-2c0089e8>4.6 RootTag</a></li><li class="level-3" data-v-2c0089e8><a href="/blog/web/react/04-core-source-code.html#_4-7-åŒç¼“å­˜æŠ€æœ¯" class="sidebar-link reco-side-_4-7-åŒç¼“å­˜æŠ€æœ¯" data-v-2c0089e8>4.7 åŒç¼“å­˜æŠ€æœ¯</a></li><li class="level-3" data-v-2c0089e8><a href="/blog/web/react/04-core-source-code.html#_4-8-åŒºåˆ†-fiberroot-ä¸-rootfiber" class="sidebar-link reco-side-_4-8-åŒºåˆ†-fiberroot-ä¸-rootfiber" data-v-2c0089e8>4.8 åŒºåˆ† fiberRoot ä¸ rootFiber</a></li><li class="level-2" data-v-2c0089e8><a href="/blog/web/react/04-core-source-code.html#_5-åˆå§‹åŒ–æ¸²æŸ“" class="sidebar-link reco-side-_5-åˆå§‹åŒ–æ¸²æŸ“" data-v-2c0089e8>5. åˆå§‹åŒ–æ¸²æŸ“</a></li><li class="level-3" data-v-2c0089e8><a href="/blog/web/react/04-core-source-code.html#_5-1-render-é˜¶æ®µ" class="sidebar-link reco-side-_5-1-render-é˜¶æ®µ" data-v-2c0089e8>5.1 render é˜¶æ®µ</a></li><li class="level-3" data-v-2c0089e8><a href="/blog/web/react/04-core-source-code.html#_5-2-commit-é˜¶æ®µ" class="sidebar-link reco-side-_5-2-commit-é˜¶æ®µ" data-v-2c0089e8>5.2 commit é˜¶æ®µ</a></li></ul></main></div> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="kanbanniang" data-v-5775ee02><div class="banniang-container" style="display:;" data-v-5775ee02><div class="messageBox" style="right:68px;bottom:190px;display:none;" data-v-5775ee02>
      æ¬¢è¿æ¥åˆ° ğŸ‚
    </div> <div class="operation" style="right:90px;bottom:40px;display:none;" data-v-5775ee02><i class="kbnfont kbn-ban-home ban-home" data-v-5775ee02></i> <i class="kbnfont kbn-ban-message message" data-v-5775ee02></i> <i class="kbnfont kbn-ban-close close" data-v-5775ee02></i> <a target="_blank" href="https://vuepress-theme-reco.recoluan.com/views/plugins/kanbanniang.html" data-v-5775ee02><i class="kbnfont kbn-ban-info info" data-v-5775ee02></i></a> <i class="kbnfont kbn-ban-theme skin" style="display:;" data-v-5775ee02></i></div> <canvas id="banniang" width="150" height="220" class="live2d" style="position:fixed;bottom:0px;right:66px;opacity:1;z-index:99999;" data-v-5775ee02></canvas></div> <div class="showBanNiang" style="display:none;" data-v-5775ee02>
    çœ‹æ¿å¨˜
  </div></div><canvas id="vuepress-canvas-cursor"></canvas><div></div><APlayer audio="" fixed="true" autoplay="autoplay" theme="#b7daff" loop="loop" order="list" preload="auto" volume="0.7" mutex="true" lrc-type="3" list-max-height="250" storage-name="vuepress-plugin-meting" id="aplayer-fixed"></APlayer><div class="Sakura" data-v-248d85d6><canvas id="canvas_sakura" style="z-index:-1;" data-v-248d85d6></canvas></div></div></div>
    <script src="/blog/assets/js/app.ee0bd224.js" defer></script><script src="/blog/assets/js/3.84323a08.js" defer></script><script src="/blog/assets/js/1.86f9a9c9.js" defer></script><script src="/blog/assets/js/50.35661192.js" defer></script>
  </body>
</html>
