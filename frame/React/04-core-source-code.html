<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.8" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.27" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://arisemarcher.github.io/blog/blog/frame/React/04-core-source-code.html"><meta property="og:site_name" content="å¾¡ç¥"><meta property="og:title" content="React-- Core source code"><meta property="og:description" content="1. é…ç½® React æºç æœ¬åœ°è°ƒè¯•ç¯å¢ƒ å¿«æ·é€šé“ ä½¿ç”¨ create-react-app è„šæ‰‹æ¶åˆ›å»ºé¡¹ç›® npx create-react-app react-test å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„react æ–¹ä¾¿è°ƒè¯• npm install react@16.13.1 react-dom@16.13.1 å¼¹å°„ create-react-app è„šæ‰‹æ¶å†…éƒ¨é…ç½® å¦‚..."><meta property="og:type" content="article"><meta property="og:image" content="https://arisemarcher.github.io/blog/blog/assets/images/react/sourceCode/1.png =500x300"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-03-12T06:08:07.000Z"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image:alt" content="React-- Core source code"><meta property="article:tag" content="react"><meta property="article:modified_time" content="2024-03-12T06:08:07.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"React-- Core source code","image":["https://arisemarcher.github.io/blog/blog/assets/images/react/sourceCode/1.png =500x300","https://arisemarcher.github.io/blog/blog/assets/images/react/sourceCode/2.png =500x300","https://arisemarcher.github.io/blog/blog/assets/images/react/sourceCode/6.png =500x300","https://arisemarcher.github.io/blog/blog/assets/images/react/sourceCode/3.png =500x300","https://arisemarcher.github.io/blog/blog/assets/images/react/sourceCode/4.png =500x300","https://arisemarcher.github.io/blog/blog/assets/images/react/sourceCode/7.png =500x300","https://arisemarcher.github.io/blog/blog/assets/images/react/sourceCode/5.png =500x300"],"dateModified":"2024-03-12T06:08:07.000Z","author":[]}</script><title>React-- Core source code | å¾¡ç¥</title><meta name="description" content="1. é…ç½® React æºç æœ¬åœ°è°ƒè¯•ç¯å¢ƒ å¿«æ·é€šé“ ä½¿ç”¨ create-react-app è„šæ‰‹æ¶åˆ›å»ºé¡¹ç›® npx create-react-app react-test å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„react æ–¹ä¾¿è°ƒè¯• npm install react@16.13.1 react-dom@16.13.1 å¼¹å°„ create-react-app è„šæ‰‹æ¶å†…éƒ¨é…ç½® å¦‚...">
    <link rel="preload" href="/blog/assets/style-CRS1YHK5.css" as="style"><link rel="stylesheet" href="/blog/assets/style-CRS1YHK5.css">
    <link rel="modulepreload" href="/blog/assets/app-CZ5YT_Cp.js"><link rel="modulepreload" href="/blog/assets/04-core-source-code.html-BVqsPlsC.js"><link rel="modulepreload" href="/blog/assets/plugin-vue_export-helper-DlAUqK2U.js">
    <link rel="prefetch" href="/blog/assets/index.html-Dcnzu8re.js" as="script"><link rel="prefetch" href="/blog/assets/01-base.html-wm3xXItp.js" as="script"><link rel="prefetch" href="/blog/assets/02-virtual-dom.html-BHy1JXIu.js" as="script"><link rel="prefetch" href="/blog/assets/03-fiber.html-CMxVbdhX.js" as="script"><link rel="prefetch" href="/blog/assets/05-redux.html-BUJUBq6g.js" as="script"><link rel="prefetch" href="/blog/assets/06-redux-simulation.html-pFxa5PPM.js" as="script"><link rel="prefetch" href="/blog/assets/07-redux-toolkit.html-C1l5TyPl.js" as="script"><link rel="prefetch" href="/blog/assets/08-mobx.html-D-ibDGVc.js" as="script"><link rel="prefetch" href="/blog/assets/09-hooks.html-Do3Qs7yw.js" as="script"><link rel="prefetch" href="/blog/assets/10-component.html-BQWOTCI_.js" as="script"><link rel="prefetch" href="/blog/assets/11-css-in-js.html-EnEIZo_l.js" as="script"><link rel="prefetch" href="/blog/assets/12-component-youhua.html-D8TkuOIg.js" as="script"><link rel="prefetch" href="/blog/assets/13-react-ssr.html-D51Fy4yn.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-B_HWHDYo.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-C2E0zeJB.js" as="script"><link rel="prefetch" href="/blog/assets/categories.html-DcAoycLG.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DCEFFLts.js" as="script"><link rel="prefetch" href="/blog/assets/flexå¸ƒå±€.html-DJ6fLkO2.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BT0VE9ry.js" as="script"><link rel="prefetch" href="/blog/assets/ä½œç”¨åŸŸ-é—­åŒ….html-DNShPMlf.js" as="script"><link rel="prefetch" href="/blog/assets/æ•°æ®ç±»å‹.html-PtYglQjk.js" as="script"><link rel="prefetch" href="/blog/assets/æ·±æ‹·è´-æµ…æ‹·è´.html-CBs7bGpC.js" as="script"><link rel="prefetch" href="/blog/assets/é˜²æŠ–-èŠ‚æµ.html-otiBZPeR.js" as="script"><link rel="prefetch" href="/blog/assets/01-toolType.html-BnWP_0yA.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-C6QOc5j-.js" as="script"><link rel="prefetch" href="/blog/assets/01-gulp-start.html-_RORNkdi.js" as="script"><link rel="prefetch" href="/blog/assets/02-gulp-htmlmin.html-C9pnryCw.js" as="script"><link rel="prefetch" href="/blog/assets/03-gulp-clean-css.html-ClrE4CGS.js" as="script"><link rel="prefetch" href="/blog/assets/04-gulp-uglify.html-RK1kwMfL.js" as="script"><link rel="prefetch" href="/blog/assets/05-gulp-babel.html-D1Kg9v1x.js" as="script"><link rel="prefetch" href="/blog/assets/06-gulp-browserify.html-os6OeoIf.js" as="script"><link rel="prefetch" href="/blog/assets/07-gulp-babel-jquery.html-CdUy3LsH.js" as="script"><link rel="prefetch" href="/blog/assets/08-gulp-concat.html-BdOESb6q.js" as="script"><link rel="prefetch" href="/blog/assets/09-gulp-watch.html-DVytZrvP.js" as="script"><link rel="prefetch" href="/blog/assets/10-gulp-browser-sync.html-DJSHKNbr.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Bbh6wDhw.js" as="script"><link rel="prefetch" href="/blog/assets/01-åŸºæœ¬ä½¿ç”¨.html-BfYNbULy.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-B7LTvHWH.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-DP1ISK9r.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BntNqQy4.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Bu22Y7lG.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Bt3rKjqL.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DBVGNKVn.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-6FS4TJzj.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-6FS4TJzj.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-D9dibdzf.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-D6ECD57l.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CH4xxvPL.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CSIhAQ2V.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-D-LM_MlA.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-6BO924nR.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Dvi5jxgw.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CYAcziPs.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Dw25FrBc.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-TwD2cnp2.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-LXTNNFsD.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DElFoACi.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-1WT0TeQQ.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CmKIA81F.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-B19Bg2JN.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BMNVylhD.js" as="script"><link rel="prefetch" href="/blog/assets/photoswipe.esm-SzV8tJDW.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container no-sidebar has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="route-link vp-brand" href="/blog/"><img class="vp-nav-logo" src="/blog/avatar.jpg" alt><!----><span class="vp-site-name hide-in-pad">å¾¡ç¥</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/blog/" aria-label="ä¸»é¡µ"><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span>ä¸»é¡µ<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="å‰ç«¯"><span class="title"><!---->å‰ç«¯</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>åŸºç¡€</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a class="route-link nav-link" href="/blog/web/JavaScript/" aria-label="JavaScript"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>JavaScript<!----></a></li><li class="dropdown-subitem"><a class="route-link nav-link" href="/blog/web/Ts/" aria-label="TypeScript"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>TypeScript<!----></a></li><li class="dropdown-subitem"><a class="route-link nav-link" href="/blog/web/Css/" aria-label="Css"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>Css<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>æ¡†æ¶</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a class="route-link nav-link" href="/blog/frame/Vue/" aria-label="Vue"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>Vue<!----></a></li><li class="dropdown-subitem"><a class="route-link nav-link active" href="/blog/frame/React/" aria-label="React"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>React<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>æ‰“åŒ…</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a class="route-link nav-link" href="/blog/pack/Gulp/" aria-label="Gulp"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>Gulp<!----></a></li><li class="dropdown-subitem"><a class="route-link nav-link" href="/blog/pack/Rollup/" aria-label="Rollup"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>Rollup<!----></a></li></ul></li></ul></button></div></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/AriseMarcher/blog" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!--[--><!----><!--]--><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->React-- Core source code</h1><div class="page-info"><!----><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-03-11T07:24:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 47 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT47M"></span><span class="page-category-info" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item category3 clickable" role="navigation">react</span><!--]--><meta property="articleSection" content="react"></span><span class="page-tag-info" aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item tag3 clickable" role="navigation">react</span><!--]--><meta property="keywords" content="react"></span></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!--[--><!----><!--]--><div class="vp-toc-header">æ­¤é¡µå†…å®¹<!----><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="/blog/#_1-é…ç½®-react-æºç æœ¬åœ°è°ƒè¯•ç¯å¢ƒ">1. é…ç½® React æºç æœ¬åœ°è°ƒè¯•ç¯å¢ƒ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="/blog/#_2-åˆ›å»º-react-å…ƒç´ ">2. åˆ›å»º React å…ƒç´ </a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/blog/#_2-1-createelement">2.1 createElement</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/blog/#_2-2-reactelement">2.2 ReactElement</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/blog/#_2-3-hasvalidref">2.3 hasValidRef</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/blog/#_2-4-hasvalidkey">2.4 hasValidKey</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/blog/#_2-5-isvalidelement">2.5 isValidElement</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/blog/#_2-6-definekeypropwarninggetter">2.6 defineKeyPropWarningGetter</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/blog/#_2-7-definerefpropwarninggetter">2.7 defineRefPropWarningGetter</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="/blog/#_3-react-æ¶æ„">3. React æ¶æ„</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/blog/#_3-1-scheduler-è°ƒåº¦å±‚">3.1 Scheduler è°ƒåº¦å±‚</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/blog/#_3-2-reconciler-åè°ƒå±‚">3.2 Reconciler åè°ƒå±‚</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/blog/#_3-3-renderer-æ¸²æŸ“å±‚">3.3 Renderer æ¸²æŸ“å±‚</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="/blog/#_4-æ•°æ®ç»“æ„">4. æ•°æ®ç»“æ„</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/blog/#_4-1-fiber">4.1 Fiber</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/blog/#_4-2-worktag">4.2 WorkTag</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/blog/#_4-3-typeofmode">4.3 TypeOfMode</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/blog/#_4-3-sideeffecttag">4.3 SideEffectTag</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/blog/#_4-4-update">4.4 Update</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/blog/#_4-5-updatequeue">4.5 UpdateQueue</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/blog/#_4-6-roottag">4.6 RootTag</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/blog/#_4-7-åŒç¼“å­˜æŠ€æœ¯">4.7 åŒç¼“å­˜æŠ€æœ¯</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/blog/#_4-8-åŒºåˆ†-fiberroot-ä¸-rootfiber">4.8 åŒºåˆ† fiberRoot ä¸ rootFiber</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="/blog/#_5-åˆå§‹åŒ–æ¸²æŸ“">5. åˆå§‹åŒ–æ¸²æŸ“</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/blog/#_5-1-render-é˜¶æ®µ">5.1 render é˜¶æ®µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="/blog/#_5-2-commit-é˜¶æ®µ">5.2 commit é˜¶æ®µ</a></li><!----><!--]--></ul></li><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!--[--><!----><!--]--><div class="theme-hope-content"><h2 id="_1-é…ç½®-react-æºç æœ¬åœ°è°ƒè¯•ç¯å¢ƒ" tabindex="-1"><a class="header-anchor" href="#_1-é…ç½®-react-æºç æœ¬åœ°è°ƒè¯•ç¯å¢ƒ"><span>1. é…ç½® React æºç æœ¬åœ°è°ƒè¯•ç¯å¢ƒ</span></a></h2><p><a href="https://github.com/AriseMarcher/advanced-to-react/tree/master/code/react-test" target="_blank" rel="noopener noreferrer">å¿«æ·é€šé“<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><ol><li>ä½¿ç”¨ create-react-app è„šæ‰‹æ¶åˆ›å»ºé¡¹ç›®</li></ol><p><code>npx create-react-app react-test</code></p><p>å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„react æ–¹ä¾¿è°ƒè¯•</p><p><code>npm install react@16.13.1 react-dom@16.13.1</code></p><ol start="2"><li>å¼¹å°„ create-react-app è„šæ‰‹æ¶å†…éƒ¨é…ç½®</li></ol><p>å¦‚æœæœ‰gitä»“åº“çš„è¯éœ€è¦å…ˆæäº¤ä»£ç </p><p><code>cd react-test</code></p><p><code>npm run eject</code></p><ol start="3"><li>å…‹éš† react å®˜æ–¹æºç  (åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹è¿›è¡Œå…‹éš† react-testä¸‹)</li></ol><p><code>git clone --branch v16.13.1 --depth=1 https://github.com/facebook/react.git src/react</code></p><ol start="4"><li>é“¾æ¥æœ¬åœ°æºç </li></ol><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code>  <span class="token comment">// æ–‡ä»¶ä½ç½®: react-test/config/webpack.config.js</span>
  <span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">alias</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;react-native&quot;</span><span class="token operator">:</span> <span class="token string">&quot;react-native-web&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;react&quot;</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../src/react/packages/react&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;react-dom&quot;</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../src/react/packages/react-dom&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;shared&quot;</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../src/react/packages/shared&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;react-reconciler&quot;</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../src/react/packages/react-reconciler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;legacy-events&quot;</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../src/react/packages/legacy-events&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>ä¿®æ”¹ç¯å¢ƒå˜é‡</li></ol><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code>  <span class="token comment">// æ–‡ä»¶ä½ç½®: react-test/config/env.js</span>
  <span class="token keyword">const</span> stringified <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string-property property">&quot;process.env&quot;</span><span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">env<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      env<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>raw<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> env
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">__DEV__</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">SharedArrayBuffer</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">spyOnDev</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">spyOnDevAndProd</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">spyOnProd</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">__PROFILE__</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">__UMD__</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">__EXPERIMENTAL__</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">__VARIANT__</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">gate</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">trustedTypes</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="6"><li><p>å‘Šè¯‰ babel åœ¨è½¬æ¢ä»£ç æ—¶å¿½ç•¥ç±»å‹æ£€æŸ¥</p><p><code>npm install @babel/plugin-transform-flow-strip-types -D</code></p></li></ol><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code>  <span class="token comment">// æ–‡ä»¶ä½ç½®: react-test/config/webpack.config.js [babel-loader]</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/plugin-transform-flow-strip-types&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="7"><li>å¯¼å‡º HostConfig</li></ol><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code>  <span class="token comment">// æ–‡ä»¶ä½ç½®: /react/packages/react-reconciler/src/ReactFiberHostConfig.js</span>
  <span class="token operator">+</span> <span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&#39;./forks/ReactFiberHostConfig.dom&#39;</span><span class="token punctuation">;</span>
  <span class="token operator">-</span> <span class="token function">invariant</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">&#39;This module must be shimmed by a specific renderer.&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="8"><li>ä¿®æ”¹ ReactSharedInternals.js æ–‡ä»¶</li></ol><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code>  <span class="token comment">// æ–‡ä»¶ä½ç½®: /react/packages/shared/ReactSharedInternals.js</span>
  <span class="token operator">-</span> <span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> React <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span><span class="token punctuation">;</span>
  <span class="token operator">-</span> <span class="token keyword">const</span> ReactSharedInternals <span class="token operator">=</span> React<span class="token punctuation">.</span>__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED<span class="token punctuation">;</span>
  <span class="token operator">+</span> <span class="token keyword">import</span> ReactSharedInternals <span class="token keyword">from</span> <span class="token string">&#39;../react/src/ReactSharedInternals&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="9"><li>å…³é—­ eslint æ‰©å±•</li></ol><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code>  <span class="token comment">// æ–‡ä»¶ä½ç½®: react/.eslingrc.js [module.exports]</span>
  <span class="token comment">// åˆ é™¤ extends</span>
  <span class="token keyword">extends</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&#39;fbjs&#39;</span><span class="token punctuation">,</span>
    <span class="token string">&#39;prettier&#39;</span>
  <span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="10"><li>ç¦æ­¢ invariant æŠ¥é”™</li></ol><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code>  <span class="token comment">// æ–‡ä»¶ä½ç½®: /react/packages/shared/invariant.js</span>
  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">invariant</span><span class="token punctuation">(</span><span class="token parameter">condition<span class="token punctuation">,</span> format<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> e<span class="token punctuation">,</span> f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>condition<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
      <span class="token string">&#39;Internal React error: invariant() is meant to be replaced at compile &#39;</span> <span class="token operator">+</span>
        <span class="token string">&#39;time. There is no runtime version.&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="11"><li><p>eslint é…ç½®</p><p>åœ¨ react æºç æ–‡ä»¶å¤¹ä¸­æ–°å»º .eslintrc.json å¹¶æ·»åŠ å¦‚ä¸‹é…ç½®</p></li></ol><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code>  <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;extends&quot;</span><span class="token operator">:</span> <span class="token string">&quot;react-app&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;globals&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;SharedArrayBuffer&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;spyOnDev&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;spyOnDevAndProd&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;spyOnProd&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;__PROFILE__&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;__UMD__&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;__EXPERIMENTAL__&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;__VARIANT__&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;gate&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;trustedTypes&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="12"><li>ä¿®æ”¹ react react-dom å¼•å…¥æ–¹å¼</li></ol><p>åœ¨index.jså’Œapp.jsä¸­ä¿®æ”¹å¼•å…¥æ–¹å¼</p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code>  <span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span>
  <span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> ReactDOM <span class="token keyword">from</span> <span class="token string">&quot;react-dom&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="13"><li>è§£å†³ vsCode ä¸­ flow æŠ¥é”™</li></ol><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code>  <span class="token string-property property">&quot;javascript.validate.enable&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="14"><li><p>å¯é€‰é¡¹é…ç½®</p><p>å¦‚æœä½ çš„ vscode ç¼–è¾‘å™¨å®‰è£…äº† prettier æ’ä»¶å¹¶ä¸”åœ¨ä¿å­˜ react æºç æ–‡ä»¶æ—¶å³ä¸‹è§’å‡ºç°å¦‚ä¸‹é”™è¯¯ï¼ŒæŒ‰ç…§å¦‚ä¸‹æ­¥éª¤è§£å†³</p><figure><img src="/blog/assets/images/react/sourceCode/1.png" alt="ç¤ºä¾‹" width="500" height="300" tabindex="0" loading="lazy"><figcaption>ç¤ºä¾‹</figcaption></figure><ol><li><p>å…¨å±€å®‰è£… prettier</p><p><code>npm i prettier -g</code></p></li><li><p>é…ç½® prettier path</p><p>Settings &gt; Extensions &gt; Prettier &gt; Prettier path</p></li></ol><figure><img src="/blog/assets/images/react/sourceCode/2.png" alt="ç¤ºä¾‹" width="500" height="300" tabindex="0" loading="lazy"><figcaption>ç¤ºä¾‹</figcaption></figure></li><li><p><code>\_\_DEV\_\_</code> æŠ¥é”™</p><p>åˆ é™¤ node_modules æ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œ npm install</p></li></ol><h2 id="_2-åˆ›å»º-react-å…ƒç´ " tabindex="-1"><a class="header-anchor" href="#_2-åˆ›å»º-react-å…ƒç´ "><span>2. åˆ›å»º React å…ƒç´ </span></a></h2><p>JSX è¢« Babel ç¼–è¯‘ä¸º React.createElement æ–¹æ³•çš„è°ƒç”¨ï¼ŒcreateElement æ–¹æ³•åœ¨è°ƒç”¨åè¿”å›çš„å°±æ˜¯ ReactElementï¼Œå°±æ˜¯ virtualDOMã€‚</p><h3 id="_2-1-createelement" tabindex="-1"><a class="header-anchor" href="#_2-1-createelement"><span>2.1 createElement</span></a></h3><p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react/src/ReactElement.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">/**
 * åˆ›å»º React Element
 * type      å…ƒç´ ç±»å‹
 * config    é…ç½®å±æ€§
 * children  å­å…ƒç´ 
 * 1. åˆ†ç¦» props å±æ€§å’Œç‰¹æ®Šå±æ€§
 * 2. å°†å­å…ƒç´ æŒ‚è½½åˆ° props.children ä¸­
 * 3. ä¸º props å±æ€§èµ‹é»˜è®¤å€¼ (defaultProps)
 * 4. åˆ›å»ºå¹¶è¿”å› ReactElement
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> config<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * propName -&gt; å±æ€§åç§°
   * ç”¨äºåé¢çš„ for å¾ªç¯
   */</span>
  <span class="token keyword">let</span> propName<span class="token punctuation">;</span>

  <span class="token comment">/**
   * å­˜å‚¨ React Element ä¸­çš„æ™®é€šå…ƒç´ å±æ€§ å³ä¸åŒ…å« key ref self source
   */</span>
  <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * å¾…æå–å±æ€§
   * React å†…éƒ¨ä¸ºäº†å®ç°æŸäº›åŠŸèƒ½è€Œå­˜åœ¨çš„å±æ€§
   */</span>
  <span class="token keyword">let</span> key <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> ref <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token comment">// å¦‚æœ config ä¸ä¸º null</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>config <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœ config å¯¹è±¡ä¸­æœ‰åˆæ³•çš„ ref å±æ€§</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasValidRef</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å°† config.ref å±æ€§æå–åˆ° ref å˜é‡ä¸­</span>
      ref <span class="token operator">=</span> config<span class="token punctuation">.</span>ref<span class="token punctuation">;</span>
      <span class="token comment">// åœ¨å¼€å‘ç¯å¢ƒä¸­</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœ ref å±æ€§çš„å€¼è¢«è®¾ç½®æˆäº†å­—ç¬¦ä¸²å½¢å¼å°±æŠ¥ä¸€ä¸ªæç¤º</span>
        <span class="token comment">// è¯´æ˜æ­¤ç”¨æ³•åœ¨å°†æ¥çš„ç‰ˆæœ¬ä¸­ä¼šè¢«åˆ é™¤</span>
        <span class="token function">warnIfStringRefCannotBeAutoConverted</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å¦‚æœåœ¨ config å¯¹è±¡ä¸­æ‹¥æœ‰åˆæ³•çš„ key å±æ€§</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasValidKey</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å°† config.key å±æ€§ä¸­çš„å€¼æå–åˆ° key å˜é‡ä¸­</span>
      key <span class="token operator">=</span> <span class="token string">&#39;&#39;</span> <span class="token operator">+</span> config<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    self <span class="token operator">=</span> config<span class="token punctuation">.</span>__self <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> config<span class="token punctuation">.</span>__self<span class="token punctuation">;</span>
    source <span class="token operator">=</span> config<span class="token punctuation">.</span>__source <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> config<span class="token punctuation">.</span>__source<span class="token punctuation">;</span>
    <span class="token comment">// éå† config å¯¹è±¡</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>propName <span class="token keyword">in</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœå½“å‰éå†åˆ°çš„å±æ€§æ˜¯å¯¹è±¡è‡ªèº«å±æ€§</span>
      <span class="token comment">// å¹¶ä¸”åœ¨ RESERVED_PROPS å¯¹è±¡ä¸­ä¸å­˜åœ¨è¯¥å±æ€§</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> propName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token constant">RESERVED_PROPS</span><span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å°†æ»¡è¶³æ¡ä»¶çš„å±æ€§æ·»åŠ åˆ° props å¯¹è±¡ä¸­ (æ™®é€šå±æ€§)</span>
        props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">=</span> config<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * å°†ç¬¬ä¸‰ä¸ªåŠä¹‹åçš„å‚æ•°æŒ‚è½½åˆ° props.children å±æ€§ä¸­
   * å¦‚æœå­å…ƒç´ æ˜¯å¤šä¸ª props.children æ˜¯æ•°ç»„
   * å¦‚æœå­å…ƒç´ æ˜¯ä¸€ä¸ª props.children æ˜¯å¯¹è±¡
   */</span>

  <span class="token comment">// ç”±äºä»ç¬¬ä¸‰ä¸ªå‚æ•°å¼€å§‹åŠä»¥åéƒ½è¡¨ç¤ºå­å…ƒç´ </span>
  <span class="token comment">// æ‰€ä»¥å‡å»å‰ä¸¤ä¸ªå‚æ•°çš„ç»“æœå°±æ˜¯å­å…ƒç´ çš„æ•°é‡</span>
  <span class="token keyword">const</span> childrenLength <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token comment">// å¦‚æœå­å…ƒç´ çš„æ•°é‡æ˜¯ 1</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>childrenLength <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç›´æ¥å°†å­å…ƒç´ æŒ‚è½½åˆ°åˆ° props.children å±æ€§ä¸Š</span>
    <span class="token comment">// æ­¤æ—¶ children æ˜¯å¯¹è±¡ç±»å‹</span>
    props<span class="token punctuation">.</span>children <span class="token operator">=</span> children<span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœå­å…ƒç´ çš„æ•°é‡å¤§äº 1</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>childrenLength <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ›å»ºæ•°ç»„, æ•°ç»„ä¸­å…ƒç´ çš„æ•°é‡ç­‰äºå­å…ƒç´ çš„æ•°é‡</span>
    <span class="token keyword">const</span> childArray <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span>childrenLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¼€å¯å¾ªç¯ å¾ªç¯æ¬¡åŒ¹é…å­å…ƒç´ çš„æ•°é‡</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> childrenLength<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å°†å­å…ƒç´ æ·»åŠ åˆ° childArray æ•°ç»„ä¸­</span>
      <span class="token comment">// i + 2 çš„åŸå› æ˜¯å®å‚é›†åˆçš„å‰ä¸¤ä¸ªå‚æ•°ä¸æ˜¯å­å…ƒç´ </span>
      childArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> arguments<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å¦‚æœæ˜¯å¼€å‘ç¯å¢ƒ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœ Object å¯¹è±¡ä¸­å­˜åœ¨ freeze æ–¹æ³•</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span>freeze<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è°ƒç”¨ freeze æ–¹æ³• å†»ç»“ childArray æ•°ç»„</span>
        <span class="token comment">// é˜²æ­¢ React æ ¸å¿ƒå¯¹è±¡è¢«ä¿®æ”¹ å†»ç»“å¯¹è±¡æé«˜æ€§èƒ½</span>
        Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span>childArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å°†å­å…ƒç´ æ•°ç»„æŒ‚è½½åˆ° props.children å±æ€§ä¸­</span>
    props<span class="token punctuation">.</span>children <span class="token operator">=</span> childArray<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * å¦‚æœå½“å‰å¤„ç†æ˜¯ç»„ä»¶
   * çœ‹ç»„ä»¶èº«ä¸Šæ˜¯å¦æœ‰ defaultProps å±æ€§
   * è¿™ä¸ªå±æ€§ä¸­å­˜å‚¨çš„æ˜¯ props å¯¹è±¡ä¸­å±æ€§çš„é»˜è®¤å€¼
   * éå† defaultProps å¯¹è±¡ æŸ¥çœ‹å¯¹åº”çš„ props å±æ€§çš„å€¼æ˜¯å¦ä¸º undefined
   * å¦‚æœä¸ºundefined å°±å°†é»˜è®¤å€¼èµ‹å€¼ç»™å¯¹åº”çš„ props å±æ€§å€¼
   */</span>

  <span class="token comment">// å°† type å±æ€§å€¼è§†ä¸ºå‡½æ•° æŸ¥çœ‹å…¶ä¸­æ˜¯å¦å…·æœ‰ defaultProps å±æ€§</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">&amp;&amp;</span> type<span class="token punctuation">.</span>defaultProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°† type å‡½æ•°ä¸‹çš„ defaultProps å±æ€§èµ‹å€¼ç»™ defaultProps å˜é‡</span>
    <span class="token keyword">const</span> defaultProps <span class="token operator">=</span> type<span class="token punctuation">.</span>defaultProps<span class="token punctuation">;</span>
    <span class="token comment">// éå† defaultProps å¯¹è±¡ä¸­çš„å±æ€§ å°†å±æ€§åç§°èµ‹å€¼ç»™ propName å˜é‡</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>propName <span class="token keyword">in</span> defaultProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœ props å¯¹è±¡ä¸­çš„è¯¥å±æ€§çš„å€¼ä¸º undefined</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å°† defaultProps å¯¹è±¡ä¸­çš„å¯¹åº”å±æ€§çš„å€¼èµ‹å€¼ç»™ props å¯¹è±¡ä¸­çš„å¯¹åº”å±æ€§çš„å€¼</span>
        props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">=</span> defaultProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * åœ¨å¼€å‘ç¯å¢ƒä¸­ å¦‚æœå…ƒç´ çš„ key å±æ€§ æˆ–è€… ref å±æ€§å­˜åœ¨
   * ç›‘æµ‹å¼€å‘è€…æ˜¯å¦åœ¨ç»„ä»¶å†…éƒ¨é€šè¿‡ props å¯¹è±¡è·å–äº† key å±æ€§æˆ–è€… ref å±æ€§
   * å¦‚æœè·å–äº† å°±æŠ¥é”™
   */</span>

  <span class="token comment">// å¦‚æœå¤„äºå¼€å‘ç¯å¢ƒ</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å…ƒç´ å…·æœ‰ key å±æ€§æˆ–è€… ref å±æ€§</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">||</span> ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// çœ‹ä¸€ä¸‹ type å±æ€§ä¸­å­˜å‚¨çš„æ˜¯å¦æ˜¯å‡½æ•° å¦‚æœæ˜¯å‡½æ•°å°±è¡¨ç¤ºå½“å‰å…ƒç´ æ˜¯ç»„ä»¶</span>
      <span class="token comment">// å¦‚æœå…ƒç´ ä¸æ˜¯ç»„ä»¶ å°±ç›´æ¥è¿”å›å…ƒç´ ç±»å‹å­—ç¬¦ä¸²</span>
      <span class="token comment">// displayName ç”¨äºåœ¨æŠ¥é”™è¿‡ç¨‹ä¸­æ˜¾ç¤ºæ˜¯å“ªä¸€ä¸ªç»„ä»¶æŠ¥é”™äº†</span>
      <span class="token comment">// å¦‚æœå¼€å‘è€…æ˜¾å¼å®šä¹‰äº† displayName å±æ€§ å°±æ˜¾ç¤ºå¼€å‘è€…å®šä¹‰çš„</span>
      <span class="token comment">// å¦è€…å°±æ˜¾ç¤ºç»„ä»¶åç§° å¦‚æœç»„ä»¶ä¹Ÿæ²¡æœ‰åç§° å°±æ˜¾ç¤º &#39;Unknown&#39;</span>
      <span class="token keyword">const</span> displayName <span class="token operator">=</span>
        <span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span>
          <span class="token operator">?</span> type<span class="token punctuation">.</span>displayName <span class="token operator">||</span> type<span class="token punctuation">.</span>name <span class="token operator">||</span> <span class="token string">&#39;Unknown&#39;</span>
          <span class="token operator">:</span> type<span class="token punctuation">;</span>
      <span class="token comment">// å¦‚æœ key å±æ€§å­˜åœ¨</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä¸º props å¯¹è±¡æ·»åŠ key å±æ€§</span>
        <span class="token comment">// å¹¶æŒ‡å®šå½“é€šè¿‡ props å¯¹è±¡è·å– key å±æ€§æ—¶æŠ¥é”™</span>
        <span class="token function">defineKeyPropWarningGetter</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> displayName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// å¦‚æœ ref å±æ€§å­˜åœ¨</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä¸º props å¯¹è±¡æ·»åŠ  ref å±æ€§</span>
        <span class="token comment">// å¹¶æŒ‡å®šå½“é€šè¿‡ props å¯¹è±¡è·å– ref å±æ€§æ—¶æŠ¥é”™</span>
        <span class="token function">defineRefPropWarningGetter</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> displayName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// è¿”å› ReactElement</span>
  <span class="token keyword">return</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span>
    type<span class="token punctuation">,</span>
    key<span class="token punctuation">,</span>
    ref<span class="token punctuation">,</span>
    self<span class="token punctuation">,</span>
    source<span class="token punctuation">,</span>
    <span class="token comment">// åœ¨ Virtual DOM ä¸­ç”¨äºè¯†åˆ«è‡ªå®šä¹‰ç»„ä»¶</span>
    ReactCurrentOwner<span class="token punctuation">.</span>current<span class="token punctuation">,</span>
    props<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-reactelement" tabindex="-1"><a class="header-anchor" href="#_2-2-reactelement"><span>2.2 ReactElement</span></a></h3><p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react/src/ReactElement.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">/**
 * æ¥æ”¶å‚æ•° è¿”å› ReactElement
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">ReactElement</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> self<span class="token punctuation">,</span> source<span class="token punctuation">,</span> owner<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * ç»„ä»¶çš„ç±»å‹, åå…­è¿›åˆ¶æ•°å€¼æˆ–è€… Symbol å€¼
     * React åœ¨æœ€ç»ˆåœ¨æ¸²æŸ“ DOM çš„æ—¶å€™, éœ€è¦ç¡®ä¿å…ƒç´ çš„ç±»å‹æ˜¯ REACT_ELEMENT_TYPE
     * éœ€è¦æ­¤å±æ€§ä½œä¸ºåˆ¤æ–­çš„ä¾æ®
     */</span>
    $$<span class="token keyword">typeof</span><span class="token operator">:</span> <span class="token constant">REACT_ELEMENT_TYPE</span><span class="token punctuation">,</span>

    <span class="token comment">/**
     * å…ƒç´ å…·ä½“çš„ç±»å‹å€¼ å¦‚æœæ˜¯å…ƒç´ èŠ‚ç‚¹ type å±æ€§ä¸­å­˜å‚¨çš„å°±æ˜¯ div span ç­‰ç­‰
     * å¦‚æœå…ƒç´ æ˜¯ç»„ä»¶ type å±æ€§ä¸­å­˜å‚¨çš„å°±æ˜¯ç»„ä»¶çš„æ„é€ å‡½æ•°
     */</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> type<span class="token punctuation">,</span>
    <span class="token comment">/**
     * å…ƒç´ çš„å”¯ä¸€æ ‡è¯†
     * ç”¨ä½œå†…éƒ¨ vdom æ¯”å¯¹ æå‡ DOM æ“ä½œæ€§èƒ½
     */</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span> key<span class="token punctuation">,</span>
    <span class="token comment">/**
     * å­˜å‚¨å…ƒç´  DOM å¯¹è±¡æˆ–è€…ç»„ä»¶ å®ä¾‹å¯¹è±¡
     */</span>
    <span class="token literal-property property">ref</span><span class="token operator">:</span> ref<span class="token punctuation">,</span>
    <span class="token comment">/**
     * å­˜å‚¨å‘ç»„ä»¶å†…éƒ¨ä¼ é€’çš„æ•°æ®
     */</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> props<span class="token punctuation">,</span>

    <span class="token comment">/**
     * è®°å½•å½“å‰å…ƒç´ æ‰€å±ç»„ä»¶ (è®°å½•å½“å‰å…ƒç´ æ˜¯å“ªä¸ªç»„ä»¶åˆ›å»ºçš„)
     */</span>
    <span class="token literal-property property">_owner</span><span class="token operator">:</span> owner<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// è¿”å› ReactElement</span>
  <span class="token keyword">return</span> element<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-hasvalidref" tabindex="-1"><a class="header-anchor" href="#_2-3-hasvalidref"><span>2.3 hasValidRef</span></a></h3><p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react/src/ReactElement.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">/**
 * æŸ¥çœ‹å‚æ•°å¯¹è±¡ä¸­æ˜¯å¦æœ‰åˆæ³•çš„ ref å±æ€§
 * è¿”å›å¸ƒå°”å€¼
 */</span>
<span class="token keyword">function</span> <span class="token function">hasValidRef</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> config<span class="token punctuation">.</span>ref <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-hasvalidkey" tabindex="-1"><a class="header-anchor" href="#_2-4-hasvalidkey"><span>2.4 hasValidKey</span></a></h3><p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react/src/ReactElement.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">/**
 * æŸ¥çœ‹å‚æ•°å¯¹è±¡ä¸­æ˜¯å¦æœ‰åˆæ³•çš„ key å±æ€§
 * è¿”å›å¸ƒå°”å€¼
 */</span>
<span class="token keyword">function</span> <span class="token function">hasValidKey</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> config<span class="token punctuation">.</span>key <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-5-isvalidelement" tabindex="-1"><a class="header-anchor" href="#_2-5-isvalidelement"><span>2.5 isValidElement</span></a></h3><p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react/src/ReactElement.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">/**
 * éªŒè¯ object å‚æ•°æ˜¯å¦æ˜¯ ReactElement. è¿”å›å¸ƒå°”å€¼
 * éªŒè¯æˆåŠŸçš„æ¡ä»¶:
 * object æ˜¯å¯¹è±¡
 * object ä¸ä¸ºnull
 * objectå¯¹è±¡ä¸­çš„ $$typeof å±æ€§å€¼ä¸º REACT_ELEMENT_TYPE
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isValidElement</span><span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token keyword">typeof</span> object <span class="token operator">===</span> <span class="token string">&#39;object&#39;</span> <span class="token operator">&amp;&amp;</span>
    object <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
    object<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">REACT_ELEMENT_TYPE</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-6-definekeypropwarninggetter" tabindex="-1"><a class="header-anchor" href="#_2-6-definekeypropwarninggetter"><span>2.6 defineKeyPropWarningGetter</span></a></h3><p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react/src/ReactElement.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">/**
 *  æŒ‡å®šå½“é€šè¿‡ props å¯¹è±¡è·å– key å±æ€§æ—¶æŠ¥é”™
 *  props        ç»„ä»¶ä¸­çš„ props å¯¹è±¡
 *  displayName  ç»„ä»¶åç§°æ ‡è¯†
 */</span>
<span class="token keyword">function</span> <span class="token function">defineKeyPropWarningGetter</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> displayName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// é€šè¿‡ props å¯¹è±¡è·å– key å±æ€§æŠ¥é”™</span>
  <span class="token keyword">const</span> <span class="token function-variable function">warnAboutAccessingKey</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åœ¨å¼€å‘ç¯å¢ƒä¸­</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// specialPropKeyWarningShown æ§åˆ¶é”™è¯¯åªè¾“å‡ºä¸€æ¬¡çš„å˜é‡</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>specialPropKeyWarningShown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// é€šè¿‡ specialPropKeyWarningShown å˜é‡é”ä½åˆ¤æ–­æ¡ä»¶</span>
        specialPropKeyWarningShown <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// æŒ‡å®šæŠ¥é”™ä¿¡æ¯å’Œç»„ä»¶åç§°</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>
          <span class="token string">&#39;%s: `key` is not a prop. Trying to access it will result &#39;</span> <span class="token operator">+</span>
            <span class="token string">&#39;in `undefined` being returned. If you need to access the same &#39;</span> <span class="token operator">+</span>
            <span class="token string">&#39;value within the child component, you should pass it as a different &#39;</span> <span class="token operator">+</span>
            <span class="token string">&#39;prop. (https://reactjs.org/link/special-props)&#39;</span><span class="token punctuation">,</span>
          displayName<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  warnAboutAccessingKey<span class="token punctuation">.</span>isReactWarning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">// ä¸º props å¯¹è±¡æ·»åŠ  key å±æ€§</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> <span class="token string">&#39;key&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// å½“è·å– key å±æ€§æ—¶è°ƒç”¨ warnAboutAccessingKey æ–¹æ³•è¿›è¡ŒæŠ¥é”™</span>
    <span class="token literal-property property">get</span><span class="token operator">:</span> warnAboutAccessingKey<span class="token punctuation">,</span>
    <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-7-definerefpropwarninggetter" tabindex="-1"><a class="header-anchor" href="#_2-7-definerefpropwarninggetter"><span>2.7 defineRefPropWarningGetter</span></a></h3><p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react/src/ReactElement.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">/**
 *  æŒ‡å®šå½“é€šè¿‡ props å¯¹è±¡è·å– ref å±æ€§æ—¶æŠ¥é”™
 *  props        ç»„ä»¶ä¸­çš„ props å¯¹è±¡
 *  displayName  ç»„ä»¶åç§°æ ‡è¯†
 */</span>
<span class="token keyword">function</span> <span class="token function">defineRefPropWarningGetter</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> displayName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// é€šè¿‡ props å¯¹è±¡è·å– ref å±æ€§æŠ¥é”™</span>
  <span class="token keyword">const</span> <span class="token function-variable function">warnAboutAccessingRef</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// specialPropRefWarningShown æ§åˆ¶é”™è¯¯åªè¾“å‡ºä¸€æ¬¡çš„å˜é‡</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>specialPropRefWarningShown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// é€šè¿‡ specialPropRefWarningShown å˜é‡é”ä½åˆ¤æ–­æ¡ä»¶</span>
        specialPropRefWarningShown <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// æŒ‡å®šæŠ¥é”™ä¿¡æ¯å’Œç»„ä»¶åç§°</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>
          <span class="token string">&#39;%s: `ref` is not a prop. Trying to access it will result &#39;</span> <span class="token operator">+</span>
            <span class="token string">&#39;in `undefined` being returned. If you need to access the same &#39;</span> <span class="token operator">+</span>
            <span class="token string">&#39;value within the child component, you should pass it as a different &#39;</span> <span class="token operator">+</span>
            <span class="token string">&#39;prop. (https://reactjs.org/link/special-props)&#39;</span><span class="token punctuation">,</span>
          displayName<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  warnAboutAccessingRef<span class="token punctuation">.</span>isReactWarning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">// ä¸º props å¯¹è±¡æ·»åŠ  key å±æ€§</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> <span class="token string">&#39;ref&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">get</span><span class="token operator">:</span> warnAboutAccessingRef<span class="token punctuation">,</span>
    <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-react-æ¶æ„" tabindex="-1"><a class="header-anchor" href="#_3-react-æ¶æ„"><span>3. React æ¶æ„</span></a></h2><p>React 16 ç‰ˆæœ¬çš„æ¶æ„å¯ä»¥åˆ†ä¸ºä¸‰å±‚ï¼šè°ƒåº¦å±‚ã€åè°ƒå±‚ã€æ¸²æŸ“å±‚ã€‚</p><ul><li>Scheduler (è°ƒåº¦å±‚)ï¼šè°ƒåº¦ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œé«˜ä¼˜ä»»åŠ¡ä¼˜å…ˆè¿›å…¥åè°ƒå™¨</li><li>Reconciler (åè°ƒå±‚)ï¼šæ„å»º Fiber æ•°æ®ç»“æ„ï¼Œæ¯”å¯¹ Fiber å¯¹è±¡æ‰¾å‡ºå·®å¼‚, è®°å½• Fiber å¯¹è±¡è¦è¿›è¡Œçš„ DOM æ“ä½œ</li><li>Renderer (æ¸²æŸ“å±‚)ï¼šè´Ÿè´£å°†å‘ç”Ÿå˜åŒ–çš„éƒ¨åˆ†æ¸²æŸ“åˆ°é¡µé¢ä¸Š</li></ul><h3 id="_3-1-scheduler-è°ƒåº¦å±‚" tabindex="-1"><a class="header-anchor" href="#_3-1-scheduler-è°ƒåº¦å±‚"><span>3.1 Scheduler è°ƒåº¦å±‚</span></a></h3><p>åœ¨ React 15 çš„ç‰ˆæœ¬ä¸­ï¼Œé‡‡ç”¨äº†å¾ªç¯åŠ é€’å½’çš„æ–¹å¼è¿›è¡Œäº† virtualDOM çš„æ¯”å¯¹ï¼Œç”±äºé€’å½’ä½¿ç”¨ JavaScript è‡ªèº«çš„æ‰§è¡Œæ ˆï¼Œä¸€æ—¦å¼€å§‹å°±æ— æ³•åœæ­¢ï¼Œç›´åˆ°ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚å¦‚æœ VirtualDOM æ ‘çš„å±‚çº§æ¯”è¾ƒæ·±ï¼ŒvirtualDOM çš„æ¯”å¯¹å°±ä¼šé•¿æœŸå ç”¨ JavaScript ä¸»çº¿ç¨‹ï¼Œç”±äº JavaScript åˆæ˜¯å•çº¿ç¨‹çš„æ— æ³•åŒæ—¶æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œæ‰€ä»¥åœ¨æ¯”å¯¹çš„è¿‡ç¨‹ä¸­æ— æ³•å“åº”ç”¨æˆ·æ“ä½œï¼Œæ— æ³•å³æ—¶æ‰§è¡Œå…ƒç´ åŠ¨ç”»ï¼Œé€ æˆäº†é¡µé¢å¡é¡¿çš„ç°è±¡ã€‚</p><p>åœ¨ React 16 çš„ç‰ˆæœ¬ä¸­ï¼Œæ”¾å¼ƒäº† JavaScript é€’å½’çš„æ–¹å¼è¿›è¡Œ virtualDOM çš„æ¯”å¯¹ï¼Œè€Œæ˜¯é‡‡ç”¨å¾ªç¯æ¨¡æ‹Ÿé€’å½’ã€‚è€Œä¸”æ¯”å¯¹çš„è¿‡ç¨‹æ˜¯åˆ©ç”¨æµè§ˆå™¨çš„ç©ºé—²æ—¶é—´å®Œæˆçš„ï¼Œä¸ä¼šé•¿æœŸå ç”¨ä¸»çº¿ç¨‹ï¼Œè¿™å°±è§£å†³äº† virtualDOM æ¯”å¯¹é€ æˆé¡µé¢å¡é¡¿çš„é—®é¢˜ã€‚</p><p>åœ¨ window å¯¹è±¡ä¸­æä¾›äº† requestIdleCallback APIï¼Œå®ƒå¯ä»¥åˆ©ç”¨æµè§ˆå™¨çš„ç©ºé—²æ—¶é—´æ‰§è¡Œä»»åŠ¡ï¼Œä½†æ˜¯å®ƒè‡ªèº«ä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚è¯´å¹¶ä¸æ˜¯æ‰€æœ‰çš„æµè§ˆå™¨éƒ½æ”¯æŒå®ƒï¼Œè€Œä¸”å®ƒçš„è§¦å‘é¢‘ç‡ä¹Ÿä¸æ˜¯å¾ˆç¨³å®šï¼Œæ‰€ä»¥ React æœ€ç»ˆæ”¾å¼ƒäº† requestIdleCallback çš„ä½¿ç”¨ã€‚</p><p>åœ¨ React ä¸­ï¼Œå®˜æ–¹å®ç°äº†è‡ªå·±çš„ä»»åŠ¡è°ƒåº¦åº“ï¼Œè¿™ä¸ªåº“å°±å«åš Schedulerã€‚å®ƒä¹Ÿå¯ä»¥å®ç°åœ¨æµè§ˆå™¨ç©ºé—²æ—¶æ‰§è¡Œä»»åŠ¡ï¼Œè€Œä¸”è¿˜å¯ä»¥è®¾ç½®ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œé«˜ä¼˜å…ˆçº§ä»»åŠ¡å…ˆæ‰§è¡Œï¼Œä½ä¼˜å…ˆçº§ä»»åŠ¡åæ‰§è¡Œã€‚</p><p>Scheduler å­˜å‚¨åœ¨ <code>packages/scheduler</code> æ–‡ä»¶å¤¹ä¸­ã€‚</p><h3 id="_3-2-reconciler-åè°ƒå±‚" tabindex="-1"><a class="header-anchor" href="#_3-2-reconciler-åè°ƒå±‚"><span>3.2 Reconciler åè°ƒå±‚</span></a></h3><p>åœ¨ React 15 çš„ç‰ˆæœ¬ä¸­ï¼Œåè°ƒå™¨å’Œæ¸²æŸ“å™¨äº¤æ›¿æ‰§è¡Œï¼Œå³æ‰¾åˆ°äº†å·®å¼‚å°±ç›´æ¥æ›´æ–°å·®å¼‚ã€‚åœ¨ React 16 çš„ç‰ˆæœ¬ä¸­ï¼Œè¿™ç§æƒ…å†µå‘ç”Ÿäº†å˜åŒ–ï¼Œåè°ƒå™¨å’Œæ¸²æŸ“å™¨ä¸å†äº¤æ›¿æ‰§è¡Œã€‚åè°ƒå™¨è´Ÿè´£æ‰¾å‡ºå·®å¼‚ï¼Œåœ¨æ‰€æœ‰å·®å¼‚æ‰¾å‡ºä¹‹åï¼Œç»Ÿä¸€äº¤ç»™æ¸²æŸ“å™¨è¿›è¡Œ DOM çš„æ›´æ–°ã€‚ä¹Ÿå°±æ˜¯è¯´åè°ƒå™¨çš„ä¸»è¦ä»»åŠ¡å°±æ˜¯æ‰¾å‡ºå·®å¼‚éƒ¨åˆ†ï¼Œå¹¶ä¸ºå·®å¼‚æ‰“ä¸Šæ ‡è®°ã€‚</p><h3 id="_3-3-renderer-æ¸²æŸ“å±‚" tabindex="-1"><a class="header-anchor" href="#_3-3-renderer-æ¸²æŸ“å±‚"><span>3.3 Renderer æ¸²æŸ“å±‚</span></a></h3><p>æ¸²æŸ“å™¨æ ¹æ®åè°ƒå™¨ä¸º Fiber èŠ‚ç‚¹æ‰“çš„æ ‡è®°ï¼ŒåŒæ­¥æ‰§è¡Œå¯¹åº”çš„DOMæ“ä½œã€‚</p><p>æ—¢ç„¶æ¯”å¯¹çš„è¿‡ç¨‹ä»é€’å½’å˜æˆäº†å¯ä»¥ä¸­æ–­çš„å¾ªç¯ï¼Œé‚£ä¹ˆ React æ˜¯å¦‚ä½•è§£å†³ä¸­æ–­æ›´æ–°æ—¶ DOM æ¸²æŸ“ä¸å®Œå…¨çš„é—®é¢˜å‘¢ï¼Ÿ</p><p>å…¶å®æ ¹æœ¬å°±ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºåœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œè°ƒåº¦å™¨å’Œåè°ƒå™¨çš„å·¥ä½œæ˜¯åœ¨å†…å­˜ä¸­å®Œæˆçš„æ˜¯å¯ä»¥è¢«æ‰“æ–­çš„ï¼Œæ¸²æŸ“å™¨çš„å·¥ä½œè¢«è®¾å®šæˆä¸å¯ä»¥è¢«æ‰“æ–­ï¼Œæ‰€ä»¥ä¸å­˜åœ¨DOM æ¸²æŸ“ä¸å®Œå…¨çš„é—®é¢˜ã€‚</p><h2 id="_4-æ•°æ®ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_4-æ•°æ®ç»“æ„"><span>4. æ•°æ®ç»“æ„</span></a></h2><h3 id="_4-1-fiber" tabindex="-1"><a class="header-anchor" href="#_4-1-fiber"><span>4.1 Fiber</span></a></h3><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code>type Fiber <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">/************************  DOM å®ä¾‹ç›¸å…³  *****************************/</span>
  
  <span class="token comment">// æ ‡è®°ä¸åŒçš„ç»„ä»¶ç±»å‹, å€¼è¯¦è§ WorkTag</span>
  <span class="token literal-property property">tag</span><span class="token operator">:</span> WorkTag<span class="token punctuation">,</span>

  <span class="token comment">// ç»„ä»¶ç±»å‹ divã€spanã€ç»„ä»¶æ„é€ å‡½æ•°</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> any<span class="token punctuation">,</span>

  <span class="token comment">// å®ä¾‹å¯¹è±¡, å¦‚ç±»ç»„ä»¶çš„å®ä¾‹ã€åŸç”Ÿ dom å®ä¾‹, è€Œ function ç»„ä»¶æ²¡æœ‰å®ä¾‹, å› æ­¤è¯¥å±æ€§æ˜¯ç©º</span>
  <span class="token literal-property property">stateNode</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
 
	<span class="token comment">/************************  æ„å»º Fiber æ ‘ç›¸å…³  ***************************/</span>
  
  <span class="token comment">// æŒ‡å‘è‡ªå·±çš„çˆ¶çº§ Fiber å¯¹è±¡</span>
  <span class="token keyword">return</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

  <span class="token comment">// æŒ‡å‘è‡ªå·±çš„ç¬¬ä¸€ä¸ªå­çº§ Fiber å¯¹è±¡</span>
  <span class="token literal-property property">child</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  
  <span class="token comment">// æŒ‡å‘è‡ªå·±çš„ä¸‹ä¸€ä¸ªå…„å¼Ÿ iber å¯¹è±¡</span>
  <span class="token literal-property property">sibling</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  
  <span class="token comment">// åœ¨ Fiber æ ‘æ›´æ–°çš„è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ª Fiber éƒ½ä¼šæœ‰ä¸€ä¸ªè·Ÿå…¶å¯¹åº”çš„ Fiber</span>
  <span class="token comment">// æˆ‘ä»¬ç§°ä»–ä¸º current &lt;==&gt; workInProgress</span>
  <span class="token comment">// åœ¨æ¸²æŸ“å®Œæˆä¹‹åä»–ä»¬ä¼šäº¤æ¢ä½ç½®</span>
  <span class="token comment">// alternate æŒ‡å‘å½“å‰ Fiber åœ¨ workInProgress æ ‘ä¸­çš„å¯¹åº” Fiber</span>
	<span class="token literal-property property">alternate</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
		
  <span class="token comment">/************************  çŠ¶æ€æ•°æ®ç›¸å…³  ********************************/</span>
  
  <span class="token comment">// å³å°†æ›´æ–°çš„ props</span>
  <span class="token literal-property property">pendingProps</span><span class="token operator">:</span> any<span class="token punctuation">,</span> 
  <span class="token comment">// æ—§çš„ props</span>
  <span class="token literal-property property">memoizedProps</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  <span class="token comment">// æ—§çš„ state</span>
  <span class="token literal-property property">memoizedState</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
		
  <span class="token comment">/************************  å‰¯ä½œç”¨ç›¸å…³ ******************************/</span>

  <span class="token comment">// è¯¥ Fiber å¯¹åº”çš„ç»„ä»¶äº§ç”Ÿçš„çŠ¶æ€æ›´æ–°ä¼šå­˜æ”¾åœ¨è¿™ä¸ªé˜Ÿåˆ—é‡Œé¢ </span>
  <span class="token literal-property property">updateQueue</span><span class="token operator">:</span> UpdateQueue<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>any</span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> | null,
  
  // ç”¨æ¥è®°å½•å½“å‰ Fiber è¦æ‰§è¡Œçš„ DOM æ“ä½œ
  effectTag: SideEffectTag,

  // å­˜å‚¨ç¬¬ä¸€ä¸ªè¦æ‰§è¡Œå‰¯ä½œç”¨çš„å­çº§ Fiber å¯¹è±¡
  firstEffect: Fiber | null,
  
  // å­˜å‚¨ä¸‹ä¸€ä¸ªè¦æ‰§è¡Œå‰¯ä½œç”¨çš„å­çº§ Fiber å¯¹è±¡
  // æ‰§è¡Œ DOM æ¸²æŸ“æ—¶è¦å…ˆé€šè¿‡ first æ‰¾åˆ°ç¬¬ä¸€ä¸ª, ç„¶åé€šè¿‡ next ä¸€ç›´å‘åæŸ¥æ‰¾
  nextEffect: Fiber | null,
  
  // å­˜å‚¨ DOM æ“ä½œå®Œåçš„å‰¯ä½œç”¨ æ¯”å¦‚è°ƒç”¨ç”Ÿå‘½å‘¨æœŸå‡½æ•°æˆ–è€…é’©å­å‡½æ•°çš„è°ƒç”¨
  lastEffect: Fiber | null,

  // ä»»åŠ¡çš„è¿‡æœŸæ—¶é—´
  expirationTime: ExpirationTime,
  
	// å½“å‰ç»„ä»¶åŠå­ç»„ä»¶å¤„äºä½•ç§æ¸²æŸ“æ¨¡å¼ è¯¦è§ TypeOfMode
  mode: TypeOfMode,
};
</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="/blog/assets/images/react/sourceCode/6.png" alt="ç¤ºä¾‹" width="500" height="300" tabindex="0" loading="lazy"><figcaption>ç¤ºä¾‹</figcaption></figure><h3 id="_4-2-worktag" tabindex="-1"><a class="header-anchor" href="#_4-2-worktag"><span>4.2 WorkTag</span></a></h3><p><code>æ–‡ä»¶ä½ç½®ï¼špackages/shared/ReactWorkTags.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code>type WorkTag <span class="token operator">=</span>
  <span class="token operator">|</span> <span class="token number">0</span>
  <span class="token operator">|</span> <span class="token number">1</span>
  <span class="token operator">|</span> <span class="token number">2</span>
  <span class="token operator">|</span> <span class="token number">3</span>
  <span class="token operator">|</span> <span class="token number">4</span>
  <span class="token operator">|</span> <span class="token number">5</span>
  <span class="token operator">|</span> <span class="token number">6</span>
  <span class="token operator">|</span> <span class="token number">7</span>
  <span class="token operator">|</span> <span class="token number">8</span>
  <span class="token operator">|</span> <span class="token number">9</span>
  <span class="token operator">|</span> <span class="token number">10</span>
  <span class="token operator">|</span> <span class="token number">11</span>
  <span class="token operator">|</span> <span class="token number">12</span>
  <span class="token operator">|</span> <span class="token number">13</span>
  <span class="token operator">|</span> <span class="token number">14</span>
  <span class="token operator">|</span> <span class="token number">15</span>
  <span class="token operator">|</span> <span class="token number">16</span>
  <span class="token operator">|</span> <span class="token number">17</span>
  <span class="token operator">|</span> <span class="token number">18</span>
  <span class="token operator">|</span> <span class="token number">19</span>
  <span class="token operator">|</span> <span class="token number">20</span>
  <span class="token operator">|</span> <span class="token number">21</span>
  <span class="token operator">|</span> <span class="token number">22</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> FunctionComponent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ClassComponent <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> IndeterminateComponent <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostRoot <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostPortal <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostComponent <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostText <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Fragment <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Mode <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ContextConsumer <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ContextProvider <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ForwardRef <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Profiler <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> SuspenseComponent <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> MemoComponent <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> SimpleMemoComponent <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> LazyComponent <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> IncompleteClassComponent <span class="token operator">=</span> <span class="token number">17</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> DehydratedFragment <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> SuspenseListComponent <span class="token operator">=</span> <span class="token number">19</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> FundamentalComponent <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ScopeComponent <span class="token operator">=</span> <span class="token number">21</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Block <span class="token operator">=</span> <span class="token number">22</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-typeofmode" tabindex="-1"><a class="header-anchor" href="#_4-3-typeofmode"><span>4.3 TypeOfMode</span></a></h3><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactTypeOfMode.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token keyword">export</span> type TypeOfMode <span class="token operator">=</span> number<span class="token punctuation">;</span>

<span class="token comment">// 0 åŒæ­¥æ¸²æŸ“æ¨¡å¼</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> NoMode <span class="token operator">=</span> <span class="token number">0b0000</span><span class="token punctuation">;</span>
<span class="token comment">// 1 ä¸¥æ ¼æ¨¡å¼</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> StrictMode <span class="token operator">=</span> <span class="token number">0b0001</span><span class="token punctuation">;</span>
<span class="token comment">// 10 å¼‚æ­¥æ¸²æŸ“è¿‡æ¸¡æ¨¡å¼</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> BlockingMode <span class="token operator">=</span> <span class="token number">0b0010</span><span class="token punctuation">;</span>
<span class="token comment">// 100 å¼‚æ­¥æ¸²æŸ“æ¨¡å¼</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ConcurrentMode <span class="token operator">=</span> <span class="token number">0b0100</span><span class="token punctuation">;</span>
<span class="token comment">// 1000 æ€§èƒ½æµ‹è¯•æ¨¡å¼</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ProfileMode <span class="token operator">=</span> <span class="token number">0b1000</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-sideeffecttag" tabindex="-1"><a class="header-anchor" href="#_4-3-sideeffecttag"><span>4.3 SideEffectTag</span></a></h3><p><code>æ–‡ä»¶ä½ç½®ï¼špackages/shared/ReactSideEffectTags.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token keyword">export</span> type SideEffectTag <span class="token operator">=</span> number<span class="token punctuation">;</span>

<span class="token comment">// Don&#39;t change these two values. They&#39;re used by React Dev Tools.</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> NoEffect <span class="token operator">=</span> <span class="token comment">/*              */</span> <span class="token number">0b0000000000000</span><span class="token punctuation">;</span> <span class="token comment">// 0</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> PerformedWork <span class="token operator">=</span> <span class="token comment">/*         */</span> <span class="token number">0b0000000000001</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>

<span class="token comment">// You can change the rest (and add more).</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Placement <span class="token operator">=</span> <span class="token comment">/*             */</span> <span class="token number">0b0000000000010</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Update <span class="token operator">=</span> <span class="token comment">/*                */</span> <span class="token number">0b0000000000100</span><span class="token punctuation">;</span> <span class="token comment">// 4</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> PlacementAndUpdate <span class="token operator">=</span> <span class="token comment">/*    */</span> <span class="token number">0b0000000000110</span><span class="token punctuation">;</span> <span class="token comment">// 6</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Deletion <span class="token operator">=</span> <span class="token comment">/*              */</span> <span class="token number">0b0000000001000</span><span class="token punctuation">;</span> <span class="token comment">// 8</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ContentReset <span class="token operator">=</span> <span class="token comment">/*          */</span> <span class="token number">0b0000000010000</span><span class="token punctuation">;</span> <span class="token comment">// 16</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Callback <span class="token operator">=</span> <span class="token comment">/*              */</span> <span class="token number">0b0000000100000</span><span class="token punctuation">;</span> <span class="token comment">// 32</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> DidCapture <span class="token operator">=</span> <span class="token comment">/*            */</span> <span class="token number">0b0000001000000</span><span class="token punctuation">;</span> <span class="token comment">// 64</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Ref <span class="token operator">=</span> <span class="token comment">/*                   */</span> <span class="token number">0b0000010000000</span><span class="token punctuation">;</span> <span class="token comment">// 128</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Snapshot <span class="token operator">=</span> <span class="token comment">/*              */</span> <span class="token number">0b0000100000000</span><span class="token punctuation">;</span> <span class="token comment">// 256</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Passive <span class="token operator">=</span> <span class="token comment">/*               */</span> <span class="token number">0b0001000000000</span><span class="token punctuation">;</span> <span class="token comment">// 512</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Hydrating <span class="token operator">=</span> <span class="token comment">/*             */</span> <span class="token number">0b0010000000000</span><span class="token punctuation">;</span> <span class="token comment">// 1024</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HydratingAndUpdate <span class="token operator">=</span> <span class="token comment">/*    */</span> <span class="token number">0b0010000000100</span><span class="token punctuation">;</span> <span class="token comment">// 1028</span>

<span class="token comment">// Passive &amp; Update &amp; Callback &amp; Ref &amp; Snapshot</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> LifecycleEffectMask <span class="token operator">=</span> <span class="token comment">/*   */</span> <span class="token number">0b0001110100100</span><span class="token punctuation">;</span> <span class="token comment">// 932</span>

<span class="token comment">// Union of all host effects</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostEffectMask <span class="token operator">=</span> <span class="token comment">/*        */</span> <span class="token number">0b0011111111111</span><span class="token punctuation">;</span> <span class="token comment">// 2047</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> Incomplete <span class="token operator">=</span> <span class="token comment">/*            */</span> <span class="token number">0b0100000000000</span><span class="token punctuation">;</span> <span class="token comment">// 2048</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ShouldCapture <span class="token operator">=</span> <span class="token comment">/*         */</span> <span class="token number">0b1000000000000</span><span class="token punctuation">;</span> <span class="token comment">// 4096</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-update" tabindex="-1"><a class="header-anchor" href="#_4-4-update"><span>4.4 Update</span></a></h3><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token keyword">let</span> <span class="token literal-property property">update</span><span class="token operator">:</span> Update<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  expirationTime<span class="token punctuation">,</span>
  suspenseConfig<span class="token punctuation">,</span>

  <span class="token literal-property property">tag</span><span class="token operator">:</span> UpdateState<span class="token punctuation">,</span>
  <span class="token literal-property property">payload</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">callback</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

  <span class="token literal-property property">next</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-5-updatequeue" tabindex="-1"><a class="header-anchor" href="#_4-5-updatequeue"><span>4.5 UpdateQueue</span></a></h3><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token keyword">const</span> <span class="token literal-property property">queue</span><span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">State</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> = </span><span class="token punctuation">{</span>
  <span class="token comment">// ä¸Šä¸€æ¬¡æ›´æ–°ä¹‹åçš„ state, ä½œä¸ºä¸‹ä¸€æ¬¡æ›´æ–°çš„åŸºç¡€</span>
  <span class="token literal-property property">baseState</span><span class="token operator">:</span> fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span>
  <span class="token literal-property property">baseQueue</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">shared</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">pending</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">effects</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token plain-text">
fiber.updateQueue = queue;
</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-6-roottag" tabindex="-1"><a class="header-anchor" href="#_4-6-roottag"><span>4.6 RootTag</span></a></h3><p><code>æ–‡ä»¶ä½ç½®ï¼špackages/shared/ReactRootTags.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token keyword">export</span> type RootTag <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">|</span> <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token comment">// ReactDOM.render</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> LegacyRoot <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">// ReactDOM.createBlockingRoot</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> BlockingRoot <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">// ReactDOM.createRoot</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ConcurrentRoot <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-7-åŒç¼“å­˜æŠ€æœ¯" tabindex="-1"><a class="header-anchor" href="#_4-7-åŒç¼“å­˜æŠ€æœ¯"><span>4.7 åŒç¼“å­˜æŠ€æœ¯</span></a></h3><p>åœ¨ React ä¸­ï¼ŒDOM çš„æ›´æ–°é‡‡ç”¨äº†åŒç¼“å­˜æŠ€æœ¯ï¼ŒåŒç¼“å­˜æŠ€æœ¯è‡´åŠ›äºæ›´å¿«é€Ÿçš„ DOM æ›´æ–°ã€‚</p><p>ä»€ä¹ˆæ˜¯åŒç¼“å­˜ï¼Ÿä¸¾ä¸ªä¾‹å­ï¼Œä½¿ç”¨ canvas ç»˜åˆ¶åŠ¨ç”»æ—¶ï¼Œåœ¨ç»˜åˆ¶æ¯ä¸€å¸§å‰éƒ½ä¼šæ¸…é™¤ä¸Šä¸€å¸§çš„ç”»é¢ï¼Œæ¸…é™¤ä¸Šä¸€å¸§éœ€è¦èŠ±è´¹æ—¶é—´ï¼Œå¦‚æœå½“å‰å¸§ç”»é¢è®¡ç®—é‡åˆæ¯”è¾ƒå¤§ï¼Œåˆéœ€è¦èŠ±è´¹æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œè¿™å°±å¯¼è‡´ä¸Šä¸€å¸§æ¸…é™¤åˆ°ä¸‹ä¸€å¸§æ˜¾ç¤ºä¸­é—´ä¼šæœ‰è¾ƒé•¿çš„é—´éš™ï¼Œå°±ä¼šå‡ºç°ç™½å±ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å†…å­˜ä¸­ç»˜åˆ¶å½“å‰å¸§åŠ¨ç”»ï¼Œç»˜åˆ¶å®Œæ¯•åç›´æ¥ç”¨å½“å‰å¸§æ›¿æ¢ä¸Šä¸€å¸§ç”»é¢ï¼Œè¿™æ ·çš„è¯åœ¨å¸§ç”»é¢æ›¿æ¢çš„è¿‡ç¨‹ä¸­å°±ä¼šèŠ‚çº¦éå¸¸å¤šçš„æ—¶é—´ï¼Œå°±ä¸ä¼šå‡ºç°ç™½å±é—®é¢˜ã€‚è¿™ç§åœ¨å†…å­˜ä¸­æ„å»ºå¹¶ç›´æ¥æ›¿æ¢çš„æŠ€æœ¯å«åšåŒç¼“å­˜ã€‚</p><p>React ä½¿ç”¨åŒç¼“å­˜æŠ€æœ¯å®Œæˆ Fiber æ ‘çš„æ„å»ºä¸æ›¿æ¢ï¼Œå®ç°DOMå¯¹è±¡çš„å¿«é€Ÿæ›´æ–°ã€‚</p><p>åœ¨ React ä¸­æœ€å¤šä¼šåŒæ—¶å­˜åœ¨ä¸¤æ£µ Fiber æ ‘ï¼Œå½“å‰åœ¨å±å¹•ä¸­æ˜¾ç¤ºçš„å†…å®¹å¯¹åº”çš„ Fiber æ ‘å«åš current Fiber æ ‘ï¼Œå½“å‘ç”Ÿæ›´æ–°æ—¶ï¼ŒReact ä¼šåœ¨å†…å­˜ä¸­é‡æ–°æ„å»ºä¸€é¢—æ–°çš„ Fiber æ ‘ï¼Œè¿™é¢—æ­£åœ¨æ„å»ºçš„ Fiber æ ‘å«åš workInProgress Fiber æ ‘ã€‚åœ¨åŒç¼“å­˜æŠ€æœ¯ä¸­ï¼ŒworkInProgress Fiber æ ‘å°±æ˜¯å³å°†è¦æ˜¾ç¤ºåœ¨é¡µé¢ä¸­çš„ Fiber æ ‘ï¼Œå½“è¿™é¢— Fiber æ ‘æ„å»ºå®Œæˆåï¼ŒReact ä¼šä½¿ç”¨å®ƒç›´æ¥æ›¿æ¢ current Fiber æ ‘è¾¾åˆ°å¿«é€Ÿæ›´æ–° DOM çš„ç›®çš„ï¼Œå› ä¸º workInProgress Fiber æ ‘æ˜¯åœ¨å†…å­˜ä¸­æ„å»ºçš„æ‰€ä»¥æ„å»ºå®ƒçš„é€Ÿåº¦æ˜¯éå¸¸å¿«çš„ã€‚</p><p>ä¸€æ—¦ workInProgress Fiber æ ‘åœ¨å±å¹•ä¸Šå‘ˆç°ï¼Œå®ƒå°±ä¼šå˜æˆ current Fiber æ ‘ã€‚</p><p>åœ¨ current Fiber èŠ‚ç‚¹å¯¹è±¡ä¸­æœ‰ä¸€ä¸ª alternate å±æ€§æŒ‡å‘å¯¹åº”çš„ workInProgress Fiber èŠ‚ç‚¹å¯¹è±¡ï¼Œåœ¨ workInProgress Fiber èŠ‚ç‚¹ä¸­æœ‰ä¸€ä¸ª alternate å±æ€§ä¹ŸæŒ‡å‘å¯¹åº”çš„ current Fiber èŠ‚ç‚¹å¯¹è±¡ã€‚</p><figure><img src="/blog/assets/images/react/sourceCode/3.png" alt="ç¤ºä¾‹" width="500" height="300" tabindex="0" loading="lazy"><figcaption>ç¤ºä¾‹</figcaption></figure><figure><img src="/blog/assets/images/react/sourceCode/4.png" alt="ç¤ºä¾‹" width="500" height="300" tabindex="0" loading="lazy"><figcaption>ç¤ºä¾‹</figcaption></figure><h3 id="_4-8-åŒºåˆ†-fiberroot-ä¸-rootfiber" tabindex="-1"><a class="header-anchor" href="#_4-8-åŒºåˆ†-fiberroot-ä¸-rootfiber"><span>4.8 åŒºåˆ† fiberRoot ä¸ rootFiber</span></a></h3><p>fiberRoot è¡¨ç¤º Fiber æ•°æ®ç»“æ„å¯¹è±¡ï¼Œæ˜¯ Fiber æ•°æ®ç»“æ„ä¸­çš„æœ€å¤–å±‚å¯¹è±¡</p><p>rootFiber è¡¨ç¤ºç»„ä»¶æŒ‚è½½ç‚¹å¯¹åº”çš„ Fiber å¯¹è±¡ï¼Œæ¯”å¦‚ React åº”ç”¨ä¸­é»˜è®¤çš„ç»„ä»¶æŒ‚è½½ç‚¹å°±æ˜¯ id ä¸º root çš„ div</p><p>fiberRoot åŒ…å« rootFiberï¼Œåœ¨ fiberRoot å¯¹è±¡ä¸­æœ‰ä¸€ä¸ª current å±æ€§ï¼Œå­˜å‚¨ rootFiber</p><p>rootFiber æŒ‡å‘ fiberRootï¼Œåœ¨ rootFiber å¯¹è±¡ä¸­æœ‰ä¸€ä¸ª stateNode å±æ€§ï¼ŒæŒ‡å‘ fiberRoot</p><p>åœ¨ React åº”ç”¨ä¸­ FiberRoot åªæœ‰ä¸€ä¸ªï¼Œè€Œ rootFiber å¯ä»¥æœ‰å¤šä¸ªï¼Œå› ä¸º render æ–¹æ³•æ˜¯å¯ä»¥è°ƒç”¨å¤šæ¬¡çš„</p><p>fiberRoot ä¼šè®°å½•åº”ç”¨çš„æ›´æ–°ä¿¡æ¯ï¼Œæ¯”å¦‚åè°ƒå™¨åœ¨å®Œæˆå·¥ä½œåï¼Œä¼šå°†å·¥ä½œæˆæœå­˜å‚¨åœ¨ fiberRoot ä¸­ã€‚</p><figure><img src="/blog/assets/images/react/sourceCode/7.png" alt="ç¤ºä¾‹" width="500" height="300" tabindex="0" loading="lazy"><figcaption>ç¤ºä¾‹</figcaption></figure><h2 id="_5-åˆå§‹åŒ–æ¸²æŸ“" tabindex="-1"><a class="header-anchor" href="#_5-åˆå§‹åŒ–æ¸²æŸ“"><span>5. åˆå§‹åŒ–æ¸²æŸ“</span></a></h2><p>è¦å°† React å…ƒç´ æ¸²æŸ“åˆ°é¡µé¢ä¸­ï¼Œåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œrender é˜¶æ®µå’Œ commit é˜¶æ®µã€‚</p><p>render é˜¶æ®µè´Ÿè´£åˆ›å»º Fiber æ•°æ®ç»“æ„å¹¶ä¸º Fiber èŠ‚ç‚¹æ‰“æ ‡è®°ï¼Œæ ‡è®°å½“å‰ Fiber èŠ‚ç‚¹è¦è¿›è¡Œçš„ DOM æ“ä½œã€‚</p><p>commit é˜¶æ®µè´Ÿè´£æ ¹æ® Fiber èŠ‚ç‚¹æ ‡è®° ( effectTag ) è¿›è¡Œç›¸åº”çš„ DOM æ“ä½œã€‚</p><h3 id="_5-1-render-é˜¶æ®µ" tabindex="-1"><a class="header-anchor" href="#_5-1-render-é˜¶æ®µ"><span>5.1 render é˜¶æ®µ</span></a></h3><h4 id="_5-1-1-render" tabindex="-1"><a class="header-anchor" href="#_5-1-1-render"><span>5.1.1 render</span></a></h4><p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react-dom/src/client/ReactDOMLegacy.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">/**
 * æ¸²æŸ“å…¥å£
 * element è¦è¿›è¡Œæ¸²æŸ“çš„ ReactElement, createElement æ–¹æ³•çš„è¿”å›å€¼
 * container æ¸²æŸ“å®¹å™¨ &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;
 * callback æ¸²æŸ“å®Œæˆåæ‰§è¡Œçš„å›è°ƒå‡½æ•°
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span>
  <span class="token literal-property property">element</span><span class="token operator">:</span> React$Element<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>any</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">,
  container: Container,
  callback: ?Function,
) </span><span class="token punctuation">{</span>
  <span class="token comment">// æ£€æµ‹ container æ˜¯å¦æ˜¯ç¬¦åˆè¦æ±‚çš„æ¸²æŸ“å®¹å™¨</span>
  <span class="token comment">// å³æ£€æµ‹ container æ˜¯å¦æ˜¯çœŸå®çš„DOMå¯¹è±¡</span>
  <span class="token comment">// å¦‚æœä¸ç¬¦åˆè¦æ±‚å°±æŠ¥é”™</span>
  <span class="token function">invariant</span><span class="token punctuation">(</span>
    <span class="token function">isValidContainer</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">&#39;Target container is not a DOM element.&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">legacyRenderSubtreeIntoContainer</span><span class="token punctuation">(</span>
    <span class="token comment">// çˆ¶ç»„ä»¶ åˆå§‹æ¸²æŸ“æ²¡æœ‰çˆ¶ç»„ä»¶ ä¼ é€’ null å ä½</span>
    <span class="token keyword">null</span><span class="token punctuation">,</span>
    element<span class="token punctuation">,</span>
    container<span class="token punctuation">,</span>
    <span class="token comment">// æ˜¯å¦ä¸ºæœåŠ¡å™¨ç«¯æ¸²æŸ“ false ä¸æ˜¯æœåŠ¡å™¨ç«¯æ¸²æŸ“ true æ˜¯æœåŠ¡å™¨ç«¯æ¸²æŸ“</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    callback<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token plain-text">
</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-1-2-isvalidcontainer" tabindex="-1"><a class="header-anchor" href="#_5-1-2-isvalidcontainer"><span>5.1.2 isValidContainer</span></a></h4><p><code>æ–‡ä»¶ä½ç½®ï¼špackages/react-dom/src/client/ReactDOMRoot.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">/**
 * åˆ¤æ–­ node æ˜¯å¦æ˜¯ç¬¦åˆè¦æ±‚çš„ DOM èŠ‚ç‚¹
 * 1. node å¯ä»¥æ˜¯å…ƒç´ èŠ‚ç‚¹
 * 2. node å¯ä»¥æ˜¯ document èŠ‚ç‚¹
 * 3. node å¯ä»¥æ˜¯ æ–‡æ¡£ç¢ç‰‡èŠ‚ç‚¹
 * 4. node å¯ä»¥æ˜¯æ³¨é‡ŠèŠ‚ç‚¹ä½†æ³¨é‡Šå†…å®¹å¿…é¡»æ˜¯ react-mount-point-unstable
 * 		react å†…éƒ¨ä¼šæ‰¾åˆ°æ³¨é‡ŠèŠ‚ç‚¹çš„çˆ¶çº§ é€šè¿‡è°ƒç”¨çˆ¶çº§å…ƒç´ çš„ insertBefore æ–¹æ³•, å°† element æ’å…¥åˆ°æ³¨é‡ŠèŠ‚ç‚¹çš„å‰é¢
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isValidContainer</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">node</span><span class="token operator">:</span> mixed</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>
    node <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span>node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token constant">ELEMENT_NODE</span> <span class="token operator">||</span>
      node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token constant">DOCUMENT_NODE</span> <span class="token operator">||</span>
      node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token constant">DOCUMENT_FRAGMENT_NODE</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span>node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token constant">COMMENT_NODE</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>node<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>nodeValue <span class="token operator">===</span> <span class="token string">&#39; react-mount-point-unstable &#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-1-3-åˆå§‹åŒ–-fiberroot" tabindex="-1"><a class="header-anchor" href="#_5-1-3-åˆå§‹åŒ–-fiberroot"><span>5.1.3 åˆå§‹åŒ– FiberRoot</span></a></h4><h5 id="_5-1-3-1-legacyrendersubtreeintocontainer" tabindex="-1"><a class="header-anchor" href="#_5-1-3-1-legacyrendersubtreeintocontainer"><span>5.1.3.1 legacyRenderSubtreeIntoContainer</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-dom/src/client/ReactDOMLegacy.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">/**
 * å°†å­æ ‘æ¸²æŸ“åˆ°å®¹å™¨ä¸­ (åˆå§‹åŒ– Fiber æ•°æ®ç»“æ„: åˆ›å»º fiberRoot åŠ rootFiber)
 * parentComponent: çˆ¶ç»„ä»¶, åˆå§‹æ¸²æŸ“ä¼ å…¥äº† null
 * children: render æ–¹æ³•ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°, è¦æ¸²æŸ“çš„ ReactElement
 * container: æ¸²æŸ“å®¹å™¨
 * forceHydrate: true ä¸ºæœåŠ¡ç«¯æ¸²æŸ“, false ä¸ºå®¢æˆ·ç«¯æ¸²æŸ“
 * callback: ç»„ä»¶æ¸²æŸ“å®Œæˆåéœ€è¦æ‰§è¡Œçš„å›è°ƒå‡½æ•°
 **/</span>
<span class="token keyword">function</span> <span class="token function">legacyRenderSubtreeIntoContainer</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">parentComponent</span><span class="token operator">:</span> <span class="token operator">?</span>React$Component<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">children</span><span class="token operator">:</span> ReactNodeList<span class="token punctuation">,</span>
  <span class="token literal-property property">container</span><span class="token operator">:</span> Container<span class="token punctuation">,</span>
  <span class="token literal-property property">forceHydrate</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  <span class="token literal-property property">callback</span><span class="token operator">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * æ£€æµ‹ container æ˜¯å¦å·²ç»æ˜¯åˆå§‹åŒ–è¿‡çš„æ¸²æŸ“å®¹å™¨
   * react åœ¨åˆå§‹æ¸²æŸ“æ—¶ä¼šä¸ºæœ€å¤–å±‚å®¹å™¨æ·»åŠ  _reactRootContainer å±æ€§
   * react ä¼šæ ¹æ®æ­¤å±æ€§è¿›è¡Œä¸åŒçš„æ¸²æŸ“æ–¹å¼
   * root ä¸å­˜åœ¨ è¡¨ç¤ºåˆå§‹æ¸²æŸ“
   * root å­˜åœ¨ è¡¨ç¤ºæ›´æ–°
   */</span>
  <span class="token comment">// è·å– container å®¹å™¨å¯¹è±¡ä¸‹æ˜¯å¦æœ‰ _reactRootContainer å±æ€§</span>
  <span class="token keyword">let</span> <span class="token literal-property property">root</span><span class="token operator">:</span> RootType <span class="token operator">=</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>_reactRootContainer<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å³å°†å­˜å‚¨æ ¹ Fiber å¯¹è±¡</span>
  <span class="token keyword">let</span> fiberRoot<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆå§‹æ¸²æŸ“</span>
    <span class="token comment">// åˆå§‹åŒ–æ ¹ Fiber æ•°æ®ç»“æ„</span>
    <span class="token comment">// ä¸º container å®¹å™¨æ·»åŠ  _reactRootContainer å±æ€§</span>
    <span class="token comment">// åœ¨ _reactRootContainer å¯¹è±¡ä¸­æœ‰ä¸€ä¸ªå±æ€§å«åš _internalRoot</span>
    <span class="token comment">// _internalRoot å±æ€§å€¼å³ä¸º FiberRoot è¡¨ç¤ºæ ¹èŠ‚ç‚¹ Fiber æ•°æ®ç»“æ„</span>
    <span class="token comment">// legacyCreateRootFromDOMContainer</span>
    <span class="token comment">// createLegacyRoot</span>
    <span class="token comment">// new ReactDOMBlockingRoot -&gt; this._internalRoot</span>
    <span class="token comment">// createRootImpl</span>
    root <span class="token operator">=</span> container<span class="token punctuation">.</span>_reactRootContainer <span class="token operator">=</span> <span class="token function">legacyCreateRootFromDOMContainer</span><span class="token punctuation">(</span>
      container<span class="token punctuation">,</span>
      forceHydrate<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å– Fiber Root å¯¹è±¡</span>
    fiberRoot <span class="token operator">=</span> root<span class="token punctuation">.</span>_internalRoot<span class="token punctuation">;</span>
    <span class="token comment">/**
     * æ”¹å˜ callback å‡½æ•°ä¸­çš„ this æŒ‡å‘
     * ä½¿å…¶æŒ‡å‘ render æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°çš„çœŸå® DOM å¯¹è±¡
     */</span>
    <span class="token comment">// å¦‚æœ callback å‚æ•°æ˜¯å‡½æ•°ç±»å‹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> callback <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ä½¿ç”¨ originalCallback å­˜å‚¨ callback å‡½æ•°</span>
      <span class="token keyword">const</span> originalCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
      <span class="token comment">// ä¸º callback å‚æ•°é‡æ–°èµ‹å€¼</span>
      <span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å– render æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°çš„çœŸå® DOM å¯¹è±¡</span>
        <span class="token comment">// å®é™…ä¸Šå°±æ˜¯ id=&quot;root&quot; çš„ div çš„å­å…ƒç´ </span>
        <span class="token comment">// rootFiber.child.stateNode</span>
        <span class="token comment">// rootFiber å°±æ˜¯ id=&quot;root&quot; çš„ div</span>
        <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">getPublicRootInstance</span><span class="token punctuation">(</span>fiberRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è°ƒç”¨ callback å‡½æ•°å¹¶æ”¹å˜å‡½æ•°å†…éƒ¨ this æŒ‡å‘</span>
        <span class="token function">originalCallback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// åˆå§‹åŒ–æ¸²æŸ“ä¸æ‰§è¡Œæ‰¹é‡æ›´æ–°</span>
    <span class="token comment">// å› ä¸ºæ‰¹é‡æ›´æ–°æ˜¯å¼‚æ­¥çš„æ˜¯å¯ä»¥è¢«æ‰“æ–­çš„, ä½†æ˜¯åˆå§‹åŒ–æ¸²æŸ“åº”è¯¥å°½å¿«å®Œæˆä¸èƒ½è¢«æ‰“æ–­</span>
    <span class="token comment">// æ‰€ä»¥ä¸æ‰§è¡Œæ‰¹é‡æ›´æ–°</span>
    <span class="token function">unbatchedUpdates</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">updateContainer</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> fiberRoot<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// éåˆå§‹åŒ–æ¸²æŸ“ å³æ›´æ–°</span>
    fiberRoot <span class="token operator">=</span> root<span class="token punctuation">.</span>_internalRoot<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> callback <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> originalCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
      <span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">getPublicRootInstance</span><span class="token punctuation">(</span>fiberRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">originalCallback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Update</span>
    <span class="token function">updateContainer</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> fiberRoot<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// è¿”å› render æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°çš„çœŸå® DOM å¯¹è±¡ä½œä¸º render æ–¹æ³•çš„è¿”å›å€¼</span>
  <span class="token comment">// å°±æ˜¯è¯´æ¸²æŸ“è° è¿”å›è°çš„çœŸå® DOM å¯¹è±¡</span>
  <span class="token keyword">return</span> <span class="token function">getPublicRootInstance</span><span class="token punctuation">(</span>fiberRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="/blog/assets/images/react/sourceCode/5.png" alt="ç¤ºä¾‹" width="500" height="300" tabindex="0" loading="lazy"><figcaption>ç¤ºä¾‹</figcaption></figure><h5 id="_5-1-3-2-legacycreaterootfromdomcontainer" tabindex="-1"><a class="header-anchor" href="#_5-1-3-2-legacycreaterootfromdomcontainer"><span>5.1.3.2 legacyCreateRootFromDOMContainer</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-dom/src/client/ReactDOMLegacy.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">/**
 * åˆ¤æ–­æ˜¯å¦ä¸ºæœåŠ¡å™¨ç«¯æ¸²æŸ“ å¦‚æœä¸æ˜¯æœåŠ¡å™¨ç«¯æ¸²æŸ“
 * æ¸…ç©º container å®¹å™¨ä¸­çš„èŠ‚ç‚¹
 */</span>
<span class="token keyword">function</span> <span class="token function">legacyCreateRootFromDOMContainer</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">container</span><span class="token operator">:</span> Container<span class="token punctuation">,</span>
  <span class="token literal-property property">forceHydrate</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> RootType <span class="token punctuation">{</span>
  <span class="token comment">// container =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span>
  <span class="token comment">// æ£€æµ‹æ˜¯å¦ä¸ºæœåŠ¡å™¨ç«¯æ¸²æŸ“</span>
  <span class="token keyword">const</span> shouldHydrate <span class="token operator">=</span>
    forceHydrate <span class="token operator">||</span> <span class="token function">shouldHydrateDueToLegacyHeuristic</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å¦‚æœä¸æ˜¯æœåŠ¡å™¨ç«¯æ¸²æŸ“</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldHydrate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> rootSibling<span class="token punctuation">;</span>
    <span class="token comment">// å¼€å¯å¾ªç¯ åˆ é™¤ container å®¹å™¨ä¸­çš„èŠ‚ç‚¹</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rootSibling <span class="token operator">=</span> container<span class="token punctuation">.</span>lastChild<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// åˆ é™¤ container å®¹å™¨ä¸­çš„èŠ‚ç‚¹</span>
      container<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>rootSibling<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">/**
       * ä¸ºä»€ä¹ˆè¦æ¸…é™¤ container ä¸­çš„å…ƒç´  ?
       * ä¸ºæä¾›é¦–å±åŠ è½½çš„ç”¨æˆ·ä½“éªŒ, æœ‰æ—¶éœ€è¦åœ¨ container ä¸­æ”¾ç½®ä¸€äº›å ä½å›¾æˆ–è€… loading å›¾
       * å°±æ— å¯é¿å…çš„è¦å‘ container ä¸­åŠ å…¥ html æ ‡è®°.
       * åœ¨å°† ReactElement æ¸²æŸ“åˆ° container ä¹‹å‰, å¿…ç„¶è¦å…ˆæ¸…ç©º container
       * å› ä¸ºå ä½å›¾å’Œ ReactElement ä¸èƒ½åŒæ—¶æ˜¾ç¤º
       *
       * åœ¨åŠ å…¥å ä½ä»£ç æ—¶, æœ€å¥½åªæœ‰ä¸€ä¸ªçˆ¶çº§å…ƒç´ , å¯ä»¥å‡å°‘å†…éƒ¨ä»£ç çš„å¾ªç¯æ¬¡æ•°ä»¥æé«˜æ€§èƒ½
       * &lt;div&gt;
       *  &lt;p&gt;placement&lt;p&gt;
       *  &lt;p&gt;placement&lt;p&gt;
       *  &lt;p&gt;placement&lt;p&gt;
       * &lt;/div&gt;
       */</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">createLegacyRoot</span><span class="token punctuation">(</span>
    container<span class="token punctuation">,</span>
    shouldHydrate
      <span class="token operator">?</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">hydrate</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
      <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-1-3-3-createlegacyroot" tabindex="-1"><a class="header-anchor" href="#_5-1-3-3-createlegacyroot"><span>5.1.3.3 createLegacyRoot</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-dom/src/client/ReactDOMRoot.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">/**
 * é€šè¿‡å®ä¾‹åŒ– ReactDOMBlockingRoot ç±»åˆ›å»º LegacyRoot
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createLegacyRoot</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">container</span><span class="token operator">:</span> Container<span class="token punctuation">,</span>
  options<span class="token operator">?</span><span class="token operator">:</span> RootOptions<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> RootType <span class="token punctuation">{</span>
  <span class="token comment">// container =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span>
  <span class="token comment">// LegacyRoot å¸¸é‡, å€¼ä¸º 0,</span>
  <span class="token comment">// é€šè¿‡ render æ–¹æ³•åˆ›å»ºçš„ container å°±æ˜¯ LegacyRoot</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReactDOMBlockingRoot</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> LegacyRoot<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-1-3-3-reactdomblockingroot" tabindex="-1"><a class="header-anchor" href="#_5-1-3-3-reactdomblockingroot"><span>5.1.3.3 ReactDOMBlockingRoot</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-dom/src/client/ReactDOMRoot.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">/**
 * ç±», é€šè¿‡å®ƒå¯ä»¥åˆ›å»º LegacyRoot çš„ Fiber æ•°æ®ç»“æ„
 */</span>
<span class="token keyword">function</span> <span class="token function">ReactDOMBlockingRoot</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">container</span><span class="token operator">:</span> Container<span class="token punctuation">,</span>
  <span class="token literal-property property">tag</span><span class="token operator">:</span> RootTag<span class="token punctuation">,</span>
  <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">|</span> RootOptions<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// tag =&gt; 0 =&gt; legacyRoot</span>
  <span class="token comment">// container =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span>
  <span class="token comment">// container._reactRootContainer = {_internalRoot: {}}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_internalRoot <span class="token operator">=</span> <span class="token function">createRootImpl</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-1-3-4-createrootimpl" tabindex="-1"><a class="header-anchor" href="#_5-1-3-4-createrootimpl"><span>5.1.3.4 createRootImpl</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-dom/src/client/ReactDOMRoot.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code>
<span class="token keyword">function</span> <span class="token function">createRootImpl</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">container</span><span class="token operator">:</span> Container<span class="token punctuation">,</span>
  <span class="token literal-property property">tag</span><span class="token operator">:</span> RootTag<span class="token punctuation">,</span>
  <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">|</span> RootOptions<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// container =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span>
  <span class="token comment">// tag =&gt; 0</span>
  <span class="token comment">// options =&gt; undefined</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">createContainer</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> hydrate<span class="token punctuation">,</span> hydrationCallbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">markContainerAsRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>current<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> root<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-1-3-5-createcontainer" tabindex="-1"><a class="header-anchor" href="#_5-1-3-5-createcontainer"><span>5.1.3.5 createContainer</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberReconciler.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">// åˆ›å»º container</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createContainer</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">containerInfo</span><span class="token operator">:</span> Container<span class="token punctuation">,</span>
  <span class="token literal-property property">tag</span><span class="token operator">:</span> RootTag<span class="token punctuation">,</span>
  <span class="token literal-property property">hydrate</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  <span class="token literal-property property">hydrationCallbacks</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> SuspenseHydrationCallbacks<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> OpaqueRoot <span class="token punctuation">{</span>
  <span class="token comment">// containerInfo =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span>
  <span class="token comment">// tag: 0</span>
  <span class="token comment">// hydrate: false</span>
  <span class="token comment">// hydrationCallbacks: null</span>
  <span class="token comment">// å¿½ç•¥äº†å’ŒæœåŠ¡å™¨ç«¯æ¸²æŸ“ç›¸å…³çš„å†…å®¹</span>
  <span class="token keyword">return</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span>containerInfo<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> hydrate<span class="token punctuation">,</span> hydrationCallbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-1-3-6-createfiberroot" tabindex="-1"><a class="header-anchor" href="#_5-1-3-6-createfiberroot"><span>5.1.3.6 createFiberRoot</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberRoot.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">// åˆ›å»ºæ ¹èŠ‚ç‚¹å¯¹åº”çš„ fiber å¯¹è±¡</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">containerInfo</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  <span class="token literal-property property">tag</span><span class="token operator">:</span> RootTag<span class="token punctuation">,</span>
  <span class="token literal-property property">hydrate</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  <span class="token literal-property property">hydrationCallbacks</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> SuspenseHydrationCallbacks<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> FiberRoot <span class="token punctuation">{</span>
  <span class="token comment">// åˆ›å»º FiberRoot</span>
  <span class="token keyword">const</span> <span class="token literal-property property">root</span><span class="token operator">:</span> FiberRoot <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FiberRootNode</span><span class="token punctuation">(</span>containerInfo<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> hydrate<span class="token punctuation">)</span><span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// åˆ›å»ºæ ¹èŠ‚ç‚¹å¯¹åº”çš„ rootFiber</span>
  <span class="token keyword">const</span> uninitializedFiber <span class="token operator">=</span> <span class="token function">createHostRootFiber</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ä¸º fiberRoot æ·»åŠ  current å±æ€§ å€¼ä¸º rootFiber</span>
  root<span class="token punctuation">.</span>current <span class="token operator">=</span> uninitializedFiber<span class="token punctuation">;</span>
  <span class="token comment">// ä¸º rootFiber æ·»åŠ  stateNode å±æ€§ å€¼ä¸º fiberRoot</span>
  uninitializedFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> root<span class="token punctuation">;</span>
  <span class="token comment">// ä¸º fiber å¯¹è±¡æ·»åŠ  updateQueue å±æ€§, åˆå§‹åŒ– updateQueue å¯¹è±¡</span>
  <span class="token comment">// updateQueue ç”¨äºå­˜æ”¾ Update å¯¹è±¡</span>
  <span class="token comment">// Update å¯¹è±¡ç”¨äºè®°å½•ç»„ä»¶çŠ¶æ€çš„æ”¹å˜</span>
  <span class="token function">initializeUpdateQueue</span><span class="token punctuation">(</span>uninitializedFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è¿”å› root</span>
  <span class="token keyword">return</span> root<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-1-3-7-fiberrootnode" tabindex="-1"><a class="header-anchor" href="#_5-1-3-7-fiberrootnode"><span>5.1.3.7 FiberRootNode</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberRoot.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">FiberRootNode</span><span class="token punctuation">(</span><span class="token parameter">containerInfo<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> hydrate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>containerInfo <span class="token operator">=</span> containerInfo<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>pendingChildren <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>pingCache <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>finishedExpirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>timeoutHandle <span class="token operator">=</span> noTimeout<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>pendingContext <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>hydrate <span class="token operator">=</span> hydrate<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>callbackNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>callbackPriority <span class="token operator">=</span> NoPriority<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>firstPendingTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>firstSuspendedTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>lastSuspendedTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>nextKnownPendingLevel <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>lastPingedTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>lastExpiredTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableSchedulerTracing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>interactionThreadID <span class="token operator">=</span> <span class="token function">unstable_getThreadID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedInteractions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pendingInteractionMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableSuspenseCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hydrationCallbacks <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-3-1-8-initializeupdatequeue" tabindex="-1"><a class="header-anchor" href="#_5-3-1-8-initializeupdatequeue"><span>5.3.1.8 initializeUpdateQueue</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberRoot.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token keyword">export</span> <span class="token keyword">function</span> initializeUpdateQueue<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">State</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">(fiber: Fiber): void </span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token literal-property property">queue</span><span class="token operator">:</span> UpdateQueue<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">State</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> = </span><span class="token punctuation">{</span>
    <span class="token literal-property property">baseState</span><span class="token operator">:</span> fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span>
    <span class="token literal-property property">baseQueue</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token literal-property property">shared</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">pending</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">effects</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token plain-text">;
  fiber.updateQueue = queue;
}
</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-1-4-è·å–-rootfiber-child-å®ä¾‹å¯¹è±¡" tabindex="-1"><a class="header-anchor" href="#_5-1-4-è·å–-rootfiber-child-å®ä¾‹å¯¹è±¡"><span>5.1.4 è·å– rootFiber.child å®ä¾‹å¯¹è±¡</span></a></h4><h5 id="_5-1-4-1-getpublicrootinstance" tabindex="-1"><a class="header-anchor" href="#_5-1-4-1-getpublicrootinstance"><span>5.1.4.1 getPublicRootInstance</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberReconciler.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">/**
 * è·å– container çš„ç¬¬ä¸€ä¸ªå­å…ƒç´ çš„å®ä¾‹å¯¹è±¡
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getPublicRootInstance</span><span class="token punctuation">(</span>
  <span class="token comment">// FiberRoot</span>
  <span class="token literal-property property">container</span><span class="token operator">:</span> OpaqueRoot<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> React$Component<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">&gt;</span> <span class="token operator">|</span> PublicInstance <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token comment">// è·å– rootFiber</span>
  <span class="token keyword">const</span> containerFiber <span class="token operator">=</span> container<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
  <span class="token comment">// å¦‚æœ rootFiber æ²¡æœ‰å­å…ƒç´ </span>
  <span class="token comment">// æŒ‡çš„å°±æ˜¯ id=&quot;root&quot; çš„ div æ²¡æœ‰å­å…ƒç´ </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>containerFiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿”å› null</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// åŒ¹é…å­å…ƒç´ çš„ç±»å‹</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>containerFiber<span class="token punctuation">.</span>child<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ™®é€š</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostComponent</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">getPublicInstance</span><span class="token punctuation">(</span>containerFiber<span class="token punctuation">.</span>child<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token comment">// è¿”å›å­å…ƒç´ çš„çœŸå® DOM å¯¹è±¡</span>
      <span class="token keyword">return</span> containerFiber<span class="token punctuation">.</span>child<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-1-4-2-getpublicinstance" tabindex="-1"><a class="header-anchor" href="#_5-1-4-2-getpublicinstance"><span>5.1.4.2 getPublicInstance</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-dom/src/client/ReactDOMHostConfig.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getPublicInstance</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">instance</span><span class="token operator">:</span> Instance</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">*</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-1-5-updatecontainer" tabindex="-1"><a class="header-anchor" href="#_5-1-5-updatecontainer"><span>5.1.5 updateContainer</span></a></h4><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberReconciler.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">/**
 * è®¡ç®—ä»»åŠ¡çš„è¿‡æœŸæ—¶é—´
 * å†æ ¹æ®ä»»åŠ¡è¿‡æœŸæ—¶é—´åˆ›å»º Update ä»»åŠ¡
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">updateContainer</span><span class="token punctuation">(</span>
	<span class="token comment">// element è¦æ¸²æŸ“çš„ ReactElement</span>
  <span class="token literal-property property">element</span><span class="token operator">:</span> ReactNodeList<span class="token punctuation">,</span>
  <span class="token comment">// container Fiber Root å¯¹è±¡</span>
  <span class="token literal-property property">container</span><span class="token operator">:</span> OpaqueRoot<span class="token punctuation">,</span>
  <span class="token comment">// parentComponent çˆ¶ç»„ä»¶ åˆå§‹æ¸²æŸ“ä¸º null</span>
  <span class="token literal-property property">parentComponent</span><span class="token operator">:</span> <span class="token operator">?</span>React$Component<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token comment">// ReactElement æ¸²æŸ“å®Œæˆæ‰§è¡Œçš„å›è°ƒå‡½æ•°</span>
  <span class="token literal-property property">callback</span><span class="token operator">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> ExpirationTime <span class="token punctuation">{</span>  
  <span class="token comment">// container è·å– rootFiber</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> container<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
  <span class="token comment">// è·å–å½“å‰è·ç¦» react åº”ç”¨åˆå§‹åŒ–çš„æ—¶é—´ 1073741805</span>
  <span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">requestCurrentTimeForUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å¼‚æ­¥åŠ è½½è®¾ç½®</span>
  <span class="token keyword">const</span> suspenseConfig <span class="token operator">=</span> <span class="token function">requestCurrentSuspenseConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// è®¡ç®—è¿‡æœŸæ—¶é—´</span>
  <span class="token comment">// ä¸ºé˜²æ­¢ä»»åŠ¡å› ä¸ºä¼˜å…ˆçº§çš„åŸå› ä¸€ç›´è¢«æ‰“æ–­è€Œæœªèƒ½æ‰§è¡Œ</span>
  <span class="token comment">// react ä¼šè®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´, å½“æ—¶é—´åˆ°äº†è¿‡æœŸæ—¶é—´çš„æ—¶å€™</span>
  <span class="token comment">// å¦‚æœä»»åŠ¡è¿˜æœªæ‰§è¡Œçš„è¯, react å°†ä¼šå¼ºåˆ¶æ‰§è¡Œè¯¥ä»»åŠ¡</span>
  <span class="token comment">// åˆå§‹åŒ–æ¸²æŸ“æ—¶, ä»»åŠ¡åŒæ­¥æ‰§è¡Œä¸æ¶‰åŠè¢«æ‰“æ–­çš„é—®é¢˜ 1073741823</span>
  <span class="token keyword">const</span> expirationTime <span class="token operator">=</span> <span class="token function">computeExpirationForFiber</span><span class="token punctuation">(</span>
    currentTime<span class="token punctuation">,</span>
    current<span class="token punctuation">,</span>
    suspenseConfig<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è®¾ç½®FiberRoot.context, é¦–æ¬¡æ‰§è¡Œè¿”å›ä¸€ä¸ªemptyContext, æ˜¯ä¸€ä¸ª {}</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">getContextForSubtree</span><span class="token punctuation">(</span>parentComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// åˆå§‹æ¸²æŸ“æ—¶ Fiber Root å¯¹è±¡ä¸­çš„ context å±æ€§å€¼ä¸º null</span>
  <span class="token comment">// æ‰€ä»¥ä¼šè¿›å…¥åˆ° if ä¸­</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>context <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆå§‹æ¸²æŸ“æ—¶å°† context å±æ€§å€¼è®¾ç½®ä¸º {}</span>
    container<span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    container<span class="token punctuation">.</span>pendingContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// åˆ›å»ºä¸€ä¸ªå¾…æ‰§è¡Œä»»åŠ¡</span>
  <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>expirationTime<span class="token punctuation">,</span> suspenseConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å°†è¦æ›´æ–°çš„å†…å®¹æŒ‚è½½åˆ°æ›´æ–°å¯¹è±¡ä¸­çš„ payload ä¸­</span>
  <span class="token comment">// å°†è¦æ›´æ–°çš„ç»„ä»¶å­˜å‚¨åœ¨ payload å¯¹è±¡ä¸­, æ–¹ä¾¿åæœŸè·å–</span>
  update<span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token punctuation">{</span>element<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// åˆ¤æ–­ callback æ˜¯å¦å­˜åœ¨</span>
  callback <span class="token operator">=</span> callback <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> callback<span class="token punctuation">;</span>
  <span class="token comment">// å¦‚æœ callback å­˜åœ¨</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°† callback æŒ‚è½½åˆ° update å¯¹è±¡ä¸­</span>
    <span class="token comment">// å…¶å®å°±æ˜¯ä¸€å±‚å±‚ä¼ é€’ æ–¹ä¾¿ ReactElement å…ƒç´ æ¸²æŸ“å®Œæˆè°ƒç”¨</span>
    <span class="token comment">// å›è°ƒå‡½æ•°æ‰§è¡Œå®Œæˆåä¼šè¢«æ¸…é™¤ å¯ä»¥åœ¨ä»£ç çš„åé¢åŠ ä¸Š return è¿›è¡ŒéªŒè¯</span>
    update<span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å°† update å¯¹è±¡åŠ å…¥åˆ°å½“å‰ Fiber çš„æ›´æ–°é˜Ÿåˆ—å½“ä¸­ (updateQueue)</span>
  <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è°ƒåº¦å’Œæ›´æ–° current å¯¹è±¡</span>
  <span class="token function">scheduleWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è¿”å›è¿‡æœŸæ—¶é—´</span>
  <span class="token keyword">return</span> expirationTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-1-6-enqueueupdate" tabindex="-1"><a class="header-anchor" href="#_5-1-6-enqueueupdate"><span>5.1.6 enqueueUpdate</span></a></h4><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactUpdateQueue.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">// å°†ä»»åŠ¡(Update)å­˜æ”¾äºä»»åŠ¡é˜Ÿåˆ—(updateQueue)ä¸­</span>
<span class="token comment">// åˆ›å»ºå•å‘é“¾è¡¨ç»“æ„å­˜æ”¾ update, next ç”¨æ¥ä¸²è” update</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> enqueueUpdate<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">State</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">(fiber: Fiber, update: Update</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">State</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">) </span><span class="token punctuation">{</span>
  <span class="token comment">// è·å–å½“å‰ Fiber çš„ æ›´æ–°é˜Ÿåˆ—</span>
  <span class="token keyword">const</span> updateQueue <span class="token operator">=</span> fiber<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
  <span class="token comment">// å¦‚æœæ›´æ–°é˜Ÿåˆ—ä¸å­˜åœ¨ å°±è¿”å› null</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>updateQueue <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä»…å‘ç”Ÿåœ¨ fiber å·²ç»è¢«å¸è½½</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// è·å–å¾…æ‰§è¡Œçš„ Update ä»»åŠ¡</span>
  <span class="token comment">// åˆå§‹æ¸²æŸ“æ—¶æ²¡æœ‰å¾…æ‰§è¡Œçš„ä»»åŠ¡</span>
  <span class="token keyword">const</span> sharedQueue <span class="token operator">=</span> updateQueue<span class="token punctuation">.</span>shared<span class="token punctuation">;</span>
  <span class="token keyword">const</span> pending <span class="token operator">=</span> sharedQueue<span class="token punctuation">.</span>pending<span class="token punctuation">;</span>
  <span class="token comment">// å¦‚æœæ²¡æœ‰å¾…æ‰§è¡Œçš„ Update ä»»åŠ¡</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pending <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿™æ˜¯ç¬¬ä¸€æ¬¡æ›´æ–°, åˆ›å»ºä¸€ä¸ªå¾ªç¯åˆ—è¡¨.</span>
    update<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    update<span class="token punctuation">.</span>next <span class="token operator">=</span> pending<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    pending<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å°† Update ä»»åŠ¡å­˜å‚¨åœ¨ pending å±æ€§ä¸­</span>
  sharedQueue<span class="token punctuation">.</span>pending <span class="token operator">=</span> update<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token plain-text">
</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-1-7-scheduleupdateonfiber" tabindex="-1"><a class="header-anchor" href="#_5-1-7-scheduleupdateonfiber"><span>5.1.7 scheduleUpdateOnFiber</span></a></h4><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">/**
 * åˆ¤æ–­ä»»åŠ¡æ˜¯å¦ä¸ºåŒæ­¥ è°ƒç”¨åŒæ­¥ä»»åŠ¡å…¥å£
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>
  <span class="token comment">// rootFiber</span>
  <span class="token literal-property property">fiber</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token literal-property property">expirationTime</span><span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * fiber: åˆå§‹åŒ–æ¸²æŸ“æ—¶ä¸º rootFiber, å³ &lt;div id=&quot;root&quot;&gt;&lt;/div&gt; å¯¹åº”çš„ Fiber å¯¹è±¡
   * expirationTime: ä»»åŠ¡è¿‡æœŸæ—¶é—´ =&gt;1073741823
   */</span>
  <span class="token comment">/**
   * åˆ¤æ–­æ˜¯å¦æ˜¯æ— é™å¾ªç¯çš„ update å¦‚æœæ˜¯å°±æŠ¥é”™
   * åœ¨ componentWillUpdate æˆ–è€… componentDidUpdate ç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¸­é‡å¤è°ƒç”¨
   * setState æ–¹æ³•æ—¶, å¯èƒ½ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µ, React é™åˆ¶äº†åµŒå¥—æ›´æ–°çš„æ•°é‡ä»¥é˜²æ­¢æ— é™å¾ªç¯
   * é™åˆ¶çš„åµŒå¥—æ›´æ–°æ•°é‡ä¸º 50, å¯é€šè¿‡ NESTED_UPDATE_LIMIT å…¨å±€å˜é‡è·å–
   */</span>
  <span class="token function">checkForNestedUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// åˆ¤æ–­ä»»åŠ¡æ˜¯å¦æ˜¯åŒæ­¥ä»»åŠ¡ Syncçš„å€¼ä¸º: 1073741823</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>expirationTime <span class="token operator">===</span> Sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token comment">// æ£€æŸ¥æ˜¯å¦å¤„äºéæ‰¹é‡æ›´æ–°æ¨¡å¼</span>
      <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> LegacyUnbatchedContext<span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext <span class="token operator">&amp;&amp;</span>
      <span class="token comment">// æ£€æŸ¥æ˜¯å¦æ²¡æœ‰å¤„äºæ­£åœ¨è¿›è¡Œæ¸²æŸ“çš„ä»»åŠ¡</span>
      <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> <span class="token punctuation">(</span>RenderContext <span class="token operator">|</span> CommitContext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> NoContext
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// åŒæ­¥ä»»åŠ¡å…¥å£ç‚¹</span>
      <span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token comment">// å¿½ç•¥äº†ä¸€äº›åˆå§‹åŒ–æ¸²æŸ“ä¸ä¼šå¾—åˆ°æ‰§è¡Œçš„ä»£ç </span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-1-8-æ„å»º-fiber-å¯¹è±¡" tabindex="-1"><a class="header-anchor" href="#_5-1-8-æ„å»º-fiber-å¯¹è±¡"><span>5.1.8 æ„å»º Fiber å¯¹è±¡</span></a></h4><h5 id="_5-1-8-1-performsyncworkonroot" tabindex="-1"><a class="header-anchor" href="#_5-1-8-1-performsyncworkonroot"><span>5.1.8.1 performSyncWorkOnRoot</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">// è¿›å…¥ render é˜¶æ®µ, æ„å»º workInProgress Fiber æ ‘</span>
<span class="token keyword">function</span> <span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// å‚æ•° root ä¸º fiberRoot å¯¹è±¡</span>
  <span class="token comment">// æ£€æŸ¥æ˜¯å¦æœ‰è¿‡æœŸçš„ä»»åŠ¡</span>
  <span class="token comment">// å¦‚æœæ²¡æœ‰è¿‡æœŸçš„ä»»åŠ¡ å€¼ä¸º 0</span>
  <span class="token comment">// åˆå§‹åŒ–æ¸²æŸ“æ²¡æœ‰è¿‡æœŸçš„ä»»åŠ¡å¾…æ‰§è¡Œ</span>
  <span class="token keyword">const</span> lastExpiredTime <span class="token operator">=</span> root<span class="token punctuation">.</span>lastExpiredTime<span class="token punctuation">;</span>
  <span class="token comment">// NoWork å€¼ä¸º 0</span>
  <span class="token comment">// å¦‚æœæœ‰è¿‡æœŸçš„ä»»åŠ¡ å°†è¿‡æœŸæ—¶é—´è®¾ç½®ä¸º lastExpiredTime å¦åˆ™å°†è¿‡æœŸæ—¶é—´è®¾ç½®ä¸º Sync</span>
  <span class="token comment">// åˆå§‹æ¸²æŸ“è¿‡æœŸæ—¶é—´è¢«è®¾ç½®æˆäº† Sync</span>
  <span class="token keyword">const</span> expirationTime <span class="token operator">=</span> lastExpiredTime <span class="token operator">!==</span> NoWork <span class="token operator">?</span> lastExpiredTime <span class="token operator">:</span> Sync<span class="token punctuation">;</span>

  <span class="token comment">// å¦‚æœ root å’Œ workInProgressRoot ä¸ç›¸ç­‰</span>
  <span class="token comment">// è¯´æ˜ workInProgressRoot ä¸å­˜åœ¨, è¯´æ˜è¿˜æ²¡æœ‰æ„å»º workInProgress Fiber æ ‘</span>
  <span class="token comment">// workInProgressRoot ä¸ºå…¨å±€å˜é‡ é»˜è®¤å€¼ä¸º null, åˆå§‹æ¸²æŸ“æ—¶å€¼ä¸º null</span>
  <span class="token comment">// expirationTime =&gt; 1073741823</span>
  <span class="token comment">// renderExpirationTime =&gt; 0</span>
  <span class="token comment">// true</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">!==</span> workInProgressRoot <span class="token operator">||</span> expirationTime <span class="token operator">!==</span> renderExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ„å»º workInProgressFiber æ ‘åŠrootFiber</span>
    <span class="token function">prepareFreshStack</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// workInProgress å¦‚æœä¸ä¸º null</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä»¥åŒæ­¥çš„æ–¹å¼å¼€å§‹æ„å»º Fiber å¯¹è±¡</span>
        <span class="token function">workLoopSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è·³å‡º while å¾ªç¯</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>thrownValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handleError</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> thrownValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// è¿™æ˜¯ä¸€ä¸ªåŒæ­¥æ¸²æŸ“, æ‰€ä»¥æˆ‘ä»¬åº”è¯¥å®Œæˆæ•´æ£µæ ‘.</span>
      <span class="token comment">// æ— æ³•æäº¤ä¸å®Œæ•´çš„ root, æ­¤é”™è¯¯å¯èƒ½æ˜¯ç”±äºReactä¸­çš„é”™è¯¯æ‰€è‡´. è¯·æå‡ºé—®é¢˜.</span>
      <span class="token function">invariant</span><span class="token punctuation">(</span>
        <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token string">&#39;Cannot commit an incomplete root. This error is likely caused by a &#39;</span> <span class="token operator">+</span>
          <span class="token string">&#39;bug in React. Please file an issue.&#39;</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// å°†æ„å»ºå¥½çš„æ–° Fiber å¯¹è±¡å­˜å‚¨åœ¨ finishedWork å±æ€§ä¸­</span>
      <span class="token comment">// æäº¤é˜¶æ®µä½¿ç”¨</span>
      root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>current<span class="token punctuation">.</span>alternate<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>
      root<span class="token punctuation">.</span>finishedExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
      <span class="token comment">// ç»“æŸ render é˜¶æ®µ</span>
      <span class="token comment">// è¿›å…¥ commit é˜¶æ®µ</span>
      <span class="token function">finishSyncRender</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-1-8-2-preparefreshstack" tabindex="-1"><a class="header-anchor" href="#_5-1-8-2-preparefreshstack"><span>5.1.8.2 prepareFreshStack</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">/**
 * æ ¹æ® currentFiber æ ‘ä¸­çš„ rootFiber
 * æ„å»º workInProgressFiber æ ‘ä¸­çš„ rootFiber
 */</span>
<span class="token keyword">function</span> <span class="token function">prepareFreshStack</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> expirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ä¸º FiberRoot å¯¹è±¡æ·»åŠ  finishedWork å±æ€§</span>
  <span class="token comment">// finishedWork è¡¨ç¤º render é˜¶æ®µæ‰§è¡Œå®Œæˆåæ„å»ºçš„å¾…æäº¤çš„ Fiber å¯¹è±¡</span>
  root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// åˆå§‹åŒ– finishedExpirationTime å€¼ä¸º 0</span>
  root<span class="token punctuation">.</span>finishedExpirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>

  <span class="token comment">// å»ºæ„ workInProgress Fiber æ ‘çš„ Fiber å¯¹è±¡</span>
  workInProgressRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
  <span class="token comment">// æ„å»º workInProgress Fiber æ ‘ä¸­çš„ rootFiber</span>
  workInProgress <span class="token operator">=</span> <span class="token function">createWorkInProgress</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>current<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  renderExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
  workInProgressRootExitStatus <span class="token operator">=</span> RootIncomplete<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-1-8-3-createworkinprogress" tabindex="-1"><a class="header-anchor" href="#_5-1-8-3-createworkinprogress"><span>5.1.8.3 createWorkInProgress</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiber.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">// æ„å»º workInProgress Fiber æ ‘ä¸­çš„ rootFiber</span>
<span class="token comment">// æ„å»ºå®Œæˆåä¼šæ›¿æ¢ current fiber</span>
<span class="token comment">// åˆå§‹æ¸²æŸ“ pendingProps ä¸º null</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createWorkInProgress</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">current</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span> <span class="token literal-property property">pendingProps</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token punctuation">{</span>
  <span class="token comment">// current: current Fiber ä¸­çš„ rootFiber</span>
  <span class="token comment">// è·å– current Fiber ä¸­å¯¹åº”çš„ workInProgress Fiber</span>
  <span class="token keyword">let</span> workInProgress <span class="token operator">=</span> current<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
  <span class="token comment">// å¦‚æœ workInProgress ä¸å­˜åœ¨</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ›å»º fiber å¯¹è±¡</span>
    workInProgress <span class="token operator">=</span> <span class="token function">createFiber</span><span class="token punctuation">(</span>
      current<span class="token punctuation">.</span>tag<span class="token punctuation">,</span>
      pendingProps<span class="token punctuation">,</span>
      current<span class="token punctuation">.</span>key<span class="token punctuation">,</span>
      current<span class="token punctuation">.</span>mode<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å±æ€§å¤ç”¨</span>
    workInProgress<span class="token punctuation">.</span>elementType <span class="token operator">=</span> current<span class="token punctuation">.</span>elementType<span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>type <span class="token operator">=</span> current<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> current<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
    <span class="token comment">// ä½¿ç”¨ alternate å­˜å‚¨ current</span>
    workInProgress<span class="token punctuation">.</span>alternate <span class="token operator">=</span> current<span class="token punctuation">;</span>
    <span class="token comment">// ä½¿ç”¨ alternate å­˜å‚¨ workInProgress</span>
    current<span class="token punctuation">.</span>alternate <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  workInProgress<span class="token punctuation">.</span>childExpirationTime <span class="token operator">=</span> current<span class="token punctuation">.</span>childExpirationTime<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> current<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> current<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> current<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>sibling <span class="token operator">=</span> current<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>index <span class="token operator">=</span> current<span class="token punctuation">.</span>index<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>ref <span class="token operator">=</span> current<span class="token punctuation">.</span>ref<span class="token punctuation">;</span>
	
  <span class="token comment">// è¿”å›åˆ›å»ºå¥½çš„ workInProgress Fiber å¯¹è±¡</span>
  <span class="token keyword">return</span> workInProgress<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-1-8-4-workloopsync" tabindex="-1"><a class="header-anchor" href="#_5-1-8-4-workloopsync"><span>5.1.8.4 workLoopSync</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">// ä»¥åŒæ­¥çš„æ–¹å¼æ„å»º workInProgress Fiber å¯¹è±¡</span>
<span class="token keyword">function</span> <span class="token function">workLoopSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// workInProgress æ˜¯ä¸€ä¸ª fiber å¯¹è±¡</span>
  <span class="token comment">// å®ƒçš„å€¼ä¸ä¸º null æ„å‘³ç€è¯¥ fiber å¯¹è±¡ä¸Šä»ç„¶æœ‰æ›´æ–°è¦æ‰§è¡Œ</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    workInProgress <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-1-8-5-performunitofwork" tabindex="-1"><a class="header-anchor" href="#_5-1-8-5-performunitofwork"><span>5.1.8.5 performUnitOfWork</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">unitOfWork</span><span class="token operator">:</span> Fiber</span><span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token comment">// unitOfWork =&gt; workInProgress Fiber æ ‘ä¸­çš„ rootFiber</span>
  <span class="token comment">// current =&gt; currentFiber æ ‘ä¸­çš„ rootFiber</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> unitOfWork<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
  <span class="token comment">// å­˜å‚¨ä¸‹ä¸€ä¸ªè¦æ„å»ºçš„å­çº§ Fiber å¯¹è±¡</span>
  <span class="token keyword">let</span> next<span class="token punctuation">;</span>
  <span class="token comment">// false</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfilerTimer <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>unitOfWork<span class="token punctuation">.</span>mode <span class="token operator">&amp;</span> ProfileMode<span class="token punctuation">)</span> <span class="token operator">!==</span> NoMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆå§‹æ¸²æŸ“ ä¸æ‰§è¡Œ</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// beginWork: ä»çˆ¶åˆ°å­, æ„å»º Fiber èŠ‚ç‚¹å¯¹è±¡</span>
    <span class="token comment">// è¿”å›å€¼ next ä¸ºå½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹</span>
    next <span class="token operator">=</span> <span class="token function">beginWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> unitOfWork<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ä¸ºæ—§çš„ props å±æ€§èµ‹å€¼</span>
  <span class="token comment">// æ­¤æ¬¡æ›´æ–°å pendingProps å˜ä¸º memoizedProps</span>
  unitOfWork<span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> unitOfWork<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
  <span class="token comment">// å¦‚æœå­èŠ‚ç‚¹ä¸å­˜åœ¨è¯´æ˜å½“å‰èŠ‚ç‚¹å‘ä¸‹éå†å­èŠ‚ç‚¹å·²ç»åˆ°åº•äº†</span>
  <span class="token comment">// ç»§ç»­å‘ä¸Šè¿”å› é‡åˆ°å…„å¼ŸèŠ‚ç‚¹ æ„å»ºå…„å¼ŸèŠ‚ç‚¹çš„å­ Fiber å¯¹è±¡ ç›´åˆ°è¿”å›åˆ°æ ¹ Fiber å¯¹è±¡</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä»å­åˆ°çˆ¶, æ„å»ºå…¶ä½™èŠ‚ç‚¹ Fiber å¯¹è±¡</span>
    next <span class="token operator">=</span> <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span>unitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> next<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-1-8-6-beginwork" tabindex="-1"><a class="header-anchor" href="#_5-1-8-6-beginwork"><span>5.1.8.6 beginWork</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberBeginWork.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">// ä»çˆ¶åˆ°å­, æ„å»º Fiber èŠ‚ç‚¹å¯¹è±¡</span>
<span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">current</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">workInProgress</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token literal-property property">renderExpirationTime</span><span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token comment">// NoWork å¸¸é‡ å€¼ä¸º0 æ¸…ç©ºè¿‡æœŸæ—¶é—´</span>
  workInProgress<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>
  <span class="token comment">// æ ¹æ®å½“å‰ Fiber çš„ç±»å‹å†³å®šå¦‚ä½•æ„å»ºèµ·å­çº§ Fiber å¯¹è±¡</span>
  <span class="token comment">// æ–‡ä»¶ä½ç½®: shared/ReactWorkTags.js</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 2</span>
    <span class="token comment">// å‡½æ•°å‹ç»„ä»¶åœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“ç»„ä»¶æ—¶ä½¿ç”¨</span>
    <span class="token keyword">case</span> <span class="token literal-property property">IndeterminateComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">mountIndeterminateComponent</span><span class="token punctuation">(</span>
        <span class="token comment">// æ—§ Fiber</span>
        current<span class="token punctuation">,</span>
        <span class="token comment">// æ–° Fiber</span>
        workInProgress<span class="token punctuation">,</span>
        <span class="token comment">// æ–° Fiber çš„ type å€¼ åˆå§‹æ¸²æŸ“æ—¶æ˜¯Appç»„ä»¶å‡½æ•°</span>
        workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
        <span class="token comment">// åŒæ­¥ æ•´æ•°æœ€å¤§å€¼ 1073741823</span>
        renderExpirationTime<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 0</span>
    <span class="token keyword">case</span> <span class="token literal-property property">FunctionComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> Component <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      <span class="token keyword">const</span> unresolvedProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
      <span class="token keyword">const</span> resolvedProps <span class="token operator">=</span>
        workInProgress<span class="token punctuation">.</span>elementType <span class="token operator">===</span> Component
          <span class="token operator">?</span> unresolvedProps
          <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> unresolvedProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        Component<span class="token punctuation">,</span>
        resolvedProps<span class="token punctuation">,</span>
        renderExpirationTime<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 1</span>
    <span class="token keyword">case</span> <span class="token literal-property property">ClassComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> Component <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      <span class="token keyword">const</span> unresolvedProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
      <span class="token keyword">const</span> resolvedProps <span class="token operator">=</span>
        workInProgress<span class="token punctuation">.</span>elementType <span class="token operator">===</span> Component
          <span class="token operator">?</span> unresolvedProps
          <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> unresolvedProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        Component<span class="token punctuation">,</span>
        resolvedProps<span class="token punctuation">,</span>
        renderExpirationTime<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 3</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostRoot</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updateHostRoot</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 5</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostComponent</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updateHostComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 6</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostText</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updateHostText</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ç»„ä»¶ç±»å‹æœªçŸ¥ æŠ¥é”™</span>
  <span class="token function">invariant</span><span class="token punctuation">(</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token string">&#39;Unknown unit of work tag (%s). This error is likely caused by a bug in &#39;</span> <span class="token operator">+</span>
      <span class="token string">&#39;React. Please file an issue.&#39;</span><span class="token punctuation">,</span>
    workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-1-8-7-updatehostroot" tabindex="-1"><a class="header-anchor" href="#_5-1-8-7-updatehostroot"><span>5.1.8.7 updateHostRoot</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberBeginWork.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">// HostRoot =&gt; &lt;div id=&quot;root&quot;&gt;&lt;/div&gt; å¯¹åº”çš„ Fiber å¯¹è±¡</span>
<span class="token comment">// æ‰¾å‡º HostRoot çš„å­ ReactElement å¹¶ä¸ºå…¶æ„å»º Fiber å¯¹è±¡</span>
<span class="token keyword">function</span> <span class="token function">updateHostRoot</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è·å–æ›´æ–°é˜Ÿåˆ—</span>
  <span class="token keyword">const</span> updateQueue <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
  <span class="token comment">// è·å–æ–°çš„ props å¯¹è±¡ null</span>
  <span class="token keyword">const</span> nextProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
  <span class="token comment">// è·å–ä¸Šä¸€æ¬¡æ¸²æŸ“ä½¿ç”¨çš„ state null</span>
  <span class="token keyword">const</span> prevState <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  <span class="token comment">// è·å–ä¸Šä¸€æ¬¡æ¸²æŸ“ä½¿ç”¨çš„ children null</span>
  <span class="token keyword">const</span> prevChildren <span class="token operator">=</span> prevState <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">?</span> prevState<span class="token punctuation">.</span>element <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// æµ…å¤åˆ¶æ›´æ–°é˜Ÿåˆ—, é˜²æ­¢å¼•ç”¨å±æ€§äº’ç›¸å½±å“</span>
  <span class="token comment">// workInProgress.updateQueue æµ…æ‹·è´ current.updateQueue</span>
  <span class="token function">cloneUpdateQueue</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è·å– updateQueue.payload å¹¶èµ‹å€¼åˆ° workInProgress.memoizedState</span>
  <span class="token comment">// è¦æ›´æ–°çš„å†…å®¹å°±æ˜¯ element å°±æ˜¯ rootFiber çš„å­å…ƒç´ </span>
  <span class="token function">processUpdateQueue</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> nextProps<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è·å– element æ‰€åœ¨å¯¹è±¡</span>
  <span class="token keyword">const</span> nextState <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  <span class="token comment">// ä»å¯¹è±¡ä¸­è·å– element</span>
  <span class="token keyword">const</span> nextChildren <span class="token operator">=</span> nextState<span class="token punctuation">.</span>element<span class="token punctuation">;</span>
  <span class="token comment">// è·å– fiberRoot å¯¹è±¡</span>
  <span class="token keyword">const</span> <span class="token literal-property property">root</span><span class="token operator">:</span> FiberRoot <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
  <span class="token comment">// æœåŠ¡å™¨ç«¯æ¸²æŸ“èµ° if</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>hydrate <span class="token operator">&amp;&amp;</span> <span class="token function">enterHydrationState</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¿½ç•¥</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// å®¢æˆ·ç«¯æ¸²æŸ“èµ° else</span>
    <span class="token comment">// æ„å»ºå­èŠ‚ç‚¹ fiber å¯¹è±¡</span>
    <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>
      current<span class="token punctuation">,</span>
      workInProgress<span class="token punctuation">,</span>
      nextChildren<span class="token punctuation">,</span>
      renderExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// è¿”å›å­èŠ‚ç‚¹ fiber å¯¹è±¡</span>
  <span class="token keyword">return</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-1-8-8-reconcilechildren" tabindex="-1"><a class="header-anchor" href="#_5-1-8-8-reconcilechildren"><span>5.1.8.8 reconcileChildren</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberBeginWork.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>
  <span class="token comment">// æ—§ Fiber</span>
  <span class="token literal-property property">current</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token comment">// çˆ¶çº§ Fiber</span>
  <span class="token literal-property property">workInProgress</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token comment">// å­çº§ vdom å¯¹è±¡</span>
  <span class="token literal-property property">nextChildren</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  <span class="token comment">// åˆå§‹æ¸²æŸ“ æ•´å‹æœ€å¤§å€¼ ä»£è¡¨åŒæ­¥ä»»åŠ¡</span>
  <span class="token literal-property property">renderExpirationTime</span><span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * ä¸ºä»€ä¹ˆè¦ä¼ é€’ current ?
   * å¦‚æœä¸æ˜¯åˆå§‹æ¸²æŸ“çš„æƒ…å†µ, è¦è¿›è¡Œæ–°æ—§ Fiber å¯¹æ¯”
   * åˆå§‹æ¸²æŸ“æ—¶åˆ™ç”¨ä¸åˆ° current
   */</span>
  <span class="token comment">// å¦‚æœå°± Fiber ä¸º null è¡¨ç¤ºåˆå§‹æ¸²æŸ“</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä¸ºå½“å‰æ„å»ºçš„ Fiber å¯¹è±¡æ·»åŠ å­çº§ Fiber å¯¹è±¡</span>
    workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token function">mountChildFibers</span><span class="token punctuation">(</span>
      workInProgress<span class="token punctuation">,</span>
      <span class="token keyword">null</span><span class="token punctuation">,</span>
      nextChildren<span class="token punctuation">,</span>
      renderExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å¿½ç•¥äº† else çš„æƒ…å†µ</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-1-8-9-childreconciler" tabindex="-1"><a class="header-anchor" href="#_5-1-8-9-childreconciler"><span>5.1.8.9 ChildReconciler</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactChildFiber.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">/**
 * shouldTrackSideEffects æ ‡è¯†, æ˜¯å¦ä¸º Fiber å¯¹è±¡æ·»åŠ  effectTag
 * true æ·»åŠ  false ä¸æ·»åŠ 
 * å¯¹äºåˆå§‹æ¸²æŸ“æ¥è¯´, åªæœ‰æ ¹ç»„ä»¶éœ€è¦æ·»åŠ , å…¶ä»–å…ƒç´ ä¸éœ€è¦æ·»åŠ , é˜²æ­¢è¿‡å¤šçš„ DOM æ“ä½œ
 */</span>
<span class="token comment">// ç”¨äºåˆå§‹æ¸²æŸ“</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> mountChildFibers <span class="token operator">=</span> <span class="token function">ChildReconciler</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">ChildReconciler</span><span class="token punctuation">(</span><span class="token parameter">shouldTrackSideEffects</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
  <span class="token keyword">function</span> <span class="token function">placeChild</span><span class="token punctuation">(</span>
    <span class="token parameter"><span class="token literal-property property">newFiber</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
    <span class="token literal-property property">lastPlacedIndex</span><span class="token operator">:</span> number<span class="token punctuation">,</span>
    <span class="token literal-property property">newIndex</span><span class="token operator">:</span> number<span class="token punctuation">,</span></span>
  <span class="token punctuation">)</span><span class="token operator">:</span> number <span class="token punctuation">{</span>
    newFiber<span class="token punctuation">.</span>index <span class="token operator">=</span> newIndex<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldTrackSideEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> lastPlacedIndex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å¿½ç•¥äº†ä¸€éƒ¨åˆ†åˆå§‹åŒ–æ¸²æŸ“ä¸æ‰§è¡Œçš„ä»£ç </span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">placeSingleChild</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">newFiber</span><span class="token operator">:</span> Fiber</span><span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœæ˜¯åˆå§‹æ¸²æŸ“ ä¼šåœ¨æ ¹ç»„ä»¶(App)ä¸Šè®¾ç½® effectTag å±æ€§ä¸º Placement å€¼ä¸º 1</span>
    <span class="token comment">// å…¶ä»–å­çº§èŠ‚ç‚¹å…·æœ‰é»˜è®¤å€¼ä¸º 0 é˜²æ­¢åœ¨ commit é˜¶æ®µåå¤æ“ä½œçœŸå®DOM</span>
    <span class="token comment">// åˆå§‹æ¸²æŸ“æ—¶å¦‚æœå½“å‰å¤„ç†çš„æ˜¯æ ¹ç»„ä»¶ true å…¶ä»–ç»„ä»¶ false</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldTrackSideEffects <span class="token operator">&amp;&amp;</span> newFiber<span class="token punctuation">.</span>alternate <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Placement è¡¨ç¤ºæ–°åˆ›å»ºçš„èŠ‚ç‚¹</span>
      newFiber<span class="token punctuation">.</span>effectTag <span class="token operator">=</span> Placement<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> newFiber<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// å¤„ç†å­å…ƒç´ æ˜¯æ•°ç»„çš„æƒ…å†µ</span>
  <span class="token keyword">function</span> <span class="token function">reconcileChildrenArray</span><span class="token punctuation">(</span>
    <span class="token comment">// çˆ¶çº§ Fiber</span>
    <span class="token literal-property property">returnFiber</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
    <span class="token literal-property property">currentFirstChild</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token comment">// å­çº§ vdom æ•°ç»„</span>
    <span class="token literal-property property">newChildren</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">expirationTime</span><span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * å­˜å‚¨ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ Fiber å¯¹è±¡
     * æ–¹æ³•è¿”å›çš„ä¹Ÿæ˜¯ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ Fiber å¯¹è±¡
     * å› ä¸ºå…¶ä»–å­èŠ‚ç‚¹ Fiber å¯¹è±¡éƒ½å­˜å‚¨åœ¨ä¸Šä¸€ä¸ªå­ Fiber èŠ‚ç‚¹å¯¹è±¡çš„ sibling å±æ€§ä¸­
     */</span>
    <span class="token keyword">let</span> <span class="token literal-property property">resultingFirstChild</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// ä¸Šä¸€æ¬¡åˆ›å»ºçš„ Fiber å¯¹è±¡</span>
    <span class="token keyword">let</span> <span class="token literal-property property">previousNewFiber</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆå§‹æ¸²æŸ“æ²¡æœ‰æ—§çš„å­çº§ æ‰€ä»¥ä¸º null</span>
    <span class="token keyword">let</span> oldFiber <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span>

    <span class="token keyword">let</span> lastPlacedIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> newIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> nextOldFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">// oldFiber ä¸ºç©º è¯´æ˜æ˜¯åˆå§‹æ¸²æŸ“</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// éå†å­ vdom å¯¹è±¡</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// åˆ›å»ºå­ vdom å¯¹åº”çš„ fiber å¯¹è±¡</span>
        <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">createChild</span><span class="token punctuation">(</span>
          returnFiber<span class="token punctuation">,</span>
          newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">,</span>
          expirationTime<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å¦‚æœ newFiber ä¸º null</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newFiber <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// è¿›å…¥ä¸‹æ¬¡å¾ªç¯</span>
          <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// åˆå§‹æ¸²æŸ“æ—¶åªä¸º newFiber æ·»åŠ äº† index å±æ€§,</span>
        <span class="token comment">// å…¶ä»–äº‹æ²¡å¹². lastPlacedIndex è¢«åŸå°ä¸åŠ¨çš„è¿”å›äº†</span>
        lastPlacedIndex <span class="token operator">=</span> <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> lastPlacedIndex<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ä¸ºå½“å‰èŠ‚ç‚¹è®¾ç½®ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>previousNewFiber <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// å­˜å‚¨ç¬¬ä¸€ä¸ªå­ Fiber å‘ç”Ÿåœ¨ç¬¬ä¸€æ¬¡å¾ªç¯æ—¶</span>
          resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// ä¸ºèŠ‚ç‚¹è®¾ç½®ä¸‹ä¸€ä¸ªå…„å¼Ÿ Fiber</span>
          previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// åœ¨å¾ªç¯çš„è¿‡ç¨‹ä¸­æ›´æ–°ä¸Šä¸€ä¸ªåˆ›å»ºçš„Fiber å¯¹è±¡</span>
        previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// è¿”å›åˆ›å»ºå¥½çš„å­ Fiber</span>
      <span class="token comment">// å…¶ä»– Fiber éƒ½ä½œä¸º sibling å­˜åœ¨</span>
      <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è¿”å›ç¬¬ä¸€ä¸ªå­å…ƒç´  Fiber å¯¹è±¡</span>
    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// å¤„ç†å­å…ƒç´ æ˜¯æ–‡æœ¬æˆ–è€…æ•°å€¼çš„æƒ…å†µ</span>
  <span class="token keyword">function</span> <span class="token function">reconcileSingleTextNode</span><span class="token punctuation">(</span>
    <span class="token parameter"><span class="token literal-property property">returnFiber</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
    <span class="token literal-property property">currentFirstChild</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token literal-property property">textContent</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
    <span class="token literal-property property">expirationTime</span><span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span></span>
  <span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token punctuation">{</span>
    <span class="token comment">// åˆå§‹æ¸²æŸ“ä¸æ‰§è¡Œ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFirstChild <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> currentFirstChild<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostText<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// We already have an existing node so let&#39;s just update it and delete</span>
      <span class="token comment">// the rest.</span>
      <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> existing <span class="token operator">=</span> <span class="token function">useFiber</span><span class="token punctuation">(</span>currentFirstChild<span class="token punctuation">,</span> textContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      existing<span class="token punctuation">.</span>return <span class="token operator">=</span> returnFiber<span class="token punctuation">;</span>
      <span class="token keyword">return</span> existing<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ç°æœ‰çš„ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ä¸æ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªå¹¶åˆ é™¤ç°æœ‰çš„.</span>
    <span class="token comment">// åˆå§‹æ¸²æŸ“ä¸æ‰§è¡Œ</span>
    <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ ¹æ®æ–‡æœ¬åˆ›å»º Fiber å¯¹è±¡</span>
    <span class="token keyword">const</span> created <span class="token operator">=</span> <span class="token function">createFiberFromText</span><span class="token punctuation">(</span>
      textContent<span class="token punctuation">,</span>
      returnFiber<span class="token punctuation">.</span>mode<span class="token punctuation">,</span>
      expirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è®¾ç½®çˆ¶ Fiber å¯¹è±¡</span>
    created<span class="token punctuation">.</span>return <span class="token operator">=</span> returnFiber<span class="token punctuation">;</span>
    <span class="token comment">// è¿”å›åˆ›å»ºå¥½çš„ Fiber å¯¹è±¡</span>
    <span class="token keyword">return</span> created<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å¤„ç†å­å…ƒç´ æ˜¯å•ä¸ªå¯¹è±¡çš„æƒ…å†µ</span>
  <span class="token keyword">function</span> <span class="token function">reconcileSingleElement</span><span class="token punctuation">(</span>
    <span class="token comment">// çˆ¶ Fiber å¯¹è±¡</span>
    <span class="token literal-property property">returnFiber</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
    <span class="token comment">// å¤‡ä»½å­ fiber</span>
    <span class="token literal-property property">currentFirstChild</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token comment">// å­ vdom å¯¹è±¡</span>
    <span class="token literal-property property">element</span><span class="token operator">:</span> ReactElement<span class="token punctuation">,</span>
    <span class="token literal-property property">expirationTime</span><span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token punctuation">{</span>
    <span class="token comment">// æŸ¥çœ‹å­ vdom å¯¹è±¡æ˜¯å¦è¡¨ç¤º fragment</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">REACT_FRAGMENT_TYPE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// false</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ ¹æ® React Element åˆ›å»º Fiber å¯¹è±¡</span>
      <span class="token comment">// è¿”å›åˆ›å»ºå¥½çš„ Fiber å¯¹è±¡</span>
      <span class="token keyword">const</span> created <span class="token operator">=</span> <span class="token function">createFiberFromElement</span><span class="token punctuation">(</span>
        element<span class="token punctuation">,</span>
        <span class="token comment">// ç”¨æ¥è¡¨ç¤ºå½“å‰ç»„ä»¶ä¸‹çš„æ‰€æœ‰å­ç»„ä»¶è¦ç”¨å¤„äºä½•ç§æ¸²æŸ“æ¨¡å¼</span>
        <span class="token comment">// æ–‡ä»¶ä½ç½®: ./ReactTypeOfMode.js</span>
        <span class="token comment">// 0    åŒæ­¥æ¸²æŸ“æ¨¡å¼</span>
        <span class="token comment">// 100  å¼‚æ­¥æ¸²æŸ“æ¨¡å¼</span>
        returnFiber<span class="token punctuation">.</span>mode<span class="token punctuation">,</span>
        expirationTime<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// æ·»åŠ  ref å±æ€§ { current: DOM }</span>
      created<span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token function">coerceRef</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// æ·»åŠ çˆ¶çº§ Fiber å¯¹è±¡</span>
      created<span class="token punctuation">.</span>return <span class="token operator">=</span> returnFiber<span class="token punctuation">;</span>
      <span class="token comment">// è¿”å›åˆ›å»ºå¥½çš„å­ Fiber</span>
      <span class="token keyword">return</span> created<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">reconcileChildFibers</span><span class="token punctuation">(</span>
    <span class="token comment">// çˆ¶ Fiber å¯¹è±¡</span>
    <span class="token literal-property property">returnFiber</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
    <span class="token comment">// æ—§çš„ç¬¬ä¸€ä¸ªå­ Fiber åˆå§‹æ¸²æŸ“ null</span>
    <span class="token literal-property property">currentFirstChild</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token comment">// æ–°çš„å­ vdom å¯¹è±¡</span>
    <span class="token literal-property property">newChild</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
    <span class="token comment">// åˆå§‹æ¸²æŸ“ æ•´å‹æœ€å¤§å€¼ ä»£è¡¨åŒæ­¥ä»»åŠ¡</span>
    <span class="token literal-property property">expirationTime</span><span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿™æ˜¯å…¥å£æ–¹æ³•, æ ¹æ® newChild ç±»å‹è¿›è¡Œå¯¹åº”å¤„ç†</span>

    <span class="token comment">// åˆ¤æ–­æ–°çš„å­ vdom æ˜¯å¦ä¸ºå ä½ç»„ä»¶ æ¯”å¦‚ &lt;&gt;&lt;/&gt;</span>
    <span class="token comment">// false</span>
    <span class="token keyword">const</span> isUnkeyedTopLevelFragment <span class="token operator">=</span>
      <span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">&#39;object&#39;</span> <span class="token operator">&amp;&amp;</span>
      newChild <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
      newChild<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">REACT_FRAGMENT_TYPE</span> <span class="token operator">&amp;&amp;</span>
      newChild<span class="token punctuation">.</span>key <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">// å¦‚æœ newChild ä¸ºå ä½ç¬¦, ä½¿ç”¨ å ä½ç¬¦ç»„ä»¶çš„å­å…ƒç´ ä½œä¸º newChild</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isUnkeyedTopLevelFragment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      newChild <span class="token operator">=</span> newChild<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ£€æµ‹ newChild æ˜¯å¦ä¸ºå¯¹è±¡ç±»å‹</span>
    <span class="token keyword">const</span> isObject <span class="token operator">=</span> <span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">&#39;object&#39;</span> <span class="token operator">&amp;&amp;</span> newChild <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">// newChild æ˜¯å•ä¸ªå¯¹è±¡çš„æƒ…å†µ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// åŒ¹é…å­å…ƒç´ çš„ç±»å‹</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>newChild<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å­å…ƒç´ ä¸º ReactElement</span>
        <span class="token keyword">case</span> <span class="token constant">REACT_ELEMENT_TYPE</span><span class="token operator">:</span>
          <span class="token comment">// ä¸º Fiber å¯¹è±¡è®¾ç½® effectTag å±æ€§</span>
          <span class="token comment">// è¿”å›åˆ›å»ºå¥½çš„å­ Fiber</span>
          <span class="token keyword">return</span> <span class="token function">placeSingleChild</span><span class="token punctuation">(</span>
            <span class="token comment">// å¤„ç†å•ä¸ª React Element çš„æƒ…å†µ</span>
            <span class="token comment">// å†…éƒ¨ä¼šè°ƒç”¨å…¶ä»–æ–¹æ³•åˆ›å»ºå¯¹åº”çš„ Fiber å¯¹è±¡</span>
            <span class="token function">reconcileSingleElement</span><span class="token punctuation">(</span>
              returnFiber<span class="token punctuation">,</span>
              currentFirstChild<span class="token punctuation">,</span>
              newChild<span class="token punctuation">,</span>
              expirationTime<span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
      
    <span class="token comment">// å¤„ç† children ä¸ºæ–‡æœ¬å’Œæ•°å€¼çš„æƒ…å†µ return &quot;App works&quot;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">&#39;number&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">placeSingleChild</span><span class="token punctuation">(</span>
        <span class="token function">reconcileSingleTextNode</span><span class="token punctuation">(</span>
          returnFiber<span class="token punctuation">,</span>
          currentFirstChild<span class="token punctuation">,</span>
          <span class="token comment">// å¦‚æœ newChild æ˜¯æ•°å€¼, è½¬æ¢ä¸ºå­—ç¬¦ä¸²</span>
          <span class="token string">&#39;&#39;</span> <span class="token operator">+</span> newChild<span class="token punctuation">,</span>
          expirationTime<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// children æ˜¯æ•°ç»„çš„æƒ…å†µ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>newChild<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// è¿”å›åˆ›å»ºå¥½çš„å­ Fiber</span>
      <span class="token keyword">return</span> <span class="token function">reconcileChildrenArray</span><span class="token punctuation">(</span>
        returnFiber<span class="token punctuation">,</span>
        currentFirstChild<span class="token punctuation">,</span>
        newChild<span class="token punctuation">,</span>
        expirationTime<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-1-8-10-completeunitofwork" tabindex="-1"><a class="header-anchor" href="#_5-1-8-10-completeunitofwork"><span>5.1.8.10 completeUnitOfWork</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">/**
 *
 * ä»ä¸‹è‡³ä¸Šç§»åŠ¨åˆ°è¯¥èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹, å¦‚æœä¸€ç›´å¾€ä¸Šæ²¡æœ‰å…„å¼ŸèŠ‚ç‚¹å°±è¿”å›çˆ¶èŠ‚ç‚¹, æœ€ç»ˆä¼šåˆ°è¾¾ root èŠ‚ç‚¹
 * 1. åˆ›å»ºå…¶ä»–èŠ‚ç‚¹çš„ Fiber å¯¹è±¡
 * 2. åˆ›å»ºæ¯ä¸€ä¸ªèŠ‚ç‚¹çš„çœŸå® DOM å¯¹è±¡å¹¶å°†å…¶æ·»åŠ åˆ° stateNode å±æ€§ä¸­
 * 3. æ„å»º effect é“¾è¡¨ç»“æ„
 */</span>
<span class="token keyword">function</span> <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">unitOfWork</span><span class="token operator">:</span> Fiber</span><span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token comment">// ä¸º workInProgress å…¨å±€å˜é‡é‡æ–°èµ‹å€¼</span>
  workInProgress <span class="token operator">=</span> unitOfWork<span class="token punctuation">;</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–å¤‡ä»½èŠ‚ç‚¹</span>
    <span class="token comment">// åˆå§‹åŒ–æ¸²æŸ“ éæ ¹ Fiber å¯¹è±¡æ²¡æœ‰å¤‡ä»½èŠ‚ç‚¹ æ‰€ä»¥ current ä¸º null</span>
    <span class="token keyword">const</span> current <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
    <span class="token comment">// çˆ¶çº§ Fiber å¯¹è±¡, éæ ¹ Fiber å¯¹è±¡éƒ½æœ‰çˆ¶çº§</span>
    <span class="token keyword">const</span> returnFiber <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
    <span class="token comment">// åˆ¤æ–­ä¼ å…¥çš„ Fiber å¯¹è±¡æ˜¯å¦æ„å»ºå®Œæˆ, ä»»åŠ¡è°ƒåº¦ç›¸å…³</span>
    <span class="token comment">// &amp; æ˜¯è¡¨ç¤ºä½çš„ä¸è¿ç®—, æŠŠå·¦å³ä¸¤è¾¹çš„æ•°å­—è½¬åŒ–ä¸ºäºŒè¿›åˆ¶</span>
    <span class="token comment">// ç„¶åæ¯ä¸€ä½åˆ†åˆ«è¿›è¡Œæ¯”è¾ƒ, å¦‚æœç›¸ç­‰å°±ä¸º1, ä¸ç›¸ç­‰å³ä¸º0</span>
    <span class="token comment">// æ­¤å¤„åº”ç”¨&quot;ä½ä¸&quot;è¿ç®—ç¬¦çš„ç›®çš„æ˜¯&quot;æ¸…é›¶&quot;</span>
    <span class="token comment">// true</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;</span> Incomplete<span class="token punctuation">)</span> <span class="token operator">===</span> NoEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> next<span class="token punctuation">;</span>
      <span class="token comment">// å¦‚æœä¸èƒ½ä½¿ç”¨åˆ†æå™¨çš„ timer, ç›´æ¥æ‰§è¡Œ completeWork</span>
      <span class="token comment">// enableProfilerTimer =&gt; true</span>
      <span class="token comment">// ä½†æ­¤å¤„æ— è®ºæ¡ä»¶æ˜¯å¦æˆç«‹éƒ½ä¼šæ‰§è¡Œ completeWork</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token operator">!</span>enableProfilerTimer <span class="token operator">||</span>
        <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>mode <span class="token operator">&amp;</span> ProfileMode<span class="token punctuation">)</span> <span class="token operator">===</span> NoMode
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// é‡ç‚¹ä»£ç (äºŒ)</span>
        <span class="token comment">// åˆ›å»ºèŠ‚ç‚¹çœŸå® DOM å¯¹è±¡å¹¶å°†å…¶æ·»åŠ åˆ° stateNode å±æ€§ä¸­</span>
        next <span class="token operator">=</span> <span class="token function">completeWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// åˆ›å»ºèŠ‚ç‚¹çœŸå® DOM å¯¹è±¡å¹¶å°†å…¶æ·»åŠ åˆ° stateNode å±æ€§ä¸­</span>
        next <span class="token operator">=</span> <span class="token function">completeWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// é‡ç‚¹ä»£ç (ä¸€)</span>
      <span class="token comment">// å¦‚æœå­çº§å­˜åœ¨</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è¿”å›å­çº§ ä¸€ç›´è¿”å›åˆ° workLoopSync</span>
        <span class="token comment">// å†é‡æ–°æ‰§è¡Œ performUnitOfWork æ„å»ºå­çº§ Fiber èŠ‚ç‚¹å¯¹è±¡</span>
        <span class="token keyword">return</span> next<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// æ„å»º effect é“¾è¡¨ç»“æ„</span>
      <span class="token comment">// å¦‚æœä¸æ˜¯æ ¹ Fiber å°±æ˜¯ true å¦åˆ™å°±æ˜¯ false</span>
      <span class="token comment">// å°†å­æ ‘å’Œæ­¤ Fiber çš„æ‰€æœ‰ effect é™„åŠ åˆ°çˆ¶çº§çš„ effect åˆ—è¡¨ä¸­</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token comment">// å¦‚æœçˆ¶ Fiber å­˜åœ¨ å¹¶ä¸”</span>
        returnFiber <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
        <span class="token comment">// çˆ¶ Fiber å¯¹è±¡ä¸­çš„ effectTag ä¸º 0</span>
        <span class="token punctuation">(</span>returnFiber<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;</span> Incomplete<span class="token punctuation">)</span> <span class="token operator">===</span> NoEffect
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å°†å­æ ‘å’Œæ­¤ Fiber çš„æ‰€æœ‰å‰¯ä½œç”¨é™„åŠ åˆ°çˆ¶çº§çš„ effect åˆ—è¡¨ä¸Š</span>

        <span class="token comment">// ä»¥ä¸‹ä¸¤ä¸ªåˆ¤æ–­çš„ä½œç”¨æ˜¯æœé›†å­ Fiberçš„ effect åˆ°çˆ¶ Fiber</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// first</span>
          returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>lastEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// next</span>
            returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// last</span>
          returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>lastEffect<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// è·å–å‰¯ä½œç”¨æ ‡è®°</span>
        <span class="token comment">// åˆå§‹æ¸²æŸ“æ—¶é™¤[æ ¹ç»„ä»¶]ä»¥å¤–çš„ Fiber, effectTag å€¼éƒ½ä¸º 0, å³ä¸éœ€è¦æ‰§è¡Œä»»ä½•çœŸå®DOMæ“ä½œ</span>
        <span class="token comment">// æ ¹ç»„ä»¶çš„ effectTag å€¼ä¸º 3, å³éœ€è¦å°†æ­¤èŠ‚ç‚¹å¯¹åº”çš„çœŸå®DOMå¯¹è±¡æ·»åŠ åˆ°é¡µé¢ä¸­</span>
        <span class="token keyword">const</span> effectTag <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span>

        <span class="token comment">// åˆ›å»º effect åˆ—è¡¨æ—¶è·³è¿‡ NoWork(0) å’Œ PerformedWork(1) æ ‡è®°</span>
        <span class="token comment">// PerformedWork ç”± React DevTools è¯»å–, ä¸æäº¤</span>
        <span class="token comment">// åˆå§‹æ¸²æŸ“æ—¶ åªæœ‰éå†åˆ°äº†æ ¹ç»„ä»¶ åˆ¤æ–­æ¡ä»¶æ‰èƒ½æˆç«‹, å°† effect é“¾è¡¨æ·»åŠ åˆ° rootFiber</span>
        <span class="token comment">// åˆå§‹æ¸²æŸ“ FiberRoot å¯¹è±¡ä¸­çš„ firstEffect å’Œ lastEffect éƒ½æ˜¯ App ç»„ä»¶</span>
        <span class="token comment">// å› ä¸ºå½“æ‰€æœ‰èŠ‚ç‚¹åœ¨å†…å­˜ä¸­æ„å»ºå®Œæˆå, åªéœ€è¦ä¸€æ¬¡å°†æ‰€æœ‰ DOM æ·»åŠ åˆ°é¡µé¢ä¸­</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag <span class="token operator">&gt;</span> PerformedWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// false</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// ä¸º fiberRoot æ·»åŠ  firstEffect</span>
            returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// ä¸º fiberRoot æ·»åŠ  lastEffect</span>
          returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    	<span class="token comment">// å¿½ç•¥äº†åˆå§‹æ¸²æŸ“ä¸æ‰§è¡Œçš„ä»£ç       </span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è·å–ä¸‹ä¸€ä¸ªåŒçº§ Fiber å¯¹è±¡</span>
    <span class="token keyword">const</span> siblingFiber <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœä¸‹ä¸€ä¸ªåŒçº§ Fiber å¯¹è±¡å­˜åœ¨</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>siblingFiber <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// è¿”å›ä¸‹ä¸€ä¸ªåŒçº§ Fiber å¯¹è±¡</span>
      <span class="token keyword">return</span> siblingFiber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å¦åˆ™é€€å›çˆ¶çº§</span>
    workInProgress <span class="token operator">=</span> returnFiber<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// å½“æ‰§è¡Œåˆ°è¿™é‡Œçš„æ—¶å€™, è¯´æ˜éå†åˆ°äº† root èŠ‚ç‚¹, å·²å®Œæˆéå†</span>
  <span class="token comment">// æ›´æ–° workInProgressRootExitStatus çš„çŠ¶æ€ä¸º å·²å®Œæˆ</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgressRootExitStatus <span class="token operator">===</span> RootIncomplete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    workInProgressRootExitStatus <span class="token operator">=</span> RootCompleted<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-1-8-11-completework" tabindex="-1"><a class="header-anchor" href="#_5-1-8-11-completework"><span>5.1.8.11 completeWork</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberCompleteWork.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">completeWork</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">current</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">workInProgress</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token literal-property property">renderExpirationTime</span><span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token comment">// è·å–å¾…æ›´æ–° props</span>
  <span class="token keyword">const</span> newProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 0</span>
    <span class="token keyword">case</span> <span class="token literal-property property">FunctionComponent</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 3</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostRoot</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">updateHostContainer</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 5</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// è·å– rootDOM èŠ‚ç‚¹ &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span>
      <span class="token keyword">const</span> rootContainerInstance <span class="token operator">=</span> <span class="token function">getRootHostContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// èŠ‚ç‚¹çš„å…·ä½“çš„ç±»å‹ div span ...</span>
      <span class="token keyword">const</span> type <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      <span class="token comment">// false current = null</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> workInProgress<span class="token punctuation">.</span>stateNode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// åˆå§‹æ¸²æŸ“ä¸æ‰§è¡Œ</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token comment">// false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>wasHydrated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// åˆå§‹æ¸²æŸ“ä¸æ‰§è¡Œ</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// åˆ›å»ºèŠ‚ç‚¹å®ä¾‹å¯¹è±¡ &lt;div&gt;&lt;/div&gt; &lt;span&gt;&lt;/span&gt;</span>
          <span class="token keyword">let</span> instance <span class="token operator">=</span> <span class="token function">createInstance</span><span class="token punctuation">(</span>
            type<span class="token punctuation">,</span>
            newProps<span class="token punctuation">,</span>
            rootContainerInstance<span class="token punctuation">,</span>
            currentHostContext<span class="token punctuation">,</span>
            workInProgress<span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">/**
           * å°†æ‰€æœ‰çš„å­çº§è¿½åŠ åˆ°çˆ¶çº§ä¸­
           * instance ä¸ºçˆ¶çº§
           * workInProgress.child ä¸ºå­çº§
           */</span>
          <span class="token function">appendAllChildren</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// ä¸º Fiber å¯¹è±¡æ·»åŠ  stateNode å±æ€§</span>
          workInProgress<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> instance<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// å¤„ç† ref DOM å¼•ç”¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>ref <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">markRef</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-1-8-12-appendallchildren" tabindex="-1"><a class="header-anchor" href="#_5-1-8-12-appendallchildren"><span>5.1.8.12 appendAllChildren</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberCompleteWork.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token function-variable function">appendAllChildren</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>
    <span class="token parameter"><span class="token literal-property property">parent</span><span class="token operator">:</span> Instance<span class="token punctuation">,</span>
    <span class="token literal-property property">workInProgress</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
    <span class="token literal-property property">needsVisibilityToggle</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span>
    <span class="token literal-property property">isHidden</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span></span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–å­çº§</span>
    <span class="token keyword">let</span> node <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœå­çº§ä¸ä¸ºç©º æ‰§è¡Œå¾ªç¯</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>node <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœ node æ˜¯æ™®é€š ReactElement æˆ–è€…ä¸ºæ–‡æœ¬</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostComponent <span class="token operator">||</span> node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostText<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å°†å­çº§è¿½åŠ åˆ°çˆ¶çº§ä¸­</span>
        <span class="token function">appendInitialChild</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœ node ä¸æ˜¯æ™®é€š ReactElement åˆä¸æ˜¯æ–‡æœ¬</span>
        <span class="token comment">// å°† node è§†ä¸ºç»„ä»¶, ç»„ä»¶æœ¬èº«ä¸èƒ½è½¬æ¢ä¸ºçœŸå® DOM å…ƒç´ </span>
        <span class="token comment">// è·å–åˆ°ç»„ä»¶çš„ç¬¬ä¸€ä¸ªå­å…ƒç´ , ç»§ç»­æ‰§è¡Œå¾ªç¯</span>
        node<span class="token punctuation">.</span>child<span class="token punctuation">.</span>return <span class="token operator">=</span> node<span class="token punctuation">;</span>
        node <span class="token operator">=</span> node<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// å¦‚æœ node å’Œ workInProgress æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹</span>
      <span class="token comment">// è¯´æ˜ node å·²ç»é€€å›åˆ°çˆ¶çº§ ç»ˆæ­¢å¾ªç¯</span>
      <span class="token comment">// è¯´æ˜æ­¤æ—¶æ‰€æœ‰å­çº§éƒ½å·²ç»è¿½åŠ åˆ°çˆ¶çº§ä¸­äº†</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">===</span> workInProgress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// å¤„ç†å­çº§èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>sibling <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœèŠ‚ç‚¹æ²¡æœ‰çˆ¶çº§æˆ–è€…èŠ‚ç‚¹çš„çˆ¶çº§æ˜¯è‡ªå·±, é€€å‡ºå¾ªç¯</span>
        <span class="token comment">// è¯´æ˜æ­¤æ—¶æ‰€æœ‰å­çº§éƒ½å·²ç»è¿½åŠ åˆ°çˆ¶çº§ä¸­äº†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>return <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> node<span class="token punctuation">.</span>return <span class="token operator">===</span> workInProgress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// æ›´æ–° node</span>
        node <span class="token operator">=</span> node<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// æ›´æ–°çˆ¶çº§ æ–¹ä¾¿å›é€€</span>
      node<span class="token punctuation">.</span>sibling<span class="token punctuation">.</span>return <span class="token operator">=</span> node<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
      <span class="token comment">// å°† node æ›´æ–°ä¸ºä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹</span>
      node <span class="token operator">=</span> node<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-commit-é˜¶æ®µ" tabindex="-1"><a class="header-anchor" href="#_5-2-commit-é˜¶æ®µ"><span>5.2 commit é˜¶æ®µ</span></a></h3><h4 id="_5-2-1-finishsyncrender" tabindex="-1"><a class="header-anchor" href="#_5-2-1-finishsyncrender"><span>5.2.1 finishSyncRender</span></a></h4><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">finishSyncRender</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// é”€æ¯ workInProgress Fiber æ ‘</span>
  <span class="token comment">// å› ä¸ºå¾…æäº¤ Fiber å¯¹è±¡å·²ç»è¢«å­˜å‚¨åœ¨äº† root.finishedWork ä¸­</span>
  workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// è¿›å…¥ commit é˜¶æ®µ</span>
  <span class="token function">commitRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-2-2-commitroot" tabindex="-1"><a class="header-anchor" href="#_5-2-2-commitroot"><span>5.2.2 commitRoot</span></a></h4><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è·å–ä»»åŠ¡ä¼˜å…ˆçº§ 97 =&gt; æ™®é€šä¼˜å…ˆçº§</span>
  <span class="token keyword">const</span> renderPriorityLevel <span class="token operator">=</span> <span class="token function">getCurrentPriorityLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ä½¿ç”¨æœ€é«˜ä¼˜å…ˆçº§æ‰§è¡Œå½“å‰ä»»åŠ¡, å› ä¸º commit é˜¶æ®µä¸å¯ä»¥è¢«æ‰“æ–­</span>
  <span class="token comment">// ImmediatePriority, ä¼˜å…ˆçº§ä¸º 99, æœ€é«˜ä¼˜å…ˆçº§</span>
  <span class="token function">runWithPriority</span><span class="token punctuation">(</span>
    ImmediatePriority<span class="token punctuation">,</span>
    <span class="token function">commitRootImpl</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-2-3-commitrootimpl" tabindex="-1"><a class="header-anchor" href="#_5-2-3-commitrootimpl"><span>5.2.3 commitRootImpl</span></a></h4><p>commit é˜¶æ®µå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªå­é˜¶æ®µï¼š</p><ul><li>before mutation é˜¶æ®µï¼ˆæ‰§è¡Œ DOM æ“ä½œå‰ï¼‰</li><li>mutation é˜¶æ®µï¼ˆæ‰§è¡Œ DOM æ“ä½œï¼‰</li><li>layout é˜¶æ®µï¼ˆæ‰§è¡Œ DOM æ“ä½œåï¼‰</li></ul><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">commitRootImpl</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> renderPriorityLevel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è·å–å¾…æäº¤ Fiber å¯¹è±¡ rootFiber</span>
  <span class="token keyword">const</span> finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedWork<span class="token punctuation">;</span>
  <span class="token comment">// å¦‚æœæ²¡æœ‰ä»»åŠ¡è¦æ‰§è¡Œ</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// é˜»æ­¢ç¨‹åºç»§ç»­å‘ä¸‹æ‰§è¡Œ</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// é‡ç½®ä¸ºé»˜è®¤å€¼</span>
  root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>callbackNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>callbackExpirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>callbackPriority <span class="token operator">=</span> NoPriority<span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>nextKnownPendingLevel <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>
  
  <span class="token comment">// è·å–è¦æ‰§è¡Œ DOM æ“ä½œçš„å‰¯ä½œç”¨åˆ—è¡¨</span>
  <span class="token keyword">let</span> firstEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span>

  <span class="token comment">// true</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>firstEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// commit ç¬¬ä¸€ä¸ªå­é˜¶æ®µ</span>
    nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
    <span class="token comment">// å¤„ç†ç±»ç»„ä»¶çš„ getSnapShotBeforeUpdate ç”Ÿå‘½å‘¨æœŸå‡½æ•°</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token function">invokeGuardedCallback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> commitBeforeMutationEffects<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
		<span class="token comment">// commit ç¬¬äºŒä¸ªå­é˜¶æ®µ</span>
    nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token function">invokeGuardedCallback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> commitMutationEffects<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å°† workInProgress Fiber æ ‘å˜æˆ current Fiber æ ‘</span>
    root<span class="token punctuation">.</span>current <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
    
		<span class="token comment">// commit ç¬¬ä¸‰ä¸ªå­é˜¶æ®µ</span>
    nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token function">invokeGuardedCallback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> commitLayoutEffects<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">,</span>expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
    <span class="token comment">// é‡ç½® nextEffect</span>
    nextEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-2-4-ç¬¬ä¸€å­é˜¶æ®µ" tabindex="-1"><a class="header-anchor" href="#_5-2-4-ç¬¬ä¸€å­é˜¶æ®µ"><span>5.2.4 ç¬¬ä¸€å­é˜¶æ®µ</span></a></h4><h5 id="_5-2-4-1-commitbeforemutationeffects" tabindex="-1"><a class="header-anchor" href="#_5-2-4-1-commitbeforemutationeffects"><span>5.2.4.1 commitBeforeMutationEffects</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">// commit é˜¶æ®µçš„ç¬¬ä¸€ä¸ªå­é˜¶æ®µ</span>
<span class="token comment">// è°ƒç”¨ç±»ç»„ä»¶çš„ getSnapshotBeforeUpdate ç”Ÿå‘½å‘¨æœŸå‡½æ•°</span>
<span class="token keyword">function</span> <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// å¾ªç¯ effect é“¾</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// nextEffect æ˜¯ effect é“¾ä¸Šä» firstEffect åˆ° lastEffec çš„æ¯ä¸€ä¸ªéœ€è¦commitçš„ fiber å¯¹è±¡</span>

    <span class="token comment">// åˆå§‹åŒ–æ¸²æŸ“ç¬¬ä¸€ä¸ª nextEffect ä¸º App ç»„ä»¶</span>
    <span class="token comment">// effectTag =&gt; 3</span>
    <span class="token keyword">const</span> effectTag <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span>
    <span class="token comment">// console.log(effectTag);</span>
    <span class="token comment">// nextEffect = null;</span>
    <span class="token comment">// return;</span>

    <span class="token comment">// å¦‚æœ fiber å¯¹è±¡ä¸­é‡Œæœ‰ Snapshot è¿™ä¸ª effectTag çš„è¯</span>
    <span class="token comment">// Snapshot å’Œæ›´æ–°æœ‰å…³ç³» åˆå§‹åŒ–æ¸²æŸ“ ä¸æ‰§è¡Œ</span>
    <span class="token comment">// false</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Snapshot<span class="token punctuation">)</span> <span class="token operator">!==</span> NoEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// è·å–å½“å‰ fiber èŠ‚ç‚¹</span>
      <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
      <span class="token comment">// å½“ nextEffect ä¸Šæœ‰ Snapshot è¿™ä¸ª effectTag æ—¶</span>
      <span class="token comment">// æ‰§è¡Œä»¥ä¸‹æ–¹æ³•, ä¸»è¦æ˜¯ç±»ç»„ä»¶è°ƒç”¨ getSnapshotBeforeUpdate ç”Ÿå‘½å‘¨æœŸå‡½æ•°</span>
      <span class="token function">commitBeforeMutationEffectOnFiber</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// æ›´æ–°å¾ªç¯æ¡ä»¶</span>
    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-2-4-2-commitbeforemutationlifecycles" tabindex="-1"><a class="header-anchor" href="#_5-2-4-2-commitbeforemutationlifecycles"><span>5.2.4.2 commitBeforeMutationLifeCycles</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">commitBeforeMutationLifeCycles</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">current</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">finishedWork</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token literal-property property">FunctionComponent</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">ForwardRef</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">SimpleMemoComponent</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">Block</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å¦‚æœè¯¥ fiber ç±»å‹æ˜¯ ClassComponent</span>
    <span class="token keyword">case</span> <span class="token literal-property property">ClassComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;</span> Snapshot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// æ—§çš„ props</span>
          <span class="token keyword">const</span> prevProps <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">;</span>
          <span class="token comment">// æ—§çš„ state</span>
          <span class="token keyword">const</span> prevState <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
          <span class="token comment">// è·å– classComponent ç»„ä»¶çš„å®ä¾‹å¯¹è±¡</span>
          <span class="token keyword">const</span> instance <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
          <span class="token comment">// æ‰§è¡Œ getSnapshotBeforeUpdate ç”Ÿå‘½å‘¨æœŸå‡½æ•°</span>
          <span class="token comment">// åœ¨ç»„ä»¶æ›´æ–°å‰æ•è·ä¸€äº› DOM ä¿¡æ¯</span>
          <span class="token comment">// è¿”å›è‡ªå®šä¹‰çš„å€¼æˆ– null, ç»Ÿç§°ä¸º snapshot</span>
          <span class="token keyword">const</span> snapshot <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">getSnapshotBeforeUpdate</span><span class="token punctuation">(</span>
            finishedWork<span class="token punctuation">.</span>elementType <span class="token operator">===</span> finishedWork<span class="token punctuation">.</span>type
              <span class="token operator">?</span> prevProps
              <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>type<span class="token punctuation">,</span> prevProps<span class="token punctuation">)</span><span class="token punctuation">,</span>
            prevState<span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostRoot</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostComponent</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostText</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostPortal</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">IncompleteClassComponent</span><span class="token operator">:</span>
      <span class="token comment">// Nothing to do for these component types</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-2-5-ç¬¬äºŒå­é˜¶æ®µ" tabindex="-1"><a class="header-anchor" href="#_5-2-5-ç¬¬äºŒå­é˜¶æ®µ"><span>5.2.5 ç¬¬äºŒå­é˜¶æ®µ</span></a></h4><h5 id="_5-2-5-1-commitmutationeffects" tabindex="-1"><a class="header-anchor" href="#_5-2-5-1-commitmutationeffects"><span>5.2.5.1 commitMutationEffects</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">// commit é˜¶æ®µçš„ç¬¬äºŒä¸ªå­é˜¶æ®µ</span>
<span class="token comment">// æ ¹æ® effectTag æ‰§è¡Œ DOM æ“ä½œ</span>
<span class="token keyword">function</span> <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">root</span><span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span> renderPriorityLevel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// å¾ªç¯ effect é“¾</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å– effectTag</span>
    <span class="token comment">// åˆå§‹æ¸²æŸ“ç¬¬ä¸€æ¬¡å¾ªç¯ä¸º App ç»„ä»¶</span>
    <span class="token comment">// å³å°†æ ¹ç»„ä»¶åŠå†…éƒ¨æ‰€æœ‰å†…å®¹ä¸€æ¬¡æ€§æ·»åŠ åˆ°é¡µé¢ä¸­</span>
    <span class="token keyword">const</span> effectTag <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span>

    <span class="token comment">// æ ¹æ® effectTag åˆ†åˆ«å¤„ç†</span>
    <span class="token keyword">let</span> primaryEffectTag <span class="token operator">=</span>
      effectTag <span class="token operator">&amp;</span> <span class="token punctuation">(</span>Placement <span class="token operator">|</span> Update <span class="token operator">|</span> Deletion <span class="token operator">|</span> Hydrating<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åŒ¹é… effectTag</span>
    <span class="token comment">// åˆå§‹æ¸²æŸ“ primaryEffectTag ä¸º 2 åŒ¹é…åˆ° Placement</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>primaryEffectTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// é’ˆå¯¹è¯¥èŠ‚ç‚¹åŠå­èŠ‚ç‚¹è¿›è¡Œæ’å…¥æ“ä½œ</span>
      <span class="token keyword">case</span> <span class="token literal-property property">Placement</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">commitPlacement</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// effectTag ä» 3 å˜ä¸º 1</span>
        <span class="token comment">// ä» effect æ ‡ç­¾ä¸­æ¸…é™¤ &quot;placement&quot; é‡ç½® effectTag å€¼</span>
        <span class="token comment">// ä»¥ä¾¿æˆ‘ä»¬çŸ¥é“åœ¨è°ƒç”¨è¯¸å¦‚componentDidMountä¹‹ç±»çš„ä»»ä½•ç”Ÿå‘½å‘¨æœŸä¹‹å‰å·²å°†å…¶æ’å…¥ã€‚</span>
        nextEffect<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span>Placement<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// æ’å…¥å¹¶æ›´æ–° DOM</span>
      <span class="token keyword">case</span> <span class="token literal-property property">PlacementAndUpdate</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ’å…¥</span>
        <span class="token function">commitPlacement</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        nextEffect<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span>Placement<span class="token punctuation">;</span>

        <span class="token comment">// æ›´æ–°</span>
        <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
        <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// æœåŠ¡å™¨ç«¯æ¸²æŸ“</span>
      <span class="token keyword">case</span> <span class="token literal-property property">Hydrating</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        nextEffect<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span>Hydrating<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// æœåŠ¡å™¨ç«¯æ¸²æŸ“</span>
      <span class="token keyword">case</span> <span class="token literal-property property">HydratingAndUpdate</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        nextEffect<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span>Hydrating<span class="token punctuation">;</span>

        <span class="token comment">// Update</span>
        <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
        <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// æ›´æ–° DOM</span>
      <span class="token keyword">case</span> <span class="token literal-property property">Update</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
        <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// åˆ é™¤ DOM</span>
      <span class="token keyword">case</span> <span class="token literal-property property">Deletion</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">commitDeletion</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> nextEffect<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-2-5-2-commitplacement" tabindex="-1"><a class="header-anchor" href="#_5-2-5-2-commitplacement"><span>5.2.5.2 commitPlacement</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">// æŒ‚è½½ DOM å…ƒç´ </span>
<span class="token keyword">function</span> <span class="token function">commitPlacement</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">finishedWork</span><span class="token operator">:</span> Fiber</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// finishedWork åˆå§‹åŒ–æ¸²æŸ“æ—¶ä¸ºæ ¹ç»„ä»¶ Fiber å¯¹è±¡</span>
  <span class="token comment">// è·å–éç»„ä»¶çˆ¶çº§ Fiber å¯¹è±¡</span>
  <span class="token comment">// åˆå§‹æ¸²æŸ“æ—¶ä¸º &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span>
  <span class="token keyword">const</span> parentFiber <span class="token operator">=</span> <span class="token function">getHostParentFiber</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// å­˜å‚¨çœŸæ­£çš„çˆ¶çº§ DOM èŠ‚ç‚¹å¯¹è±¡</span>
  <span class="token keyword">let</span> parent<span class="token punctuation">;</span>
  <span class="token comment">// æ˜¯å¦ä¸ºæ¸²æŸ“å®¹å™¨</span>
  <span class="token comment">// æ¸²æŸ“å®¹å™¨å’Œæ™®é€šreactå…ƒç´ çš„ä¸»è¦åŒºåˆ«åœ¨äºæ˜¯å¦éœ€è¦ç‰¹æ®Šå¤„ç†æ³¨é‡ŠèŠ‚ç‚¹</span>
  <span class="token keyword">let</span> isContainer<span class="token punctuation">;</span>
  <span class="token comment">// è·å–çˆ¶çº§ DOM èŠ‚ç‚¹å¯¹è±¡</span>
  <span class="token comment">// ä½†æ˜¯åˆå§‹æ¸²æŸ“æ—¶ rootFiber å¯¹è±¡ä¸­çš„ stateNode å­˜å‚¨çš„æ˜¯ FiberRoot</span>
  <span class="token keyword">const</span> parentStateNode <span class="token operator">=</span> parentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
  <span class="token comment">// åˆ¤æ–­çˆ¶èŠ‚ç‚¹çš„ç±»å‹</span>
  <span class="token comment">// åˆå§‹æ¸²æŸ“æ—¶æ˜¯ hostRoot 3</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>parentFiber<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostComponent</span><span class="token operator">:</span>
      parent <span class="token operator">=</span> parentStateNode<span class="token punctuation">;</span>
      isContainer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostRoot</span><span class="token operator">:</span>
      <span class="token comment">// è·å–çœŸæ­£çš„ DOM èŠ‚ç‚¹å¯¹è±¡</span>
      <span class="token comment">// &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span>
      parent <span class="token operator">=</span> parentStateNode<span class="token punctuation">.</span>containerInfo<span class="token punctuation">;</span>
      <span class="token comment">// æ˜¯ container å®¹å™¨</span>
      isContainer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostPortal</span><span class="token operator">:</span>
      parent <span class="token operator">=</span> parentStateNode<span class="token punctuation">.</span>containerInfo<span class="token punctuation">;</span>
      isContainer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token literal-property property">FundamentalComponent</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>enableFundamentalAPI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        parent <span class="token operator">=</span> parentStateNode<span class="token punctuation">.</span>instance<span class="token punctuation">;</span>
        isContainer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// æŸ¥çœ‹å½“å‰èŠ‚ç‚¹æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹</span>
  <span class="token comment">// æœ‰, æ‰§è¡Œ insertBefore</span>
  <span class="token comment">// æ²¡æœ‰, æ‰§è¡Œ appendChild</span>
  <span class="token keyword">const</span> before <span class="token operator">=</span> <span class="token function">getHostSibling</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// æ¸²æŸ“å®¹å™¨</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isContainer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å‘çˆ¶èŠ‚ç‚¹ä¸­è¿½åŠ èŠ‚ç‚¹ æˆ–è€… å°†å­èŠ‚ç‚¹æ’å…¥åˆ° before èŠ‚ç‚¹çš„å‰é¢</span>
    <span class="token function">insertOrAppendPlacementNodeIntoContainer</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// éæ¸²æŸ“å®¹å™¨</span>
    <span class="token comment">// å‘çˆ¶èŠ‚ç‚¹ä¸­è¿½åŠ èŠ‚ç‚¹ æˆ–è€… å°†å­èŠ‚ç‚¹æ’å…¥åˆ° before èŠ‚ç‚¹çš„å‰é¢</span>
    <span class="token function">insertOrAppendPlacementNode</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-2-5-3-gethostparentfiber" tabindex="-1"><a class="header-anchor" href="#_5-2-5-3-gethostparentfiber"><span>5.2.5.3 getHostParentFiber</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">// è·å– HostRootFiber å¯¹è±¡</span>
<span class="token keyword">function</span> <span class="token function">getHostParentFiber</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">fiber</span><span class="token operator">:</span> Fiber</span><span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token punctuation">{</span>
  <span class="token comment">// è·å–å½“å‰ Fiber çˆ¶çº§</span>
  <span class="token keyword">let</span> parent <span class="token operator">=</span> fiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
  <span class="token comment">// æŸ¥çœ‹çˆ¶çº§æ˜¯å¦ä¸º null</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>parent <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æŸ¥çœ‹çˆ¶çº§æ˜¯å¦ä¸º hostRoot</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isHostParent</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// è¿”å›</span>
      <span class="token keyword">return</span> parent<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ç»§ç»­å‘ä¸ŠæŸ¥æ‰¾</span>
    parent <span class="token operator">=</span> parent<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-2-5-4-insertorappendplacementnodeintocontainer" tabindex="-1"><a class="header-anchor" href="#_5-2-5-4-insertorappendplacementnodeintocontainer"><span>5.2.5.4 insertOrAppendPlacementNodeIntoContainer</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">// å‘å®¹å™¨ä¸­è¿½åŠ  | æ’å…¥åˆ°æŸä¸€ä¸ªèŠ‚ç‚¹çš„å‰é¢</span>
<span class="token keyword">function</span> <span class="token function">insertOrAppendPlacementNodeIntoContainer</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">node</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token literal-property property">before</span><span class="token operator">:</span> <span class="token operator">?</span>Instance<span class="token punctuation">,</span>
  <span class="token literal-property property">parent</span><span class="token operator">:</span> Container<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>tag<span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">;</span>
  <span class="token comment">// å¦‚æœå¾…æ’å…¥çš„èŠ‚ç‚¹æ˜¯ä¸€ä¸ª DOM å…ƒç´ æˆ–è€…æ–‡æœ¬çš„è¯</span>
  <span class="token comment">// æ¯”å¦‚ ç»„ä»¶fiber =&gt; false div =&gt; true</span>
  <span class="token keyword">const</span> isHost <span class="token operator">=</span> tag <span class="token operator">===</span> HostComponent <span class="token operator">||</span> tag <span class="token operator">===</span> HostText<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isHost <span class="token operator">||</span> <span class="token punctuation">(</span>enableFundamentalAPI <span class="token operator">&amp;&amp;</span> tag <span class="token operator">===</span> FundamentalComponent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å– DOM èŠ‚ç‚¹</span>
    <span class="token keyword">const</span> stateNode <span class="token operator">=</span> isHost <span class="token operator">?</span> node<span class="token punctuation">.</span>stateNode <span class="token operator">:</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>instance<span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœ before å­˜åœ¨</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ’å…¥åˆ° before å‰é¢</span>
      <span class="token function">insertInContainerBefore</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> stateNode<span class="token punctuation">,</span> before<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// è¿½åŠ åˆ°çˆ¶å®¹å™¨ä¸­</span>
      <span class="token function">appendChildToContainer</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœæ˜¯ç»„ä»¶èŠ‚ç‚¹, æ¯”å¦‚ ClassComponent, åˆ™æ‰¾å®ƒçš„ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹(DOM å…ƒç´ )</span>
    <span class="token comment">// è¿›è¡Œæ’å…¥æ“ä½œ</span>
    <span class="token keyword">const</span> child <span class="token operator">=</span> node<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å‘çˆ¶çº§ä¸­è¿½åŠ å­èŠ‚ç‚¹æˆ–è€…å°†å­èŠ‚ç‚¹æ’å…¥åˆ° before çš„å‰é¢</span>
      <span class="token function">insertOrAppendPlacementNodeIntoContainer</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// è·å–ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹</span>
      <span class="token keyword">let</span> sibling <span class="token operator">=</span> child<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
      <span class="token comment">// å¦‚æœå…„å¼ŸèŠ‚ç‚¹å­˜åœ¨</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>sibling <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å‘çˆ¶çº§ä¸­è¿½åŠ å­èŠ‚ç‚¹æˆ–è€…å°†å­èŠ‚ç‚¹æ’å…¥åˆ° before çš„å‰é¢</span>
        <span class="token function">insertOrAppendPlacementNodeIntoContainer</span><span class="token punctuation">(</span>sibling<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åŒæ­¥å…„å¼ŸèŠ‚ç‚¹</span>
        sibling <span class="token operator">=</span> sibling<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-2-5-5-insertincontainerbefore" tabindex="-1"><a class="header-anchor" href="#_5-2-5-5-insertincontainerbefore"><span>5.2.5.5 insertInContainerBefore</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-dom/src/client/ReactDOMHostConfig.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">insertInContainerBefore</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">container</span><span class="token operator">:</span> Container<span class="token punctuation">,</span>
  <span class="token literal-property property">child</span><span class="token operator">:</span> Instance <span class="token operator">|</span> TextInstance<span class="token punctuation">,</span>
  <span class="token literal-property property">beforeChild</span><span class="token operator">:</span> Instance <span class="token operator">|</span> TextInstance <span class="token operator">|</span> SuspenseInstance<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// å¦‚æœçˆ¶å®¹å™¨æ˜¯æ³¨é‡ŠèŠ‚ç‚¹</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token constant">COMMENT_NODE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ‰¾åˆ°æ³¨é‡ŠèŠ‚ç‚¹çš„çˆ¶çº§èŠ‚ç‚¹ å› ä¸ºæ³¨é‡ŠèŠ‚ç‚¹æ²¡æ³•è°ƒç”¨ insertBefore</span>
    <span class="token punctuation">(</span>container<span class="token punctuation">.</span>parentNode<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> beforeChild<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°† child æ’å…¥åˆ° beforeChild çš„å‰é¢</span>
    container<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> beforeChild<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-2-5-6-appendchildtocontainer" tabindex="-1"><a class="header-anchor" href="#_5-2-5-6-appendchildtocontainer"><span>5.2.5.6 appendChildToContainer</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-dom/src/client/ReactDOMHostConfig.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">appendChildToContainer</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">container</span><span class="token operator">:</span> Container<span class="token punctuation">,</span>
  <span class="token literal-property property">child</span><span class="token operator">:</span> Instance <span class="token operator">|</span> TextInstance<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// ç›‘æµ‹ container æ˜¯å¦æ³¨é‡ŠèŠ‚ç‚¹</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token constant">COMMENT_NODE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–çˆ¶çº§çš„çˆ¶çº§</span>
    parentNode <span class="token operator">=</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>parentNode<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å°†å­çº§èŠ‚ç‚¹æ’å…¥åˆ°æ³¨é‡ŠèŠ‚ç‚¹çš„å‰é¢</span>
    parentNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç›´æ¥å°† child æ’å…¥åˆ°çˆ¶çº§ä¸­</span>
    parentNode <span class="token operator">=</span> container<span class="token punctuation">;</span>
    parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-2-6-ç¬¬ä¸‰å­é˜¶æ®µ" tabindex="-1"><a class="header-anchor" href="#_5-2-6-ç¬¬ä¸‰å­é˜¶æ®µ"><span>5.2.6 ç¬¬ä¸‰å­é˜¶æ®µ</span></a></h4><h5 id="_5-2-6-1-commitlayouteffects" tabindex="-1"><a class="header-anchor" href="#_5-2-6-1-commitlayouteffects"><span>5.2.6.1 commitLayoutEffects</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberWorkLoop.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">// commit é˜¶æ®µçš„ç¬¬ä¸‰ä¸ªå­é˜¶æ®µ</span>
<span class="token keyword">function</span> <span class="token function">commitLayoutEffects</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">root</span><span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span>
  <span class="token literal-property property">committedExpirationTime</span><span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ­¤æ—¶ effectTag å·²ç»è¢«é‡ç½®ä¸º 1, è¡¨ç¤º DOM æ“ä½œå·²ç»å®Œæˆ</span>
    <span class="token keyword">const</span> effectTag <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span>
    <span class="token comment">// è°ƒç”¨ç”Ÿå‘½å‘¨æœŸå‡½æ•°å’Œé’©å­å‡½æ•°</span>
    <span class="token comment">// å‰ææ˜¯ç±»ç»„ä»¶ä¸­è°ƒç”¨äº†ç”Ÿå‘½å‘¨æœŸå‡½æ•° æˆ–è€…å‡½æ•°ç»„ä»¶ä¸­è°ƒç”¨äº† useEffect</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> <span class="token punctuation">(</span>Update <span class="token operator">|</span> Callback<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ç±»ç»„ä»¶å¤„ç†ç”Ÿå‘½å‘¨æœŸå‡½æ•°</span>
      <span class="token comment">// å‡½æ•°ç»„ä»¶å¤„ç†é’©å­å‡½æ•°</span>
      <span class="token function">commitLayoutEffectOnFiber</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> current<span class="token punctuation">,</span>nextEffect<span class="token punctuation">,</span> committedExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// æ›´æ–°å¾ªç¯æ¡ä»¶</span>
    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-2-6-2-commitlifecycles" tabindex="-1"><a class="header-anchor" href="#_5-2-6-2-commitlifecycles"><span>5.2.6.2 commitLifeCycles</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">commitLifeCycles</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">finishedRoot</span><span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span>
  <span class="token literal-property property">current</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">finishedWork</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token literal-property property">committedExpirationTime</span><span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token literal-property property">FunctionComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¤„ç†é’©å­å‡½æ•°</span>
      <span class="token function">commitHookEffectListMount</span><span class="token punctuation">(</span>HookLayout <span class="token operator">|</span> HookHasEffect<span class="token punctuation">,</span> finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token literal-property property">ClassComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// è·å–ç±»ç»„ä»¶å®ä¾‹å¯¹è±¡</span>
      <span class="token keyword">const</span> instance <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
      <span class="token comment">// å¦‚æœåœ¨ç±»ç»„ä»¶ä¸­å­˜åœ¨ç”Ÿå‘½å‘¨æœŸå‡½æ•°åˆ¤æ–­æ¡ä»¶å°±ä¼šæˆç«‹</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;</span> Update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// åˆå§‹æ¸²æŸ“é˜¶æ®µ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// è°ƒç”¨ componentDidMount ç”Ÿå‘½å‘¨æœŸå‡½æ•°</span>
          instance<span class="token punctuation">.</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// æ›´æ–°é˜¶æ®µ</span>
          <span class="token comment">// è·å–æ—§çš„ props</span>
          <span class="token keyword">const</span> prevProps <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>elementType <span class="token operator">===</span> finishedWork<span class="token punctuation">.</span>type
              <span class="token operator">?</span> current<span class="token punctuation">.</span>memoizedProps
              <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>type<span class="token punctuation">,</span> current<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// è·å–æ—§çš„ state</span>
          <span class="token keyword">const</span> prevState <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
          <span class="token comment">// è°ƒç”¨ componentDidUpdate ç”Ÿå‘½å‘¨æœŸå‡½æ•°</span>
          <span class="token comment">// instance.__reactInternalSnapshotBeforeUpdate å¿«ç…§ getSnapShotBeforeUpdate æ–¹æ³•çš„è¿”å›å€¼</span>
          instance<span class="token punctuation">.</span><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">,</span> instance<span class="token punctuation">.</span>__reactInternalSnapshotBeforeUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// è·å–ä»»åŠ¡é˜Ÿåˆ—</span>
      <span class="token keyword">const</span> updateQueue <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
      <span class="token comment">// å¦‚æœä»»åŠ¡é˜Ÿåˆ—å­˜åœ¨</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>updateQueue <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/**
         * è°ƒç”¨ ReactElement æ¸²æŸ“å®Œæˆä¹‹åçš„å›è°ƒå‡½æ•°
         * å³ render æ–¹æ³•çš„ç¬¬ä¸‰ä¸ªå‚æ•°
         */</span>
        <span class="token function">commitUpdateQueue</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> updateQueue<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-2-6-3-commitupdatequeue" tabindex="-1"><a class="header-anchor" href="#_5-2-6-3-commitupdatequeue"><span>5.2.6.3 commitUpdateQueue</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactUpdateQueue.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">/**
 * æ‰§è¡Œæ¸²æŸ“å®Œæˆä¹‹åçš„å›è°ƒå‡½æ•°
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> commitUpdateQueue<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">State</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">(
  finishedWork: Fiber,
  finishedQueue: UpdateQueue</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">State</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">,
  instance: any,
): void </span><span class="token punctuation">{</span>
  <span class="token comment">// effects ä¸ºæ•°ç»„, å­˜å‚¨ä»»åŠ¡å¯¹è±¡ (Update å¯¹è±¡)</span>
  <span class="token comment">// ä½†å‰ææ˜¯åœ¨è°ƒç”¨ render æ–¹æ³•æ—¶ä¼ é€’äº†å›è°ƒå‡½æ•°, å°±æ˜¯ render æ–¹æ³•çš„ç¬¬ä¸‰ä¸ªå‚æ•°</span>
  <span class="token keyword">const</span> effects <span class="token operator">=</span> finishedQueue<span class="token punctuation">.</span>effects<span class="token punctuation">;</span>
  <span class="token comment">// é‡ç½® finishedQueue.effects æ•°ç»„</span>
  finishedQueue<span class="token punctuation">.</span>effects <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// å¦‚æœä¼ é€’äº† render æ–¹æ³•çš„ç¬¬ä¸‰ä¸ªå‚æ•°, effect æ•°ç»„å°±ä¸ä¼šä¸º null</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>effects <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// éå† effect æ•°ç»„</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> effects<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// è·å–æ•°ç»„ä¸­çš„ç¬¬ i ä¸ªéœ€è¦æ‰§è¡Œçš„ effect</span>
      <span class="token keyword">const</span> effect <span class="token operator">=</span> effects<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// è·å– callback å›è°ƒå‡½æ•°</span>
      <span class="token keyword">const</span> callback <span class="token operator">=</span> effect<span class="token punctuation">.</span>callback<span class="token punctuation">;</span>
      <span class="token comment">// å¦‚æœå›è°ƒå‡½æ•°ä¸ä¸º null</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ¸…ç©º effect ä¸­çš„ callback</span>
        effect<span class="token punctuation">.</span>callback <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// æ‰§è¡Œå›è°ƒå‡½æ•°</span>
        <span class="token function">callCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token plain-text">
</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-2-6-4-commithookeffectlistmount" tabindex="-1"><a class="header-anchor" href="#_5-2-6-4-commithookeffectlistmount"><span>5.2.6.4 commitHookEffectListMount</span></a></h5><p><code>æ–‡ä»¶ä½ç½®: packages/react-reconciler/src/ReactFiberCommitWork.js</code></p><div class="language-jsx line-numbers-mode" data-ext="jsx" data-title="jsx"><pre class="language-jsx"><code><span class="token comment">/**
 * useEffect å›è°ƒå‡½æ•°è°ƒç”¨
 */</span>
<span class="token keyword">function</span> <span class="token function">commitHookEffectListMount</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">tag</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token literal-property property">finishedWork</span><span class="token operator">:</span> Fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è·å–ä»»åŠ¡é˜Ÿåˆ—</span>
  <span class="token keyword">const</span> <span class="token literal-property property">updateQueue</span><span class="token operator">:</span> FunctionComponentUpdateQueue <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>updateQueue<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è·å– lastEffect</span>
  <span class="token keyword">let</span> lastEffect <span class="token operator">=</span> updateQueue <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">?</span> updateQueue<span class="token punctuation">.</span>lastEffect <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// å¦‚æœ lastEffect ä¸ä¸º null</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>lastEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–è¦æ‰§è¡Œçš„å‰¯ä½œç”¨</span>
    <span class="token keyword">const</span> firstEffect <span class="token operator">=</span> lastEffect<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token keyword">let</span> effect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
    <span class="token comment">// é€šè¿‡éå†çš„æ–¹å¼è°ƒç”¨ useEffect ä¸­çš„å›è°ƒå‡½æ•°</span>
    <span class="token comment">// åœ¨ç»„ä»¶ä¸­å®šä¹‰äº†è°ƒç”¨äº†å‡ æ¬¡ useEffect éå†å°±ä¼šæ‰§è¡Œå‡ æ¬¡</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>tag <span class="token operator">&amp;</span> tag<span class="token punctuation">)</span> <span class="token operator">===</span> tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Mount</span>
        <span class="token keyword">const</span> create <span class="token operator">=</span> effect<span class="token punctuation">.</span>create<span class="token punctuation">;</span>
        <span class="token comment">// create å°±æ˜¯ useEffect æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°</span>
        <span class="token comment">// è¿”å›å€¼å°±æ˜¯æ¸…ç†å‡½æ•°</span>
        effect<span class="token punctuation">.</span>destroy <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// æ›´æ–°å¾ªç¯æ¡ä»¶</span>
      effect <span class="token operator">=</span> effect<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>effect <span class="token operator">!==</span> firstEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><!----><!--]--><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/AriseMarcher/blog/edit/main/src/frame/React/04-core-source-code.md" rel="noopener noreferrer" target="_blank" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: 2543061999@qq.com">arisemarcher</span><!--]--><!--]--></div></div></footer><!----><!----><!--[--><!----><!--]--><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">æ¯å¤©è¿›æ­¥äº¿ç‚¹ç‚¹</div><!----></footer></div><!--]--><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/blog/assets/app-CZ5YT_Cp.js" defer></script>
  </body>
</html>
